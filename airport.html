<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airport Transportation | Travylway</title>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCS4tdVM1N3vNcls32CzoasWfturMLGB_s&libraries=places"></script>
<style>
:root{
  --bg:#2B3A4A; --card:#fff; --text:#0F172A; --muted:#64748B; --line:#E2E8F0;
  --okbg:#ECFDF5; --okbd:#BBF7D0; --oktx:#166534;
  --erbg:#FFF1F2; --erbd:#FECDD3; --ertx:#9F1239;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.6;
}
.hero{
  background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);
  color:#fff;padding:3rem 1.5rem;text-align:center;
}
.hero h1{font-size:2.5rem;font-weight:700;margin-bottom:0.5rem;}
.hero p{font-size:1.1rem;opacity:0.95;}
.back-link{
  display:inline-block;color:#fff;text-decoration:none;font-weight:500;
  padding:0.5rem 1rem;background:rgba(255,255,255,0.2);border-radius:6px;
  margin-bottom:1rem;transition:background 0.2s;
}
.back-link:hover{background:rgba(255,255,255,0.3);}
.container{max-width:900px;margin:2rem auto;padding:0 1.5rem;}
.card{
  background:var(--card);border-radius:12px;padding:2rem;
  box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:2rem;
}
.card h2{color:#1e3a8a;font-size:1.8rem;margin-bottom:1.5rem;border-bottom:3px solid #3b82f6;padding-bottom:0.5rem;}
.group{margin-bottom:1.5rem;}
.group label{display:block;font-weight:600;color:var(--text);margin-bottom:0.5rem;}
.group input,.group select,.group textarea{
  width:100%;padding:0.75rem;border:2px solid var(--line);border-radius:8px;
  font-size:1rem;transition:border 0.2s;background:#fff;
}
.group input:focus,.group select:focus,.group textarea:focus{
  outline:none;border-color:#3b82f6;
}
.group input:disabled,.group select:disabled{
  background:#f3f4f6;cursor:not-allowed;color:#6b7280;
}
.req{color:#dc2626;margin-left:0.25rem;}
.timezone{color:#3b82f6;font-size:0.9rem;margin-top:0.25rem;display:block;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
@media(max-width:768px){.row{grid-template-columns:1fr;}}
.btn{
  background:linear-gradient(135deg,#1e3a8a,#3b82f6);
  color:#fff;padding:1rem 2rem;border:none;border-radius:8px;
  font-size:1.1rem;font-weight:600;cursor:pointer;width:100%;
  transition:transform 0.2s,box-shadow 0.2s;
}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.15);}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
.msg{
  padding:1rem;border-radius:8px;margin-bottom:1rem;
  border-left:4px solid;display:none;
}
.msg.ok{background:var(--okbg);border-color:var(--okbd);color:var(--oktx);}
.msg.err{background:var(--erbg);border-color:var(--erbd);color:var(--ertx);}
#calculator{background:#f0f9ff;padding:1.5rem;border-radius:8px;border:2px solid #3b82f6;}
#calculator h3{color:#1e3a8a;margin-bottom:1rem;}
.calc-row{display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #ddd;}
.calc-row:last-child{border-bottom:none;font-weight:700;font-size:1.2rem;color:#1e3a8a;margin-top:0.5rem;padding-top:1rem;border-top:2px solid #3b82f6;}
.waiting-notice{
  background:#fef3c7;padding:1rem;border-radius:6px;margin-top:1rem;
  border-left:4px solid #f59e0b;
}
.waiting-notice p{margin:0;color:#92400e;line-height:1.6;}
.waiting-notice strong{color:#92400e;}
.waiting-notice a{color:#3b82f6;text-decoration:underline;}
.whatsapp-box{
  background:#d1fae5;border:2px solid #10b981;border-radius:8px;padding:1.5rem;margin-top:1.5rem;
}
.whatsapp-box h3{color:#065f46;margin-bottom:0.5rem;}
.whatsapp-box p{color:#065f46;margin-bottom:1rem;}
.whatsapp-link{
  display:inline-block;background:#10b981;color:#fff;padding:0.75rem 1.5rem;
  border-radius:8px;text-decoration:none;font-weight:600;
}
.whatsapp-link:hover{background:#059669;}
small{display:block;color:var(--muted);margin-top:0.25rem;font-size:0.9rem;}
</style>
</head>
<body>

<div class="hero">
  <a href="/" class="back-link">‚Üê Home</a>
  <h1>‚úàÔ∏è Airport Transportation</h1>
  <p>Reliable rides between your home and the airport</p>
</div>

<div class="container">
  <div class="card">
    <h2>Book Your Airport Ride</h2>
    <div id="msgBox" class="msg"></div>
    
    <form id="airportForm">
      <!-- Personal Information -->
      <div class="group">
        <label>Full Name <span class="req">*</span></label>
        <input type="text" id="name" required placeholder="John Smith">
      </div>

      <div class="group">
        <label>Phone Number <span class="req">*</span></label>
        <input type="tel" id="phone" required placeholder="(720) 555-1234">
      </div>

      <div class="group">
        <label>Email Address</label>
        <input type="email" id="email" placeholder="john@example.com">
      </div>

      <!-- Service Type -->
      <div class="group">
        <label>Service Type <span class="req">*</span></label>
        <select id="direction" required>
          <option value="">-- Select Service --</option>
          <option value="TO_AIRPORT">To Airport (Drop-off at Airport)</option>
          <option value="FROM_AIRPORT">From Airport (Pick-up from Airport)</option>
        </select>
        <small>Choose whether you're going to or coming from the airport</small>
      </div>

      <!-- Airport Selection -->
      <div class="group">
        <label>Airport <span class="req">*</span></label>
        <select id="airportCode" required>
          <option value="">-- Select Airport --</option>
          <option value="DEN">DEN - Denver International Airport</option>
          <option value="APA">APA - Centennial Airport</option>
          <option value="BJC">BJC - Rocky Mountain Metropolitan Airport</option>
        </select>
      </div>

      <!-- Flight Information -->
      <div class="row">
        <div class="group">
          <label>Airline</label>
          <input type="text" id="airline" placeholder="United Airlines">
        </div>
        <div class="group">
          <label>Flight Number</label>
          <input type="text" id="flightNumber" placeholder="UA1234">
        </div>
      </div>

      <!-- Addresses (Smart Auto-fill) -->
      <div class="group">
        <label>Pickup Address <span class="req">*</span></label>
        <input type="text" id="pickupAddress" required placeholder="Where should we pick you up?">
        <small id="pickupHint">Select service type and airport first</small>
      </div>

      <div class="group">
        <label>Drop-off Address <span class="req">*</span></label>
        <input type="text" id="dropoffAddress" required placeholder="Where are you going?">
        <small id="dropoffHint">Select service type and airport first</small>
      </div>

      <!-- Date & Time -->
      <div class="row">
        <div class="group">
          <label>Pickup Date <span class="req">*</span></label>
          <input type="date" id="pickupDate" required>
        </div>
        <div class="group">
          <label>Pickup Time <span class="req">*</span></label>
          <input type="time" id="pickupTime" required>
          <span class="timezone">üïê Mountain Time (Denver/Aurora)</span>
        </div>
      </div>

      <!-- Special Requests -->
      <div class="group">
        <label>Special Requests or Notes</label>
        <textarea id="notes" rows="3" placeholder="Any special requirements? (wheelchair accessible, extra luggage, car seat, etc.)"></textarea>
      </div>

      <!-- Fare Calculator -->
      <div id="calculator">
        <h3>üí∞ Fare Estimate</h3>
        <div class="calc-row">
          <span>Base Fare:</span>
          <span id="baseFare">$4.89</span>
        </div>
        <div class="calc-row">
          <span>Distance:</span>
          <span id="distanceFare">Enter addresses to calculate</span>
        </div>
        <div class="calc-row">
          <span><strong>Subtotal (Base + Distance):</strong></span>
          <span id="totalFare">$4.89</span>
        </div>
        
        <!-- Waiting Time Notice -->
        <div class="waiting-notice">
          <p style="margin:0 0 0.5rem 0;font-weight:600;font-size:1.05rem;">
            ‚è±Ô∏è Waiting Time Charges May Apply
          </p>
          <p style="margin:0;font-size:0.95rem;">
            <strong>Rate:</strong> $0.60 per minute ($0.01/second)<br>
            <strong>Departure pickups:</strong> 1-minute grace period<br>
            <strong>Arrival pickups:</strong> 20-minute grace period<br>
            <br>
            Final charges will include any waiting time that exceeds grace periods. 
            See our <a href="/waiting-time-policy.html" target="_blank">Waiting Time Policy</a> for complete details.
          </p>
        </div>
      </div>

      <!-- WhatsApp Backup -->
      <div class="whatsapp-box">
        <h3>üì± WhatsApp Backup Link</h3>
        <p>Send your ride details directly via WhatsApp:</p>
        <a href="#" id="whatsappLink" class="whatsapp-link" target="_blank">Send via WhatsApp</a>
        <small style="color:#065f46;">Updates automatically as you fill out the form</small>
      </div>

      <!-- Terms Acceptance -->
      <div class="group" style="margin-top:1.5rem;">
        <label style="display:flex; align-items:start; gap:8px;">
          <input type="checkbox" id="agreeTerms" required style="width:auto; margin-top:4px;">
          <span>I agree to the <a href="/terms.html" target="_blank" style="color:#3b82f6; text-decoration:underline;">Terms of Service</a> and <a href="/privacy.html" target="_blank" style="color:#3b82f6; text-decoration:underline;">Privacy Policy</a> <span class="req">*</span></span>
        </label>
      </div>

      <!-- Turnstile -->
      <div class="group">
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAAABenterpryzes" 
             data-callback="onTurnstileVerified"
             data-theme="light">
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn" id="submitBtn" disabled>
        Submit Ride Request
      </button>
    </form>
  </div>
</div>

<script>
// Airport coordinates
const AIRPORTS = {
  'DEN': { 
    name: 'Denver International Airport', 
    address: 'Denver International Airport, Denver, CO 80249',
    lat: 39.8561, 
    lng: -104.6737 
  },
  'APA': { 
    name: 'Centennial Airport', 
    address: 'Centennial Airport, Englewood, CO 80112',
    lat: 39.5701, 
    lng: -104.8492 
  },
  'BJC': { 
    name: 'Rocky Mountain Metropolitan Airport', 
    address: 'Rocky Mountain Metropolitan Airport, Broomfield, CO 80021',
    lat: 39.9088, 
    lng: -105.1170 
  }
};

// Pricing constants
const BASE_FARE = 4.89;
const PRICE_PER_MILE = 1.50;
const WAITING_TIME_PER_SECOND = 0.01;
const WAITING_TIME_PER_MINUTE = 0.60;

// Global variables
let pickupAutocomplete, dropoffAutocomplete;
let directionsService, distanceMatrixService;
let turnstileVerified = false;

// Initialize Google Maps services
function initMap() {
  directionsService = new google.maps.DirectionsService();
  distanceMatrixService = new google.maps.DistanceMatrixService();
  
  // Initialize autocomplete for both fields
  pickupAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById('pickupAddress'),
    { types: ['address'], componentRestrictions: { country: 'us' } }
  );
  
  dropoffAutocomplete = new google.maps.places.Autocomplete(
    document.getElementById('dropoffAddress'),
    { types: ['address'], componentRestrictions: { country: 'us' } }
  );
  
  // Listen for place changes
  pickupAutocomplete.addListener('place_changed', calculateFare);
  dropoffAutocomplete.addListener('place_changed', calculateFare);
}

// Handle service type and airport selection
document.getElementById('direction').addEventListener('change', updateAddressFields);
document.getElementById('airportCode').addEventListener('change', updateAddressFields);

function updateAddressFields() {
  const direction = document.getElementById('direction').value;
  const airportCode = document.getElementById('airportCode').value;
  
  const pickupField = document.getElementById('pickupAddress');
  const dropoffField = document.getElementById('dropoffAddress');
  const pickupHint = document.getElementById('pickupHint');
  const dropoffHint = document.getElementById('dropoffHint');
  
  if (!direction || !airportCode) {
    // Reset if incomplete
    pickupField.disabled = false;
    dropoffField.disabled = false;
    pickupField.value = '';
    dropoffField.value = '';
    pickupHint.textContent = 'Select service type and airport first';
    dropoffHint.textContent = 'Select service type and airport first';
    return;
  }
  
  const airport = AIRPORTS[airportCode];
  
  if (direction === 'TO_AIRPORT') {
    // Going TO airport: user enters pickup, dropoff is airport
    pickupField.disabled = false;
    pickupField.value = '';
    pickupField.placeholder = 'Enter your home/residence address';
    pickupHint.textContent = 'Enter the address where we should pick you up';
    
    dropoffField.disabled = true;
    dropoffField.value = airport.address;
    dropoffHint.textContent = '‚úàÔ∏è Locked to selected airport';
    
  } else if (direction === 'FROM_AIRPORT') {
    // Coming FROM airport: pickup is airport, user enters dropoff
    pickupField.disabled = true;
    pickupField.value = airport.address;
    pickupHint.textContent = '‚úàÔ∏è Locked to selected airport';
    
    dropoffField.disabled = false;
    dropoffField.value = '';
    dropoffField.placeholder = 'Enter your home/residence address';
    dropoffHint.textContent = 'Enter the address where we should drop you off';
  }
  
  // Recalculate fare
  calculateFare();
  updateWhatsApp();
}

// Calculate fare using Google Distance Matrix API
function calculateFare() {
  const pickupAddr = document.getElementById('pickupAddress').value;
  const dropoffAddr = document.getElementById('dropoffAddress').value;
  
  if (!pickupAddr || !dropoffAddr) {
    document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
    document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
    return;
  }
  
  distanceMatrixService.getDistanceMatrix({
    origins: [pickupAddr],
    destinations: [dropoffAddr],
    travelMode: 'DRIVING',
    unitSystem: google.maps.UnitSystem.IMPERIAL
  }, (response, status) => {
    if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
      const distanceMeters = response.rows[0].elements[0].distance.value;
      const distanceMiles = (distanceMeters / 1609.34).toFixed(1);
      const distanceCost = distanceMiles * PRICE_PER_MILE;
      const totalFare = BASE_FARE + distanceCost;
      
      document.getElementById('distanceFare').textContent = 
        `${distanceMiles} miles √ó $${PRICE_PER_MILE.toFixed(2)} = $${distanceCost.toFixed(2)}`;
      document.getElementById('totalFare').textContent = `$${totalFare.toFixed(2)}`;
    } else {
      document.getElementById('distanceFare').textContent = 'Unable to calculate distance';
      document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
    }
    
    updateWhatsApp();
  });
}

// Format date/time for Mountain Time display
function formatMountainTime(dateStr, timeStr) {
  if (!dateStr || !timeStr) return '';
  const dt = new Date(`${dateStr}T${timeStr}`);
  return dt.toLocaleString('en-US', {
    timeZone: 'America/Denver',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  }) + ' MT';
}

// Update WhatsApp link
function updateWhatsApp() {
  const name = document.getElementById('name').value || '[Name]';
  const direction = document.getElementById('direction').value;
  const airportCode = document.getElementById('airportCode').value;
  const airline = document.getElementById('airline').value || 'N/A';
  const flightNumber = document.getElementById('flightNumber').value || 'N/A';
  const pickupAddr = document.getElementById('pickupAddress').value || '[Pickup Address]';
  const dropoffAddr = document.getElementById('dropoffAddress').value || '[Dropoff Address]';
  const pickupDate = document.getElementById('pickupDate').value;
  const pickupTime = document.getElementById('pickupTime').value;
  const notes = document.getElementById('notes').value || 'None';
  
  const serviceType = direction === 'TO_AIRPORT' ? 'To Airport' : 
                      direction === 'FROM_AIRPORT' ? 'From Airport' : 'N/A';
  const airportName = airportCode ? AIRPORTS[airportCode].name : 'N/A';
  const pickupTimeDisplay = formatMountainTime(pickupDate, pickupTime) || 'Not set';
  
  const totalFare = document.getElementById('totalFare').textContent;
  
  const message = `üöñ AIRPORT RIDE REQUEST

Name: ${name}
Service: ${serviceType}
Airport: ${airportName}

Airline: ${airline}
Flight: ${flightNumber}

üìç Pickup: ${pickupAddr}
üìç Dropoff: ${dropoffAddr}
‚è∞ When: ${pickupTimeDisplay}

üí¨ Notes: ${notes}

üí∞ Estimated Fare: ${totalFare}
(Plus any waiting time charges)

Please confirm availability!`;
  
  const whatsappLink = `https://wa.me/17204748851?text=${encodeURIComponent(message)}`;
  document.getElementById('whatsappLink').href = whatsappLink;
}

// Listen for form field changes
document.querySelectorAll('input, select, textarea').forEach(field => {
  field.addEventListener('input', updateWhatsApp);
  field.addEventListener('change', updateWhatsApp);
});

// Turnstile callback
function onTurnstileVerified(token) {
  turnstileVerified = true;
  document.getElementById('submitBtn').disabled = false;
}

// Show message
function showMsg(text, type) {
  const msgBox = document.getElementById('msgBox');
  msgBox.textContent = text;
  msgBox.className = `msg ${type}`;
  msgBox.style.display = 'block';
  msgBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Form submission
document.getElementById('airportForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!turnstileVerified) {
    showMsg('Please complete the security verification', 'err');
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  // Collect form data
  const pickupDate = document.getElementById('pickupDate').value;
  const pickupTime = document.getElementById('pickupTime').value;
  const pickupDateTime = new Date(`${pickupDate}T${pickupTime}`);
  const pickupTimeUTC = pickupDateTime.toISOString();
  const pickupTimeLocal = `${pickupDate}T${pickupTime}`;
  const pickupTimeDisplay = formatMountainTime(pickupDate, pickupTime);
  
  const formData = {
    'cf-turnstile-response': turnstile.getResponse(),
    created_by: document.getElementById('name').value,
    rider_phone: document.getElementById('phone').value,
    rider_email: document.getElementById('email').value || null,
    rider_type: 'GENERAL',
    trip_type: 'AIRPORT',
    direction: document.getElementById('direction').value,
    airport_code: document.getElementById('airportCode').value,
    airline: document.getElementById('airline').value || null,
    flight_number: document.getElementById('flightNumber').value || null,
    pickup_text: document.getElementById('pickupAddress').value,
    dropoff_text: document.getElementById('dropoffAddress').value,
    pickup_time_utc: pickupTimeUTC,
    pickup_time_local: pickupTimeLocal,
    pickup_time_display: pickupTimeDisplay,
    notes: document.getElementById('notes').value || null
  };
  
  try {
    const response = await fetch('https://travylway-api.benterpryzes2084.workers.dev/api/trips', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showMsg('‚úÖ Your ride request has been submitted! We\'ll contact you shortly via WhatsApp to confirm.', 'ok');
      document.getElementById('airportForm').reset();
      turnstileVerified = false;
      document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
      document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
    } else {
      showMsg(`‚ùå Error: ${result.error || 'Failed to submit request. Please try again.'}`, 'err');
    }
  } catch (error) {
    showMsg('‚ùå Network error. Please check your connection and try again.', 'err');
    console.error('Submission error:', error);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Ride Request';
  }
});

// Initialize on load
window.addEventListener('load', () => {
  initMap();
  updateWhatsApp();
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('pickupDate').min = today;
});
</script>

</body>
</html>

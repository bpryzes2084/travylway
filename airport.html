<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Transportation - TravylWay</title>
    
    <!-- Your existing CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Cloudflare Turnstile -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    
    <!-- Google Maps with YOUR FRONTEND KEY -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_FRONTEND_KEY_HERE&libraries=places&loading=async" async defer></script>
</head>
<body>
    <!-- Your existing header/nav -->
    <header>
        <nav>
            <!-- Your navigation -->
        </nav>
    </header>

    <main>
        <section class="booking-section">
            <h1>Airport Transportation</h1>
            <p>Reliable rides to and from the airport</p>
            
            <form id="bookingForm">
                <!-- Service Type Selection -->
                <div class="form-group">
                    <label for="serviceType">Service Type:</label>
                    <select id="serviceType" name="serviceType" required>
                        <option value="TO_AIRPORT">To Airport</option>
                        <option value="FROM_AIRPORT">From Airport</option>
                    </select>
                </div>

                <!-- Pickup Address -->
                <div class="form-group">
                    <label for="pickupAddress">Pickup Address:</label>
                    <input 
                        type="text" 
                        id="pickupAddress" 
                        name="pickupAddress" 
                        placeholder="Enter pickup address"
                        required
                        autocomplete="off">
                </div>

                <!-- Dropoff Address -->
                <div class="form-group">
                    <label for="dropoffAddress">Dropoff Address:</label>
                    <input 
                        type="text" 
                        id="dropoffAddress" 
                        name="dropoffAddress" 
                        placeholder="Enter dropoff address"
                        required
                        autocomplete="off">
                </div>

                <!-- Passenger Name -->
                <div class="form-group">
                    <label for="passengerName">Your Name:</label>
                    <input 
                        type="text" 
                        id="passengerName" 
                        name="passengerName" 
                        placeholder="Full name"
                        required>
                </div>

                <!-- Phone Number -->
                <div class="form-group">
                    <label for="phoneNumber">Phone Number:</label>
                    <input 
                        type="tel" 
                        id="phoneNumber" 
                        name="phoneNumber" 
                        placeholder="+1 (555) 123-4567"
                        required>
                </div>

                <!-- Pickup Date -->
                <div class="form-group">
                    <label for="pickupDate">Pickup Date:</label>
                    <input 
                        type="date" 
                        id="pickupDate" 
                        name="pickupDate" 
                        required>
                </div>

                <!-- Pickup Time -->
                <div class="form-group">
                    <label for="pickupTime">Pickup Time:</label>
                    <input 
                        type="time" 
                        id="pickupTime" 
                        name="pickupTime" 
                        required>
                    <small>Enter time in your local timezone</small>
                </div>

                <!-- Flight Number (Optional) -->
                <div class="form-group">
                    <label for="flightNumber">Flight Number (Optional):</label>
                    <input 
                        type="text" 
                        id="flightNumber" 
                        name="flightNumber" 
                        placeholder="e.g., UA1234">
                </div>

                <!-- Airline (Optional) -->
                <div class="form-group">
                    <label for="airline">Airline (Optional):</label>
                    <input 
                        type="text" 
                        id="airline" 
                        name="airline" 
                        placeholder="e.g., United Airlines">
                </div>

                <!-- Notes -->
                <div class="form-group">
                    <label for="notes">Additional Notes:</label>
                    <textarea 
                        id="notes" 
                        name="notes" 
                        rows="3"
                        placeholder="Any special requests or instructions..."></textarea>
                </div>

                <!-- Fare Display -->
                <div class="fare-summary">
                    <h3>Estimated Fare</h3>
                    <div class="fare-breakdown">
                        <div class="fare-line">
                            <span>Base Fare:</span>
                            <span>$4.89</span>
                        </div>
                        <div class="fare-line">
                            <span id="distanceFare">Enter addresses to calculate</span>
                        </div>
                        <div class="fare-line total">
                            <strong>Total:</strong>
                            <strong id="totalFare">$4.89</strong>
                        </div>
                    </div>
                    <p class="fare-note">Driver receives 75% of fare. Final fare calculated after route confirmation.</p>
                </div>

                <!-- Turnstile -->
                <div class="form-group">
                    <div class="cf-turnstile" 
                         data-sitekey="YOUR_TURNSTILE_SITE_KEY_HERE" 
                         data-callback="onTurnstileSuccess"></div>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" disabled>Request Ride</button>
                
                <div id="statusMessage"></div>
            </form>
        </section>
    </main>

    <!-- Your existing footer -->
    <footer>
        <!-- Your footer content -->
    </footer>

    <script>
        let pickupAutocomplete, dropoffAutocomplete;
        let turnstileToken = null;
        
        // Turnstile callback
        function onTurnstileSuccess(token) {
            turnstileToken = token;
            document.getElementById('submitBtn').disabled = false;
            console.log('‚úÖ Turnstile verified');
        }
        
        // Initialize Google Maps Autocomplete
        function initAutocomplete() {
            const pickupInput = document.getElementById('pickupAddress');
            const dropoffInput = document.getElementById('dropoffAddress');
            
            if (!pickupInput || !dropoffInput) {
                console.error('‚ùå Address input fields not found');
                return;
            }
            
            // Clear any existing placeholder values
            if (pickupInput.value === '!!!' || pickupInput.value === '') {
                pickupInput.value = '';
            }
            if (dropoffInput.value === '!!!' || dropoffInput.value === '') {
                dropoffInput.value = '';
            }
            
            // Prevent exclamation marks from appearing
            pickupInput.addEventListener('input', function(e) {
                if (this.value === '!!!') {
                    this.value = '';
                }
            });
            
            dropoffInput.addEventListener('input', function(e) {
                if (this.value === '!!!') {
                    this.value = '';
                }
            });
            
            try {
                // Initialize autocomplete
                pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, {
                    fields: ['formatted_address', 'geometry', 'name']
                });
                
                dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput, {
                    fields: ['formatted_address', 'geometry', 'name']
                });
                
                // Clear placeholder after initialization
                setTimeout(() => {
                    if (pickupInput.value === '!!!') pickupInput.value = '';
                    if (dropoffInput.value === '!!!') dropoffInput.value = '';
                }, 50);
                
                // Add place_changed listeners
                pickupAutocomplete.addListener('place_changed', () => {
                    const place = pickupAutocomplete.getPlace();
                    if (place.formatted_address) {
                        pickupInput.value = place.formatted_address;
                        calculateFare();
                    }
                });
                
                dropoffAutocomplete.addListener('place_changed', () => {
                    const place = dropoffAutocomplete.getPlace();
                    if (place.formatted_address) {
                        dropoffInput.value = place.formatted_address;
                        calculateFare();
                    }
                });
                
                console.log('‚úÖ Autocomplete initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing autocomplete:', error);
            }
        }
        
        // Calculate fare using proxy
        async function calculateFare() {
            const pickupAddr = document.getElementById('pickupAddress').value;
            const dropoffAddr = document.getElementById('dropoffAddress').value;
            
            // Validate addresses
            if (!pickupAddr || !dropoffAddr || pickupAddr === '!!!' || dropoffAddr === '!!!') {
                document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
                document.getElementById('totalFare').textContent = '$4.89';
                return;
            }
            
            try {
                // Call proxy with AIRPORT pricing
                const proxyUrl = `https://travylway-api.benterpryzes2084.workers.dev/api/maps-distance?origins=${encodeURIComponent(pickupAddr)}&destinations=${encodeURIComponent(dropoffAddr)}&mode=driving&units=imperial&rider_type=AIRPORT`;
                
                console.log('üìç Calculating fare:', pickupAddr, '‚Üí', dropoffAddr);
                
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.status === 'OK' && data.fare) {
                    // Display fare: $4.89 base + $1.50/mile
                    document.getElementById('distanceFare').textContent = 
                        `${data.distance.miles.toFixed(1)} miles √ó $${data.fare.perMile.toFixed(2)} = $${data.fare.distanceCost.toFixed(2)}`;
                    document.getElementById('totalFare').textContent = `$${data.fare.total.toFixed(2)}`;
                    
                    console.log('‚úÖ Fare calculated:', {
                        distance: data.distance.miles.toFixed(1) + ' miles',
                        base: '$' + data.fare.baseFare,
                        perMile: '$' + data.fare.perMile,
                        total: '$' + data.fare.total
                    });
                } else {
                    console.error('‚ùå Failed to calculate fare:', data);
                    document.getElementById('distanceFare').textContent = 'Unable to calculate distance';
                    document.getElementById('totalFare').textContent = '$4.89';
                }
            } catch (error) {
                console.error('‚ùå Distance calculation error:', error);
                document.getElementById('distanceFare').textContent = 'Error calculating distance';
                document.getElementById('totalFare').textContent = '$4.89';
            }
        }
        
        // Handle form submission
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!turnstileToken) {
                alert('Please complete the security verification');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const statusMessage = document.getElementById('statusMessage');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            statusMessage.textContent = '';
            
            // Get timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            // Build trip data
            const tripData = {
                'cf-turnstile-response': turnstileToken,
                created_by: document.getElementById('passengerName').value,
                rider_phone: document.getElementById('phoneNumber').value,
                pickup_text: document.getElementById('pickupAddress').value,
                dropoff_text: document.getElementById('dropoffAddress').value,
                pickup_date: document.getElementById('pickupDate').value,
                pickup_time_local: document.getElementById('pickupTime').value,
                pickup_timezone: timezone,
                direction: document.getElementById('serviceType').value,
                flight_number: document.getElementById('flightNumber').value || null,
                airline: document.getElementById('airline').value || null,
                notes: document.getElementById('notes').value || null,
                trip_type: 'AIRPORT',
                rider_type: 'GENERAL'
            };
            
            console.log('üì§ Submitting trip:', tripData);
            
            try {
                const response = await fetch('https://travylway-api.benterpryzes2084.workers.dev/api/trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tripData)
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    console.log('‚úÖ Trip created:', result);
                    statusMessage.style.color = 'green';
                    statusMessage.textContent = '‚úÖ Ride request submitted successfully! You will receive confirmation shortly.';
                    
                    // Reset form
                    document.getElementById('bookingForm').reset();
                    document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
                    document.getElementById('totalFare').textContent = '$4.89';
                    turnstileToken = null;
                    
                    // Reset Turnstile
                    if (typeof turnstile !== 'undefined') {
                        turnstile.reset();
                    }
                } else {
                    console.error('‚ùå Trip submission failed:', result);
                    statusMessage.style.color = 'red';
                    statusMessage.textContent = '‚ùå Error: ' + (result.error || 'Failed to submit request');
                }
            } catch (error) {
                console.error('‚ùå Submission error:', error);
                statusMessage.style.color = 'red';
                statusMessage.textContent = '‚ùå Network error. Please try again.';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Request Ride';
            }
        });
        
        // Wait for Google Maps to load
        function waitForGoogleMaps() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                console.log('‚úÖ Google Maps loaded');
                initAutocomplete();
            } else {
                console.log('‚è≥ Waiting for Google Maps...');
                setTimeout(waitForGoogleMaps, 100);
            }
        }
        
        // Start initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForGoogleMaps);
        } else {
            waitForGoogleMaps();
        }
        
        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('pickupDate').setAttribute('min', today);
    </script>
</body>
</html>

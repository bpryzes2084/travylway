<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Airport Transportation | Travylway</title>
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo_s&libraries=places"></script>
<style>
:root{
  --bg:#2B3A4A; --card:#fff; --text:#0F172A; --muted:#64748B; --line:#E2E8F0;
  --okbg:#ECFDF5; --okbd:#BBF7D0; --oktx:#166534;
  --erbg:#FFF1F2; --erbd:#FECDD3; --ertx:#9F1239;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.6;
}
.hero{
  background:linear-gradient(135deg,#1e3a8a 0%,#3b82f6 100%);
  color:#fff;padding:3rem 1.5rem;text-align:center;
}
.hero h1{font-size:2.5rem;font-weight:700;margin-bottom:0.5rem;}
.hero p{font-size:1.1rem;opacity:0.95;}
.back-link{
  display:inline-block;color:#fff;text-decoration:none;font-weight:500;
  padding:0.5rem 1rem;background:rgba(255,255,255,0.2);border-radius:6px;
  margin-bottom:1rem;transition:background 0.2s;
}
.back-link:hover{background:rgba(255,255,255,0.3);}
.container{max-width:900px;margin:2rem auto;padding:0 1.5rem;}
.card{
  background:var(--card);border-radius:12px;padding:2rem;
  box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:2rem;
}
.card h2{color:#1e3a8a;font-size:1.8rem;margin-bottom:1.5rem;border-bottom:3px solid #3b82f6;padding-bottom:0.5rem;}
.group{margin-bottom:1.5rem;}
.group label{display:block;font-weight:600;color:var(--text);margin-bottom:0.5rem;}
.group input,.group select,.group textarea{
  width:100%;padding:0.75rem;border:2px solid var(--line);border-radius:8px;
  font-size:1rem;transition:border 0.2s;background:#fff;
}
.group input:focus,.group select:focus,.group textarea:focus{
  outline:none;border-color:#3b82f6;
}
.group input:disabled,.group select:disabled{
  background:#f3f4f6;cursor:not-allowed;color:#6b7280;
}
.req{color:#dc2626;margin-left:0.25rem;}
.timezone{color:#3b82f6;font-size:0.9rem;margin-top:0.25rem;display:block;}
.row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
@media(max-width:768px){.row{grid-template-columns:1fr;}}
.btn{
  background:linear-gradient(135deg,#1e3a8a,#3b82f6);
  color:#fff;padding:1rem 2rem;border:none;border-radius:8px;
  font-size:1.1rem;font-weight:600;cursor:pointer;width:100%;
  transition:transform 0.2s,box-shadow 0.2s;
}
.btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,0.15);}
.btn:disabled{opacity:0.6;cursor:not-allowed;transform:none;}
.msg{
  padding:1rem;border-radius:8px;margin-bottom:1rem;
  border-left:4px solid;display:none;
}
.msg.ok{background:var(--okbg);border-color:var(--okbd);color:var(--oktx);}
.msg.err{background:var(--erbg);border-color:var(--erbd);color:var(--ertx);}
#calculator{background:#f0f9ff;padding:1.5rem;border-radius:8px;border:2px solid #3b82f6;}
#calculator h3{color:#1e3a8a;margin-bottom:1rem;}
.calc-row{display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #ddd;}
.calc-row:last-child{border-bottom:none;font-weight:700;font-size:1.2rem;color:#1e3a8a;margin-top:0.5rem;padding-top:1rem;border-top:2px solid #3b82f6;}
.whatsapp-box{
  background:#d1fae5;border:2px solid #10b981;border-radius:8px;padding:1.5rem;margin-top:1.5rem;
}
.whatsapp-box h3{color:#065f46;margin-bottom:0.5rem;}
.whatsapp-box p{color:#065f46;margin-bottom:1rem;}
.whatsapp-link{
  display:inline-block;background:#10b981;color:#fff;padding:0.75rem 1.5rem;
  border-radius:8px;text-decoration:none;font-weight:600;
}
.whatsapp-link:hover{background:#059669;}
small{display:block;color:var(--muted);margin-top:0.25rem;font-size:0.9rem;}
</style>
</head>
<body>

<div class="hero">
  <a href="/" class="back-link">‚Üê Home</a>
  <h1>‚úàÔ∏è Airport Transportation</h1>
  <p>Reliable rides between your location and any airport</p>
</div>

<div class="container">
  <div class="card">
    <h2>Book Your Airport Ride</h2>
    <div id="msgBox" class="msg"></div>
    
    <form id="airportForm">
      <!-- Personal Information -->
      <div class="group">
        <label>Full Name <span class="req">*</span></label>
        <input type="text" id="name" required placeholder="John Smith">
      </div>

      <div class="group">
        <label>Phone Number <span class="req">*</span></label>
        <input type="tel" id="phone" required placeholder="(720) 555-1234">
      </div>

      <div class="group">
        <label>Email Address</label>
        <input type="email" id="email" placeholder="john@example.com">
      </div>

      <!-- Service Type -->
      <div class="group">
        <label>Service Type <span class="req">*</span></label>
        <select id="direction" required>
          <option value="">-- Select Service --</option>
          <option value="TO_AIRPORT">To Airport (Drop-off at Airport)</option>
          <option value="FROM_AIRPORT">From Airport (Pick-up from Airport)</option>
        </select>
        <small>Choose whether you're going to or coming from the airport</small>
      </div>

      <!-- Flight Information -->
      <div class="row">
        <div class="group">
          <label>Airline</label>
          <input type="text" id="airline" placeholder="United Airlines">
        </div>
        <div class="group">
          <label>Flight Number</label>
          <input type="text" id="flightNumber" placeholder="UA1234">
        </div>
      </div>

      <!-- Addresses -->
      <div class="group">
        <label>Pickup Address <span class="req">*</span></label>
        <input type="text" id="pickupAddress" required placeholder="Where should we pick you up?">
        <small id="pickupHint">Select service type first</small>
      </div>

      <div class="group">
        <label>Drop-off Address <span class="req">*</span></label>
        <input type="text" id="dropoffAddress" required placeholder="Where are you going?">
        <small id="dropoffHint">Select service type first</small>
      </div>

      <!-- Date & Time -->
      <div class="row">
        <div class="group">
          <label>Pickup Date <span class="req">*</span></label>
          <input type="date" id="pickupDate" required>
        </div>
        <div class="group">
          <label>Pickup Time <span class="req">*</span></label>
          <input type="time" id="pickupTime" required>
          <span class="timezone">üïê Enter time in your local timezone</span>
        </div>
      </div>

      <!-- Special Requests -->
      <div class="group">
        <label>Special Requests or Notes</label>
        <textarea id="notes" rows="3" placeholder="Any special requirements? (wheelchair accessible, extra luggage, car seat, etc.)"></textarea>
      </div>

      <!-- Fare Calculator -->
      <div id="calculator">
        <h3>üí∞ Fare Estimate</h3>
        <div class="calc-row">
          <span>Base Fare:</span>
          <span id="baseFare">$4.89</span>
        </div>
        <div class="calc-row">
          <span>Distance:</span>
          <span id="distanceFare">Enter addresses to calculate</span>
        </div>
        <div class="calc-row">
          <span><strong>Estimated Total:</strong></span>
          <span id="totalFare">$4.89</span>
        </div>
      </div>

      <!-- WhatsApp Backup -->
      <div class="whatsapp-box">
        <h3>üì± WhatsApp Backup Link</h3>
        <p>Send your ride details directly via WhatsApp:</p>
        <a href="#" id="whatsappLink" class="whatsapp-link" target="_blank">Send via WhatsApp</a>
        <small style="color:#065f46;">Updates automatically as you fill out the form</small>
      </div>

      <!-- Terms Acceptance -->
      <div class="group" style="margin-top:1.5rem;">
        <label style="display:flex; align-items:start; gap:8px;">
          <input type="checkbox" id="agreeTerms" required style="width:auto; margin-top:4px;">
          <span>I agree to the <a href="/terms.html" target="_blank" style="color:#3b82f6; text-decoration:underline;">Terms of Service</a> and <a href="/privacy.html" target="_blank" style="color:#3b82f6; text-decoration:underline;">Privacy Policy</a> <span class="req">*</span></span>
        </label>
      </div>

      <!-- Turnstile -->
      <div class="group">
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAAABenterpryzes" 
             data-callback="onTurnstileVerified"
             data-theme="light">
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="btn" id="submitBtn" disabled>
        Submit Ride Request
      </button>
    </form>
  </div>
</div>

<script>
// Pricing constants
const BASE_FARE = 4.89;
const PRICE_PER_MILE = 1.50;

// Global variables
let pickupAutocomplete, dropoffAutocomplete;
let distanceMatrixService;
let turnstileVerified = false;

// Initialize Google Maps services
function initMap() {
  distanceMatrixService = new google.maps.DistanceMatrixService();
  
  // Wait a bit before initializing autocomplete
  setTimeout(() => {
    const pickupInput = document.getElementById('pickupAddress');
    const dropoffInput = document.getElementById('dropoffAddress');
    
    if (pickupInput) {
      pickupAutocomplete = new google.maps.places.Autocomplete(
        pickupInput,
        { types: ['address'] }
      );
      pickupAutocomplete.addListener('place_changed', () => {
        calculateFare();
        updateWhatsApp();
      });
    }
    
    if (dropoffInput) {
      dropoffAutocomplete = new google.maps.places.Autocomplete(
        dropoffInput,
        { types: ['address'] }
      );
      dropoffAutocomplete.addListener('place_changed', () => {
        calculateFare();
        updateWhatsApp();
      });
    }
  }, 100);
}

// Handle service type selection
document.getElementById('direction').addEventListener('change', updateAddressFields);

function updateAddressFields() {
  const direction = document.getElementById('direction').value;
  
  const pickupField = document.getElementById('pickupAddress');
  const dropoffField = document.getElementById('dropoffAddress');
  const pickupHint = document.getElementById('pickupHint');
  const dropoffHint = document.getElementById('dropoffHint');
  
  if (!direction) {
    pickupField.placeholder = 'Where should we pick you up?';
    dropoffField.placeholder = 'Where are you going?';
    pickupHint.textContent = 'Select service type first';
    dropoffHint.textContent = 'Select service type first';
    return;
  }
  
  if (direction === 'TO_AIRPORT') {
    // Going TO airport: user enters both addresses
    pickupField.placeholder = 'Enter your home or business address';
    pickupHint.textContent = 'Enter the address where we should pick you up';
    
    dropoffField.placeholder = 'Enter airport name or address';
    dropoffHint.textContent = 'Enter the destination airport';
    
  } else if (direction === 'FROM_AIRPORT') {
    // Coming FROM airport: user enters both addresses
    pickupField.placeholder = 'Enter airport name or address';
    pickupHint.textContent = 'Enter the airport where we should pick you up';
    
    dropoffField.placeholder = 'Enter your home or business address';
    dropoffHint.textContent = 'Enter the address where we should drop you off';
  }
  
  updateWhatsApp();
}

// Validate that one address is airport and one is residential/business
function validateAddresses() {
  const pickupAddr = document.getElementById('pickupAddress').value.toLowerCase();
  const dropoffAddr = document.getElementById('dropoffAddress').value.toLowerCase();
  
  if (!pickupAddr || !dropoffAddr) {
    return { valid: false, error: 'Please enter both pickup and drop-off addresses.' };
  }
  
  // Airport keywords for detection
  const airportKeywords = [
    'airport', 'international', 'regional', 'airfield', 'aerodrome',
    'terminal', 'concourse', 'aviation'
  ];
  
  // Check if address contains airport keywords
  function isAirport(address) {
    return airportKeywords.some(keyword => address.includes(keyword));
  }
  
  const pickupIsAirport = isAirport(pickupAddr);
  const dropoffIsAirport = isAirport(dropoffAddr);
  
  // CRITICAL VALIDATION: Both addresses are airports
  if (pickupIsAirport && dropoffIsAirport) {
    return {
      valid: false,
      error: 'Both addresses cannot be airports. One address must be your home or business location.'
    };
  }
  
  // CRITICAL VALIDATION: Neither address is an airport
  if (!pickupIsAirport && !dropoffIsAirport) {
    return {
      valid: false,
      error: 'One address must be an airport. This service is for airport transportation only (home ‚Üî airport).'
    };
  }
  
  // Validate direction matches addresses
  const direction = document.getElementById('direction').value;
  
  if (direction === 'TO_AIRPORT' && !dropoffIsAirport) {
    return {
      valid: false,
      error: 'You selected "To Airport" but the drop-off address does not appear to be an airport. Please verify your addresses.'
    };
  }
  
  if (direction === 'FROM_AIRPORT' && !pickupIsAirport) {
    return {
      valid: false,
      error: 'You selected "From Airport" but the pickup address does not appear to be an airport. Please verify your addresses.'
    };
  }
  
  return { valid: true };
}

// Calculate fare using Google Distance Matrix API
function calculateFare() {
  const pickupAddr = document.getElementById('pickupAddress').value;
  const dropoffAddr = document.getElementById('dropoffAddress').value;
  
  if (!pickupAddr || !dropoffAddr) {
    document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
    document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
    return;
  }
  
  distanceMatrixService.getDistanceMatrix({
    origins: [pickupAddr],
    destinations: [dropoffAddr],
    travelMode: 'DRIVING',
    unitSystem: google.maps.UnitSystem.IMPERIAL
  }, (response, status) => {
    if (status === 'OK' && response.rows[0].elements[0].status === 'OK') {
      const distanceMeters = response.rows[0].elements[0].distance.value;
      const distanceMiles = (distanceMeters / 1609.34).toFixed(1);
      const distanceCost = distanceMiles * PRICE_PER_MILE;
      const totalFare = BASE_FARE + distanceCost;
      
      document.getElementById('distanceFare').textContent = 
        `${distanceMiles} miles √ó $${PRICE_PER_MILE.toFixed(2)} = $${distanceCost.toFixed(2)}`;
      document.getElementById('totalFare').textContent = `$${totalFare.toFixed(2)}`;
    } else {
      document.getElementById('distanceFare').textContent = 'Unable to calculate distance';
      document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
    }
    
    updateWhatsApp();
  });
}

// Format date/time for display
function formatDateTime(dateStr, timeStr) {
  if (!dateStr || !timeStr) return '';
  const dt = new Date(`${dateStr}T${timeStr}`);
  return dt.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  });
}

// Update WhatsApp link
function updateWhatsApp() {
  const name = document.getElementById('name').value || '[Name]';
  const direction = document.getElementById('direction').value;
  const airline = document.getElementById('airline').value || 'N/A';
  const flightNumber = document.getElementById('flightNumber').value || 'N/A';
  const pickupAddr = document.getElementById('pickupAddress').value || '[Pickup Address]';
  const dropoffAddr = document.getElementById('dropoffAddress').value || '[Dropoff Address]';
  const pickupDate = document.getElementById('pickupDate').value;
  const pickupTime = document.getElementById('pickupTime').value;
  const notes = document.getElementById('notes').value || 'None';
  
  const serviceType = direction === 'TO_AIRPORT' ? 'To Airport' : 
                      direction === 'FROM_AIRPORT' ? 'From Airport' : 'N/A';
  const pickupTimeDisplay = formatDateTime(pickupDate, pickupTime) || 'Not set';
  
  const totalFare = document.getElementById('totalFare').textContent;
  
  const message = `üöñ AIRPORT RIDE REQUEST

Name: ${name}
Service: ${serviceType}

Airline: ${airline}
Flight: ${flightNumber}

üìç Pickup: ${pickupAddr}
üìç Dropoff: ${dropoffAddr}
‚è∞ When: ${pickupTimeDisplay}

üí¨ Notes: ${notes}

üí∞ Estimated Fare: ${totalFare}

Please confirm availability!`;
  
  const whatsappLink = `https://wa.me/17204748851?text=${encodeURIComponent(message)}`;
  document.getElementById('whatsappLink').href = whatsappLink;
}

// Listen for form field changes
document.querySelectorAll('input, select, textarea').forEach(field => {
  if (field.id !== 'pickupAddress' && field.id !== 'dropoffAddress') {
    field.addEventListener('input', updateWhatsApp);
    field.addEventListener('change', updateWhatsApp);
  }
});

// Manual input listener for address fields
document.getElementById('pickupAddress').addEventListener('blur', () => {
  calculateFare();
  updateWhatsApp();
});

document.getElementById('dropoffAddress').addEventListener('blur', () => {
  calculateFare();
  updateWhatsApp();
});

// Turnstile callback
function onTurnstileVerified(token) {
  turnstileVerified = true;
  document.getElementById('submitBtn').disabled = false;
}

// Show message
function showMsg(text, type) {
  const msgBox = document.getElementById('msgBox');
  msgBox.textContent = text;
  msgBox.className = `msg ${type}`;
  msgBox.style.display = 'block';
  msgBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Form submission with validation
document.getElementById('airportForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!turnstileVerified) {
    showMsg('‚ùå Please complete the security verification', 'err');
    return;
  }
  
  // CRITICAL: Validate addresses before submission
  const validation = validateAddresses();
  if (!validation.valid) {
    showMsg(`‚ùå ${validation.error}`, 'err');
    return;
  }
  
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  // Collect form data
  const pickupDate = document.getElementById('pickupDate').value;
  const pickupTime = document.getElementById('pickupTime').value;
  const pickupDateTime = new Date(`${pickupDate}T${pickupTime}`);
  const pickupTimeUTC = pickupDateTime.toISOString();
  const pickupTimeLocal = `${pickupDate}T${pickupTime}`;
  const pickupTimeDisplay = formatDateTime(pickupDate, pickupTime);
  
  const formData = {
    'cf-turnstile-response': turnstile.getResponse(),
    created_by: document.getElementById('name').value,
    rider_phone: document.getElementById('phone').value,
    rider_email: document.getElementById('email').value || null,
    rider_type: 'GENERAL',
    trip_type: 'AIRPORT',
    direction: document.getElementById('direction').value,
    airline: document.getElementById('airline').value || null,
    flight_number: document.getElementById('flightNumber').value || null,
    pickup_text: document.getElementById('pickupAddress').value,
    dropoff_text: document.getElementById('dropoffAddress').value,
    pickup_time_utc: pickupTimeUTC,
    pickup_time_local: pickupTimeLocal,
    pickup_time_display: pickupTimeDisplay,
    notes: document.getElementById('notes').value || null
  };
  
  try {
    const response = await fetch('https://travylway-api.benterpryzes2084.workers.dev/api/trips', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (response.ok && result.ok) {
      showMsg('‚úÖ Your ride request has been submitted! We\'ll contact you shortly via WhatsApp to confirm.', 'ok');
      document.getElementById('airportForm').reset();
      turnstileVerified = false;
      document.getElementById('totalFare').textContent = `$${BASE_FARE.toFixed(2)}`;
      document.getElementById('distanceFare').textContent = 'Enter addresses to calculate';
      document.getElementById('pickupHint').textContent = 'Select service type first';
      document.getElementById('dropoffHint').textContent = 'Select service type first';
    } else {
      showMsg(`‚ùå Error: ${result.error || 'Failed to submit request. Please try again.'}`, 'err');
    }
  } catch (error) {
    showMsg('‚ùå Network error. Please check your connection and try again.', 'err');
    console.error('Submission error:', error);
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Ride Request';
  }
});

// Initialize on load
window.addEventListener('load', () => {
  initMap();
  updateWhatsApp();
  
  // Set minimum date to today
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('pickupDate').min = today;
});
</script>

</body>
</html>

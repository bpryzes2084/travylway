<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Air Crew Pickup Request ‚Äî Travylway</title>
<meta name="description" content="Request airport pickup or drop-off transportation for airline crew.">

<style>
:root{
  --bg:#2B3A4A; --card:#fff; --text:#0F172A; --muted:#64748B; --line:#E2E8F0;
  --okbg:#ECFDF5; --okbd:#BBF7D0; --oktx:#166534;
  --erbg:#FFF1F2; --erbd:#FECDD3; --ertx:#9F1239;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#E5E7EB;padding:28px 14px}
.container{max-width:760px;margin:0 auto}
.card{background:var(--card);color:var(--text);border-radius:22px;padding:26px;box-shadow:0 22px 70px rgba(0,0,0,.28)}
.header{text-align:center;margin-bottom:18px}
.header h1{margin:0 0 6px;font-size:1.85rem}
.header p{margin:0;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
.group{margin:0 0 14px}
label{display:block;font-weight:800;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px;border:2px solid var(--line);border-radius:12px;font-size:1rem}
input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea}
textarea{min-height:90px}
.req{color:#ef4444;font-weight:900}
.btn{display:block;text-align:center;text-decoration:none;width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.msg{display:none;padding:12px;border-radius:12px;margin-bottom:12px;font-weight:800;text-align:center}
.msg.ok{display:block;background:var(--okbg);border:1px solid var(--okbd);color:var(--oktx)}
.msg.err{display:block;background:var(--erbg);border:1px solid var(--erbd);color:var(--ertx);white-space:pre-wrap}
.price-estimate{display:none;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:18px;border-radius:12px;margin:16px 0;animation:slideIn .3s}
@keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
.price-amount{font-size:2.2rem;font-weight:900;margin-bottom:6px}
.price-details{font-size:1rem;opacity:.95;margin-bottom:12px}
.price-breakdown{background:rgba(255,255,255,.15);padding:12px;border-radius:8px;font-size:.9rem}
.price-row{display:flex;justify-content:space-between;margin-bottom:6px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,.2)}
.price-row:last-child{border:0;margin:0;padding:0}
.driver-split{margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.3);font-size:.9rem;opacity:.95}
.pac-container{z-index:99999!important}
.small{color:var(--muted);font-size:.9rem;margin-top:6px}
.timezone{color:#2196f3;font-weight:700;font-size:.85rem;margin-top:6px;display:block}
.loading{text-align:center;padding:16px;color:#667eea;display:none}
.loading.show{display:block}
.spinner{border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;margin:0 auto 8px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h1>‚úàÔ∏è Air Crew Pickup Request</h1>
      <p>Professional airport transportation for airline crew</p>
    </div>

    <div id="ok" class="msg ok"></div>
    <div id="err" class="msg err"></div>

    <form id="crewForm">
      <div class="group">
        <label>Name <span class="req">*</span></label>
        <input id="name" required placeholder="Captain Jane Smith">
      </div>

      <div class="grid">
        <div class="group">
          <label>Phone <span class="req">*</span></label>
          <input id="phone" required placeholder="+1 (555) 123-4567">
        </div>
        <div class="group">
          <label>Email</label>
          <input id="email" type="email" placeholder="jane@airline.com">
        </div>
      </div>

      <div class="group">
        <label>Pickup Address <span class="req">*</span></label>
        <input id="pickupAddress" placeholder="Denver International Airport, Terminal A" required>
      </div>

      <div class="group">
        <label>Drop-off Address <span class="req">*</span></label>
        <input id="dropoffAddress" placeholder="123 Main St, Denver, CO 80202" required>
      </div>

      <div class="grid">
        <div class="group">
          <label>Service Type <span class="req">*</span></label>
          <select id="serviceType" required>
            <option value="">Select</option>
            <option value="AIRPORT">From Airport (arriving)</option>
            <option value="TO_AIRPORT">To Airport (departing)</option>
          </select>
        </div>

        <div class="group">
          <label>Airport Code <span class="req">*</span></label>
          <input id="airportCode" maxlength="4" placeholder="DEN" required>
        </div>
      </div>

      <div class="grid">
        <div class="group">
          <label>Date <span class="req">*</span></label>
          <input id="date" type="date" required>
        </div>
        <div class="group">
          <label>Time <span class="req">*</span></label>
          <input id="time" type="time" required>
          <span id="timezone" class="timezone">üïê Local Time (Auto-detected)</span>
        </div>
      </div>

      <div class="grid">
        <div class="group">
          <label>Airline</label>
          <select id="airline">
            <option value="">Select airline...</option>
            <option value="United Airlines">United Airlines</option>
            <option value="Delta Air Lines">Delta Air Lines</option>
            <option value="American Airlines">American Airlines</option>
            <option value="Southwest Airlines">Southwest Airlines</option>
            <option value="JetBlue Airways">JetBlue Airways</option>
            <option value="Alaska Airlines">Alaska Airlines</option>
            <option value="Spirit Airlines">Spirit Airlines</option>
            <option value="Frontier Airlines">Frontier Airlines</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="group">
          <label>Flight Number</label>
          <input id="flightNumber" placeholder="UA1234">
        </div>
      </div>

      <div class="group">
        <label>Notes</label>
        <textarea id="notes" placeholder="Special requests, extra luggage, etc."></textarea>
      </div>

      <!-- Loading spinner for fare calculation -->
      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Calculating fare...</p>
      </div>

      <!-- Fare estimate display -->
      <div id="priceEstimate" class="price-estimate">
        <div class="price-amount">$<span id="fareTotal">0.00</span></div>
        <div class="price-details">
          <span id="fareDistance">0 mi</span> ‚Ä¢ <span id="fareDuration">0 min</span>
        </div>
        <div class="price-breakdown">
          <div class="price-row">
            <span>Base fare</span>
            <span>$<span id="fareBase">2.50</span></span>
          </div>
          <div class="price-row">
            <span>Distance</span>
            <span>$<span id="fareDist">0.00</span></span>
          </div>
          <div class="price-row">
            <span>Time</span>
            <span>$<span id="fareTime">0.00</span></span>
          </div>
          <div class="price-row" id="airportFeeRow">
            <span>Airport fee</span>
            <span>$<span id="fareAirport">0.00</span></span>
          </div>
        </div>
        <div class="driver-split">
          üí∞ Driver receives: $<span id="driverPayout">0.00</span> (75%)
        </div>
      </div>

      <!-- Turnstile -->
      <div class="group">
        <div class="cf-turnstile" data-sitekey="0x4AAAAAACMebvxe_6kPGUnO"></div>
        <div class="small">Spam protection enabled.</div>
      </div>

      <button class="btn primary" id="submitBtn" type="submit">Calculate Fare & Book</button>
    </form>
  </div>
</div>

<!-- Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
/* CONFIG */
const API_BASE = "https://travylway-api.benterpryzes2084.workers.dev";

/* Google Maps API Key - REPLACE WITH YOUR KEY */
const GOOGLE_MAPS_KEY = "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo";

const el = id => document.getElementById(id);

let fareCalculated = false;
let fareData = null;

function showOk(msg){
  el("ok").textContent = msg;
  el("ok").style.display = "block";
  el("err").style.display = "none";
}

function showErr(msg){
  el("err").textContent = msg;
  el("err").style.display = "block";
  el("ok").style.display = "none";
}

/* Load Google Maps */
function loadGoogleMaps() {
  return new Promise((resolve, reject) => {
    if (window.google && google.maps && google.maps.places) {
      return resolve();
    }
    
    const script = document.createElement("script");
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_KEY}&libraries=places`;
    script.async = true;
    script.defer = true;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error("Google Maps failed to load"));
    document.head.appendChild(script);
  });
}

/* Initialize address autocomplete */
function initAutocomplete() {
  const pickupInput = el("pickupAddress");
  const dropoffInput = el("dropoffAddress");
  
  if (!pickupInput || !dropoffInput) return;
  
  // Initialize autocomplete for pickup
  const pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, {
    types: ["address"]
  });
  
  // Initialize autocomplete for dropoff
  const dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput, {
    types: ["address"]
  });
  
  console.log("‚úÖ Google Maps autocomplete ready");
}

/* Calculate fare using worker's API */
async function calculateFare() {
  const pickup = el("pickupAddress").value.trim();
  const dropoff = el("dropoffAddress").value.trim();
  const tripType = el("serviceType").value;
  
  if (!pickup || !dropoff || !tripType) return;
  
  // Show loading
  el("loading").classList.add('show');
  el("priceEstimate").style.display = 'none';
  el("err").style.display = 'none';
  
  try {
    const response = await fetch(
      `${API_BASE}/api/fare-estimate?pickup=${encodeURIComponent(pickup)}&dropoff=${encodeURIComponent(dropoff)}&trip_type=${tripType}`
    );
    
    const data = await response.json();
    
    if (data.ok && data.fare) {
      fareData = data;
      fareCalculated = true;
      
      // Update display
      el("fareTotal").textContent = data.fare.total.toFixed(2);
      el("fareDistance").textContent = data.distance.text;
      el("fareDuration").textContent = data.duration.text;
      el("fareBase").textContent = data.fare.baseFare.toFixed(2);
      el("fareDist").textContent = data.fare.distanceCost.toFixed(2);
      el("fareTime").textContent = data.fare.timeCost.toFixed(2);
      el("driverPayout").textContent = data.fare.driverPayout.toFixed(2);
      
      // Show airport fee if applicable
      if (data.fare.airportFee > 0) {
        el("airportFeeRow").style.display = 'flex';
        el("fareAirport").textContent = data.fare.airportFee.toFixed(2);
      } else {
        el("airportFeeRow").style.display = 'none';
      }
      
      // Show fare estimate
      el("priceEstimate").style.display = 'block';
      
      // Update button text
      el("submitBtn").textContent = `Book Crew Transport - $${data.fare.total.toFixed(2)}`;
      
    } else {
      showErr(data.error || 'Unable to calculate fare. Please check addresses.');
      fareCalculated = false;
    }
    
  } catch (error) {
    console.error('Fare calculation error:', error);
    showErr('Network error calculating fare. Please try again.');
    fareCalculated = false;
  } finally {
    el("loading").classList.remove('show');
  }
}

/* Auto-calculate fare when addresses or trip type changes */
el("pickupAddress").addEventListener('blur', calculateFare);
el("dropoffAddress").addEventListener('blur', calculateFare);
el("serviceType").addEventListener('change', calculateFare);

/* Set minimum date to today */
el("date").min = new Date().toISOString().split('T')[0];

/* Get user's timezone */
const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
const timezoneEl = el("timezone");
if (timezoneEl) {
  timezoneEl.textContent = `üïê ${userTimezone.replace('_', ' ')}`;
}

/* Submit handler */
el("crewForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  el("ok").style.display = "none";
  el("err").style.display = "none";

  // Calculate fare if not already done
  if (!fareCalculated) {
    await calculateFare();
    if (!fareCalculated) {
      showErr("Please wait for fare calculation to complete.");
      return;
    }
  }

  const btn = el("submitBtn");
  btn.disabled = true;
  btn.textContent = "Submitting‚Ä¶";

  try {
    const airport = el("airportCode").value.trim().toUpperCase();
    if (!/^[A-Z0-9]{3,4}$/.test(airport)) {
      throw new Error("Airport code must be 3-4 letters like DEN, LAX, JFK");
    }

    const serviceType = el("serviceType").value;
    if (!serviceType) throw new Error("Select a service type.");
    
    // Build local datetime
    const dateVal = el("date").value;
    const timeVal = el("time").value;
    const localDateTime = `${dateVal}T${timeVal}:00`;
    
    // Turnstile token
    const ts = document.querySelector('input[name="cf-turnstile-response"]')?.value || "";
    if (!ts) {
      throw new Error("Security verification not ready. Wait a moment and try again.");
    }

    // Build payload matching worker expectations
    const payload = {
      created_by: el("name").value.trim(),
      rider_phone: el("phone").value.trim(),
      rider_type: "CREW",
      trip_type: "AIRPORT",
      trip_category: "CREW",
      
      airport_code: airport,
      direction: serviceType === "AIRPORT" ? "FROM_AIRPORT" : "TO_AIRPORT",
      
      pickup_text: el("pickupAddress").value.trim(),
      dropoff_text: el("dropoffAddress").value.trim(),
      
      pickup_date: dateVal,
      pickup_time_local: timeVal,
      pickup_timezone: userTimezone,
      
      airline: el("airline").value.trim() || null,
      flight_number: el("flightNumber").value.trim() || null,
      
      notes: el("notes").value.trim() || null,
      
      // Include fare data from calculation
      estimated_fare: fareData.fare.total,
      distance_miles: fareData.distance.miles,
      duration_minutes: fareData.duration.minutes,
      driver_payout: fareData.fare.driverPayout,
      platform_fee: fareData.fare.platformFee,
      
      // Turnstile token
      "cf-turnstile-response": ts
    };

    const res = await fetch(`${API_BASE}/api/trips`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));
    
    if (!res.ok || data.ok === false) {
      throw new Error(data.error || `Server error (HTTP ${res.status})`);
    }

    showOk(`‚úÖ Booking Confirmed! Request ID: ${data.id.substring(0, 8)}\n\nYou'll receive flight tracking updates via WhatsApp.`);

    // Reset form
    el("crewForm").reset();
    fareCalculated = false;
    fareData = null;
    el("priceEstimate").style.display = "none";
    el("submitBtn").textContent = "Calculate Fare & Book";
    
    if (window.turnstile) {
      try { window.turnstile.reset(); } catch {}
    }

  } catch (err) {
    showErr(`Submission failed:\n${err.message}`);
    if (window.turnstile) {
      try { window.turnstile.reset(); } catch {}
    }
  } finally {
    btn.disabled = false;
    if (fareCalculated && fareData) {
      btn.textContent = `Book Crew Transport - $${fareData.fare.total.toFixed(2)}`;
    } else {
      btn.textContent = "Calculate Fare & Book";
    }
  }
});

/* Boot */
loadGoogleMaps()
  .then(() => {
    initAutocomplete();
  })
  .catch((error) => {
    console.error("Google Maps error:", error);
    showErr("Address autocomplete unavailable. You can still type addresses manually.");
  });

</script>

</body>
</html>

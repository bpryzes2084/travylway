<script>
var BASE_FARE = 2.50;
var PER_MILE_RATE = 1.25;
var MINIMUM_FARE = 18;
var MAXIMUM_FARE = 120;
var FREE_MILES = 3;

var form = document.getElementById('pickupForm');
var distanceField = document.createElement('input');
distanceField.type = 'hidden';
distanceField.id = 'calculatedDistance';
distanceField.name = 'calculatedDistance';
form.appendChild(distanceField);

var priceField = document.createElement('input');
priceField.type = 'hidden';
priceField.id = 'calculatedPrice';
priceField.name = 'calculatedPrice';
form.appendChild(priceField);

var serviceTierField = document.createElement('input');
serviceTierField.type = 'hidden';
serviceTierField.name = 'serviceTier';
serviceTierField.value = 'crew';
form.appendChild(serviceTierField);

var map;
var placesService;

function initMap() {
  console.log('Google Maps loaded');
  map = new google.maps.Map(document.createElement('div'));
  placesService = new google.maps.places.PlacesService(map);
}

function calculatePrice() {
  var address = document.getElementById('address').value;
  var airport = document.getElementById('airport').value;
  
  if (!address || !airport) {
    alert('Please enter both pickup address and airport');
    return;
  }
  
  if (typeof google === 'undefined' || !placesService) {
    alert('Google Maps is still loading. Please wait a moment and try again.');
    return;
  }
  
  var calcBtn = document.getElementById('calcBtn');
  calcBtn.disabled = true;
  calcBtn.textContent = 'Calculating...';
  
  var addressRequest = {
    query: address + ', USA',
    fields: ['geometry', 'formatted_address']
  };
  
  placesService.findPlaceFromQuery(addressRequest, function(results1, status1) {
    console.log('Address search status:', status1);
    console.log('Address results:', results1);
    
    if (status1 === google.maps.places.PlacesServiceStatus.OK && results1 && results1[0]) {
      var pickupLoc = results1[0].geometry.location;
      console.log('Pickup found:', pickupLoc.lat(), pickupLoc.lng());
      
      var airportRequest = {
        query: airport,
        fields: ['geometry', 'formatted_address']
      };
      
      placesService.findPlaceFromQuery(airportRequest, function(results2, status2) {
        console.log('Airport search status:', status2);
        console.log('Airport results:', results2);
        
        if (status2 === google.maps.places.PlacesServiceStatus.OK && results2 && results2[0]) {
          var airportLoc = results2[0].geometry.location;
          console.log('Airport found:', airportLoc.lat(), airportLoc.lng());
          
          var distanceService = new google.maps.DistanceMatrixService();
          
          distanceService.getDistanceMatrix({
            origins: [pickupLoc],
            destinations: [airportLoc],
            travelMode: 'DRIVING',
            unitSystem: google.maps.UnitSystem.IMPERIAL
          }, function(response, status) {
            console.log('Distance calculation status:', status);
            console.log('Distance response:', response);
            
            if (status === 'OK') {
              var result = response.rows[0].elements[0];
              
              if (result.status === 'OK') {
                var distanceInMeters = result.distance.value;
                var distanceInMiles = (distanceInMeters / 1609.34).toFixed(1);
                
                var price = BASE_FARE;
                var chargeableMiles = Math.max(0, distanceInMiles - FREE_MILES);
                price += chargeableMiles * PER_MILE_RATE;
                price = Math.max(MINIMUM_FARE, Math.min(MAXIMUM_FARE, price));
                price = Math.round(price);
                
                document.getElementById('distanceDisplay').textContent = 'Distance: ' + distanceInMiles + ' miles';
                document.getElementById('priceDisplay').textContent = '$' + price;
                document.getElementById('priceEstimate').style.display = 'block';
                document.getElementById('calculatedDistance').value = distanceInMiles;
                document.getElementById('calculatedPrice').value = price;
                
                calcBtn.disabled = false;
                calcBtn.textContent = '‚úì Price Calculated';
              } else {
                alert('Could not calculate distance: ' + result.status);
                calcBtn.disabled = false;
                calcBtn.textContent = 'üìç Calculate Distance & Price';
              }
            } else {
              alert('Distance calculation failed: ' + status);
              calcBtn.disabled = false;
              calcBtn.textContent = 'üìç Calculate Distance & Price';
            }
          });
        } else {
          alert('Could not find airport.\n\nPlease try: "Denver International Airport, CO"');
          calcBtn.disabled = false;
          calcBtn.textContent = 'üìç Calculate Distance & Price';
        }
      });
    } else {
      alert('Could not find address.\n\nPlease include:\n- Street number and name\n- City, State, Zip\n\nExample: "123 Main St, Aurora, CO 80012"');
      calcBtn.disabled = false;
      calcBtn.textContent = 'üìç Calculate Distance & Price';
    }
  });
}

document.getElementById('calcBtn').addEventListener('click', calculatePrice);

document.getElementById('pickupForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  var submitBtn = document.getElementById('submitBtn');
  var successMsg = document.getElementById('successMessage');
  var errorMsg = document.getElementById('errorMessage');
  
  successMsg.style.display = 'none';
  errorMsg.style.display = 'none';
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Submitting...';
  
  var formData = new FormData(e.target);
  var data = {};
  formData.forEach(function(value, key) {
    data[key] = value;
  });
  
  fetch('https://travylway-api.benterpryzes2084.workers.dev/add-trip', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  })
  .then(function(response) {
    if (response.ok) {
      successMsg.style.display = 'block';
      e.target.reset();
      document.getElementById('priceEstimate').style.display = 'none';
      document.getElementById('airport').value = 'Denver International Airport';
      successMsg.scrollIntoView({behavior: 'smooth', block: 'center'});
    } else {
      throw new Error('Failed');
    }
  })
  .catch(function(error) {
    errorMsg.style.display = 'block';
    errorMsg.scrollIntoView({behavior: 'smooth', block: 'center'});
  })
  .finally(function() {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit Request';
  });
});
</script>

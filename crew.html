<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crew Booking - TravylWay</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

    body{
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:640px;
      background:#fff;
      border-radius:16px;
      padding:28px;
      box-shadow:0 10px 40px rgba(0,0,0,.22);
    }

    .badge{
      background: linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);
      color:#222;
      padding:10px 18px;
      border-radius:999px;
      text-align:center;
      font-weight:800;
      margin-bottom:14px;
      letter-spacing:.2px;
    }

    h1{
      text-align:center;
      color:#222;
      margin-bottom:8px;
      font-size:28px;
    }

    .subhead{
      text-align:center;
      color:#555;
      margin-bottom:22px;
      font-size:14px;
      line-height:1.35;
    }

    .form-group{ margin-bottom:16px; position:relative; }

    label{
      display:block;
      font-weight:650;
      margin-bottom:6px;
      color:#222;
      font-size:14px;
    }

    input, textarea{
      width:100%;
      padding:12px 12px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:16px;
      transition: border-color .15s ease;
    }

    input:focus, textarea:focus{
      outline:none;
      border-color:#667eea;
    }

    textarea{ min-height:84px; resize:vertical; }

    .hint{
      margin-top:6px;
      font-size:12px;
      color:#666;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .btn{
      width:100%;
      padding:15px;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      margin-top:10px;
      transition: transform .2s ease, box-shadow .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    .btn:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }

    .btn:disabled{ background:#cfcfcf; cursor:not-allowed; }

    .message{
      padding:14px;
      border-radius:10px;
      margin-top:14px;
      text-align:center;
      display:none;
      font-size:14px;
      line-height:1.35;
    }

    .success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    .loading{
      display:inline-block;
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,.35);
      border-radius:50%;
      border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* Honeypot field: hidden from humans */
    .hp{
      position:absolute !important;
      left:-9999px !important;
      width:1px; height:1px;
      overflow:hidden;
    }

    .footer-note{
      margin-top:16px;
      text-align:center;
      color:#666;
      font-size:12px;
    }

    .quote-box{
      border:2px dashed #ddd;
      border-radius:12px;
      padding:12px;
      background:#fafafa;
    }

    .quote-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      margin:6px 0;
      color:#222;
    }
    .quote-row span:last-child{ font-weight:700; }

    .pill{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
      background:#eef2ff;
      color:#333;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="badge">‚úàÔ∏è AIRLINE CREW DISCOUNT</div>

    <h1>üöó Book Crew Ride</h1>
    <div class="subhead">
      Crew-only requests. Airport ‚Üî hotel runs. Reliable timing beats ‚Äúpretty apps.‚Äù
    </div>

    <form id="crewForm" autocomplete="on">
      <!-- Honeypot anti-bot -->
      <div class="hp">
        <label>Website</label>
        <input type="text" id="website" tabindex="-1" autocomplete="off" />
      </div>

      <div class="form-group">
        <label>Your Name *</label>
        <input type="text" id="name" required placeholder="Jane Doe" maxlength="80" />
      </div>

      <div class="form-group">
        <label>Phone Number *</label>
        <input type="tel" id="phone" required placeholder="+1 (720) 555-1234" maxlength="24" />
        <div class="hint">Used for confirmation + driver coordination.</div>
      </div>

      <div class="form-group">
        <label>Pickup Address *</label>
        <input type="text" id="pickup" required placeholder="Denver International Airport (DEN)" maxlength="140" />
        <div class="hint">Tip: include terminal/door if relevant. Autocomplete supported (if enabled).</div>
      </div>

      <div class="form-group">
        <label>Dropoff Address *</label>
        <input type="text" id="dropoff" required placeholder="Hotel name + address" maxlength="140" />
      </div>

      <!-- Quote / Fare display -->
      <div class="form-group">
        <div class="quote-box">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
            <span class="pill">Estimated Fare</span>
            <button type="button" class="btn" id="quoteBtn" style="width:auto; padding:10px 12px; font-size:14px; margin-top:0;">
              <span id="quoteText">Calculate</span>
              <span class="loading" id="quoteSpinner" style="display:none;"></span>
            </button>
          </div>

          <div class="quote-row">
            <span>Fare</span>
            <span id="fareDisplay">‚Äî</span>
          </div>
          <div class="quote-row">
            <span>Distance</span>
            <span id="distanceDisplay">‚Äî</span>
          </div>
          <div class="quote-row">
            <span>Duration</span>
            <span id="durationDisplay">‚Äî</span>
          </div>

          <div class="hint" style="margin-top:8px;">
            Fare is traffic-aware and includes crew discount. Final fare may adjust for stops/waiting.
          </div>
        </div>

        <!-- Hidden values sent to backend -->
        <input type="hidden" id="estimatedFare" value="0" />
        <input type="hidden" id="quoteMiles" value="0" />
        <input type="hidden" id="quoteMinutes" value="0" />
      </div>

      <div class="grid">
        <div class="form-group">
          <label>Pickup Date *</label>
          <input type="date" id="date" required />
        </div>

        <div class="form-group">
          <label>Pickup Time (local) *</label>
          <input type="time" id="time" required />
        </div>
      </div>

      <div class="grid">
        <div class="form-group">
          <label>Flight Number (optional)</label>
          <input type="text" id="flight" placeholder="UA1234" maxlength="10" />
          <div class="hint">Optional. Leave blank if not available.</div>
        </div>

        <div class="form-group">
          <label>Airport Code (optional)</label>
          <input type="text" id="airport" placeholder="DEN" maxlength="4" />
          <div class="hint">3‚Äì4 letters (IATA/ICAO). Example: DEN / KDEN</div>
        </div>
      </div>

      <div class="form-group">
        <label>Airline (optional)</label>
        <input type="text" id="airline" placeholder="United Airlines" maxlength="60" />
      </div>

      <div class="form-group">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Crew count, bags, special pickup notes..."></textarea>
      </div>

      <button type="submit" class="btn" id="submitBtn">
        <span id="submitText">Submit Crew Booking</span>
        <span class="loading" id="submitSpinner" style="display:none;"></span>
      </button>
    </form>

    <div id="message" class="message"></div>

    <div class="footer-note">
      By submitting, you confirm you are airline crew and agree to crew-only verification if requested.
    </div>
  </div>

  <script>
    /**
     * ‚úÖ CONFIG
     * Use your Worker domain here (no trailing slash)
     */
    const CLOUDFLARE_WORKER_URL = "https://api.travylway.com";

    /**
     * ‚úÖ OPTIONAL: Google Places Autocomplete
     * To enable address dropdown autocomplete:
     *  - Create a separate *browser* key restricted by HTTP referrer to your domain
     *  - Enable Maps JavaScript API + Places API for that key's project
     *  - Replace YOUR_BROWSER_KEY below
     *
     * If you do NOT set a browser key, the form still works; users just type addresses manually.
     */
    const GOOGLE_BROWSER_KEY = "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo"; // <-- put your browser key here (optional)

    // DOM Elements
    const form = document.getElementById("crewForm");
    const messageDiv = document.getElementById("message");

    const submitBtn = document.getElementById("submitBtn");
    const submitText = document.getElementById("submitText");
    const submitSpinner = document.getElementById("submitSpinner");

    const quoteBtn = document.getElementById("quoteBtn");
    const quoteText = document.getElementById("quoteText");
    const quoteSpinner = document.getElementById("quoteSpinner");

    const nameEl = document.getElementById("name");
    const phoneEl = document.getElementById("phone");
    const pickupEl = document.getElementById("pickup");
    const dropoffEl = document.getElementById("dropoff");
    const dateEl = document.getElementById("date");
    const timeEl = document.getElementById("time");
    const flightEl = document.getElementById("flight");
    const airportEl = document.getElementById("airport");
    const airlineEl = document.getElementById("airline");
    const notesEl = document.getElementById("notes");

    const fareDisplayEl = document.getElementById("fareDisplay");
    const distanceDisplayEl = document.getElementById("distanceDisplay");
    const durationDisplayEl = document.getElementById("durationDisplay");

    const estimatedFareEl = document.getElementById("estimatedFare");
    const quoteMilesEl = document.getElementById("quoteMiles");
    const quoteMinutesEl = document.getElementById("quoteMinutes");

    // Min date = today (local)
    const todayLocal = new Date();
    const yyyy = todayLocal.getFullYear();
    const mm = String(todayLocal.getMonth() + 1).padStart(2, "0");
    const dd = String(todayLocal.getDate()).padStart(2, "0");
    dateEl.min = `${yyyy}-${mm}-${dd}`;

    // Helpers
    function showMessage(type, text) {
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = "block";
    }

    function setSubmitLoading(isLoading) {
      submitBtn.disabled = isLoading;
      submitText.style.display = isLoading ? "none" : "inline";
      submitSpinner.style.display = isLoading ? "inline-block" : "none";
    }

    function setQuoteLoading(isLoading) {
      quoteBtn.disabled = isLoading;
      quoteText.style.display = isLoading ? "none" : "inline";
      quoteSpinner.style.display = isLoading ? "inline-block" : "none";
    }

    // SAFER local -> UTC conversion
    function toUtcIsoFromLocalDateAndTime(dateStr, timeStr) {
      const [y, m, d] = dateStr.split("-").map(Number);
      const [hh, min] = timeStr.split(":").map(Number);
      const localDate = new Date(y, (m - 1), d, hh, min, 0);
      return localDate.toISOString();
    }

    function isValidAirportCode(code) {
      // Accept 3-letter IATA or 4-letter ICAO (letters only)
      return /^[A-Z]{3,4}$/.test(code);
    }

    function resetQuoteUI() {
      fareDisplayEl.textContent = "‚Äî";
      distanceDisplayEl.textContent = "‚Äî";
      durationDisplayEl.textContent = "‚Äî";
      estimatedFareEl.value = "0";
      quoteMilesEl.value = "0";
      quoteMinutesEl.value = "0";
    }

    function fmt2(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "‚Äî";
      return (Math.round((x + Number.EPSILON) * 100) / 100).toFixed(2);
    }

    // Input normalization
    phoneEl.addEventListener("input", function () {
      this.value = this.value.replace(/[^\d+()\s-]/g, "");
    });

    airportEl.addEventListener("input", function () {
      this.value = this.value.toUpperCase().replace(/[^A-Z]/g, "");
    });

    flightEl.addEventListener("input", function () {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, "");
    });

    // Quote calculation
    async function fetchQuote() {
      const pickup = pickupEl.value.trim();
      const dropoff = dropoffEl.value.trim();

      if (!pickup || !dropoff) {
        resetQuoteUI();
        return null;
      }

      setQuoteLoading(true);
      messageDiv.style.display = "none";

      try {
        const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/quote`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            pickup_text: pickup,
            dropoff_text: dropoff,
            rider_type: "CREW",
          }),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          const msg = data?.error || data?.message || `Quote failed (HTTP ${res.status})`;
          showMessage("error", `‚ùå Fare quote error: ${msg}`);
          resetQuoteUI();
          return null;
        }

        const total = Number(data?.estimate?.total ?? 0);
        const miles = Number(data?.miles ?? 0);
        const minutes = Number(data?.minutes ?? 0);

        fareDisplayEl.textContent = total ? `$${fmt2(total)}` : "‚Äî";
        distanceDisplayEl.textContent = miles ? `${fmt2(miles)} mi` : "‚Äî";
        durationDisplayEl.textContent = minutes ? `${fmt2(minutes)} min` : "‚Äî";

        estimatedFareEl.value = total ? String(total) : "0";
        quoteMilesEl.value = miles ? String(miles) : "0";
        quoteMinutesEl.value = minutes ? String(minutes) : "0";

        return data;
      } catch (err) {
        showMessage("error", `‚ùå Fare quote error: ${err.message}`);
        resetQuoteUI();
        return null;
      } finally {
        setQuoteLoading(false);
      }
    }

    // Quote triggers
    quoteBtn.addEventListener("click", async () => {
      await fetchQuote();
    });

    // Optional: auto-quote when user finishes typing addresses
    [pickupEl, dropoffEl].forEach((el) => {
      el.addEventListener("blur", () => { fetchQuote(); });
    });

    // Form submit
    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // Honeypot trap
      const hp = document.getElementById("website").value.trim();
      if (hp) {
        showMessage("error", "‚ùå Submission blocked.");
        return;
      }

      // Required basic fields
      const name = nameEl.value.trim();
      const phone = phoneEl.value.trim();
      const pickup = pickupEl.value.trim();
      const dropoff = dropoffEl.value.trim();

      if (!name || !phone || !pickup || !dropoff) {
        showMessage("error", "‚ùå Please fill in name, phone, pickup, and dropoff.");
        return;
      }

      // Optional airport code validation (only validate if present)
      const airportCode = airportEl.value.trim().toUpperCase();
      if (airportCode && !isValidAirportCode(airportCode)) {
        showMessage("error", "‚ùå Airport code must be 3‚Äì4 letters (DEN or KDEN).");
        return;
      }

      const dateVal = dateEl.value;
      const timeVal = timeEl.value;
      if (!dateVal || !timeVal) {
        showMessage("error", "‚ùå Pickup date and time are required.");
        return;
      }

      // UI loading state
      setSubmitLoading(true);
      messageDiv.style.display = "none";

      // Ensure we have a quote (best-effort). If quote fails, we still allow booking (minFare fallback).
      if (!Number(estimatedFareEl.value || 0)) {
        await fetchQuote();
      }

      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const pickupTimeUTC = toUtcIsoFromLocalDateAndTime(dateVal, timeVal);

      // Optional fields
      const flightNumber = flightEl.value.trim().toUpperCase();
      const airline = airlineEl.value.trim();
      const notes = notesEl.value.trim();

      // Payload
      const payload = {
        created_by: name,
        rider_phone: phone,
        rider_type: "CREW",
        pickup_text: pickup,
        dropoff_text: dropoff,
        pickup_time_utc: pickupTimeUTC,
        pickup_timezone: timezone,

        flight_number: flightNumber || "",
        airline: airline || "",
        airport_code: airportCode || "",

        notes: notes || "",
        estimated_fare: Number(estimatedFareEl.value || 0),
        quote_miles: Number(quoteMilesEl.value || 0),
        quote_minutes: Number(quoteMinutesEl.value || 0),

        timestamp: new Date().toISOString(),
        source: "crew.html",
      };

      try {
        const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/trips`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            // If you add admin auth later, DO NOT put it here for public booking.
          },
          body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.ok) {
          const msg = data?.error || data?.message || `HTTP ${res.status}: ${res.statusText}`;
          throw new Error(msg);
        }

        const confirmationId = data?.id || "N/A";
        const fareShown = Number(payload.estimated_fare || 0) ? `$${fmt2(payload.estimated_fare)}` : "min fare";

        // If you deployed the v3.1 Worker, it may return telegram_debug. We'll show a tiny hint if it failed.
        const tg = data?.telegram_debug;
        let tgHint = "";
        if (tg && tg.ok === false) {
          const desc = tg?.description || tg?.error || "telegram failed";
          tgHint = ` (Dispatch alert issue: ${desc})`;
        }

        showMessage(
          "success",
          `‚úÖ Crew booking submitted! Confirmation ID: ${confirmationId}. Estimated fare: ${fareShown}.${tgHint}`
        );

        form.reset();
        dateEl.min = `${yyyy}-${mm}-${dd}`;
        resetQuoteUI();
      } catch (err) {
        showMessage("error", `‚ùå Error: ${err.message}`);
      } finally {
        setSubmitLoading(false);
      }
    });

    /**
     * Places Autocomplete loader (optional)
     * If GOOGLE_BROWSER_KEY is set, we inject Maps JS with Places library.
     */
    function loadPlacesScriptIfConfigured() {
      if (!GOOGLE_BROWSER_KEY) return;

      const s = document.createElement("script");
      s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_BROWSER_KEY)}&libraries=places&callback=initPlaces`;
      s.async = true;
      s.defer = true;
      document.head.appendChild(s);
    }

    // Called by Google script callback when loaded
    window.initPlaces = function initPlaces() {
      if (!window.google?.maps?.places) return;

      const options = {
        fields: ["formatted_address", "name", "place_id"],
        // Change/remove if you want global suggestions:
        componentRestrictions: { country: "us" },
      };

      const pickupAC = new google.maps.places.Autocomplete(pickupEl, options);
      const dropoffAC = new google.maps.places.Autocomplete(dropoffEl, options);

      pickupAC.addListener("place_changed", () => {
        const place = pickupAC.getPlace();
        if (place?.formatted_address) pickupEl.value = place.formatted_address;
        fetchQuote();
      });

      dropoffAC.addListener("place_changed", () => {
        const place = dropoffAC.getPlace();
        if (place?.formatted_address) dropoffEl.value = place.formatted_address;
        fetchQuote();
      });
    };

    // Start
    resetQuoteUI();
    loadPlacesScriptIfConfigured();
  </script>
</body>
</html>

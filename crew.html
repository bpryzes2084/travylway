/* =========================
   Submit (WITH DEBUGGING)
========================= */
el("crewForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  el("ok").style.display = "none";
  el("err").style.display = "none";

  const btn = el("submitBtn");
  btn.disabled = true;
  btn.textContent = "Submitting‚Ä¶";

  try {
    const nameVal  = el("name").value.trim();
    const phoneVal = el("phone").value.trim();

    console.log("=== FORM VALUES ===");
    console.log("Name:", nameVal);
    console.log("Phone:", phoneVal);

    if (!nameVal) throw new Error("Name is required.");
    if (!phoneVal) throw new Error("Phone is required.");

    const airport = el("airportCode").value.trim().toUpperCase();
    if (!/^[A-Z0-9]{3,4}$/.test(airport)) throw new Error("Airport code must look like DEN, LAX, JFK, etc.");

    const serviceType = el("serviceType").value;
    if (!serviceType) throw new Error("Select a service type.");

    const pickupText = el("pickupAddress").value.trim();
    const dropText   = el("dropoffAddress").value.trim();
    
    console.log("Pickup:", pickupText);
    console.log("Dropoff:", dropText);
    
    if (!pickupText) throw new Error("Pickup address is required.");
    if (!dropText) throw new Error("Drop-off address is required.");

    const dateVal = el("date").value;
    const timeVal = el("time").value;
    
    console.log("Date:", dateVal);
    console.log("Time:", timeVal);
    
    if (!dateVal || !timeVal) throw new Error("Pickup date and time are required.");

    // Get timezone
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const localDateTime = `${dateVal}T${timeVal}:00`;
    const pickupDateTime = new Date(localDateTime);
    const pickup_time_utc = pickupDateTime.toISOString();

    console.log("Timezone:", timezone);
    console.log("pickup_time_utc:", pickup_time_utc);

    // Calculate estimated fare if available
    let estimatedFare = 2.50;
    let distanceMiles = 0;
    let durationMinutes = 0;
    
    if (pickupLoc && dropLoc) {
      const priceText = el("priceDisplay").textContent;
      const distText = el("distanceDisplay").textContent;
      if (priceText.includes('$')) {
        estimatedFare = parseFloat(priceText.replace('$', '')) || 2.50;
      }
      if (distText.includes('mi')) {
        distanceMiles = parseFloat(distText.replace('mi', '')) || 0;
      }
    }

    // ‚úÖ PAYLOAD - all required fields
    const payload = {
      created_by: nameVal,
      rider_phone: phoneVal,
      rider_type: "CREW",
      trip_type: "AIRPORT",
      
      pickup_text: pickupText,
      dropoff_text: dropText,
      pickup_time_utc: pickup_time_utc,
      pickup_timezone: timezone,
      
      airport_code: airport,
      airline: el("airline").value.trim() || '',
      flight_number: el("flightNumber").value.trim() || '',
      notes: el("notes").value.trim() || '',
      
      estimated_fare: estimatedFare,
      distance_miles: distanceMiles,
      duration_minutes: durationMinutes
    };

    console.log("=== PAYLOAD TO SEND ===");
    console.log(JSON.stringify(payload, null, 2));

    const res = await fetch(`${API_BASE}/api/trips`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    console.log("=== RESPONSE ===");
    console.log("Status:", res.status);
    console.log("Status Text:", res.statusText);

    const data = await res.json().catch(()=> ({}));
    console.log("Response data:", JSON.stringify(data, null, 2));
    
    if (!res.ok || data.ok === false) {
      throw new Error(data.error || data.message || `API error (HTTP ${res.status})`);
    }

    showOk(`‚úÖ Submitted! Request ID: ${data.trip_id || "OK"}\n\nYou'll receive WhatsApp confirmation soon.`);

    // Reset after success
    el("crewForm").reset();
    pickupLoc = null;
    dropLoc = null;
    el("priceEstimate").style.display = "none";
    buildWhatsApp();

    if (window.turnstile) { try { window.turnstile.reset(); } catch {} }

  } catch (err) {
    console.error("=== ERROR ===");
    console.error(err);
    showErr(`‚ùå Error: ${err.message}\n\nUse the WhatsApp Backup button below if needed.`);
    if (window.turnstile) { try { window.turnstile.reset(); } catch {} }
  } finally {
    btn.disabled = false;
    btn.textContent = "Submit Request";
  }
});
```

---

## üîç **Now do this:**

1. **Update the submit handler** with the code above
2. **Refresh the page** (Ctrl+F5)
3. **Open browser console** (F12)
4. **Fill out the form completely**
5. **Submit**
6. **Copy EVERYTHING from the console** and paste it here

**Look for these sections in console:**
```
=== FORM VALUES ===
Name: ...
Phone: ...
Pickup: ...
Dropoff: ...
Date: ...
Time: ...

=== PAYLOAD TO SEND ===
{
  "created_by": "...",
  "rider_phone": "...",
  ...
}

=== RESPONSE ===
Status: 400
Response data: {
  "ok": false,
  "error": "Missing required fields"
}

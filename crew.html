// Cloudflare Worker for handling crew bookings
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // CORS headers
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, X-API-Key',
  }

  // Handle preflight requests
  if (request.method === 'OPTIONS') {
    return new Response(null, {
      headers: corsHeaders
    })
  }

  // Only accept POST requests for trips
  if (request.method === 'POST' && request.url.endsWith('/api/trips')) {
    return handlePostRequest(request)
  }

  // Return 404 for other routes
  return new Response('Not found', { 
    status: 404,
    headers: {
      'Content-Type': 'application/json',
      ...corsHeaders
    }
  })
}

async function handlePostRequest(request) {
  try {
    // Optional: Validate API key
    const apiKey = request.headers.get('X-API-Key')
    const expectedApiKey = 'YOUR_SECURE_API_KEY' // Store in Cloudflare Secrets
    
    if (expectedApiKey && apiKey !== expectedApiKey) {
      return new Response(JSON.stringify({
        error: 'Unauthorized',
        message: 'Invalid API key'
      }), {
        status: 401,
        headers: {
          'Content-Type': 'application/json',
          'Access-Control-Allow-Origin': '*'
        }
      })
    }

    const payload = await request.json()
    
    // Validate required fields
    const requiredFields = [
      'created_by', 'rider_phone', 'pickup_text', 
      'dropoff_text', 'pickup_time_utc', 'flight_number',
      'airline', 'airport_code'
    ]
    
    for (const field of requiredFields) {
      if (!payload[field] || payload[field].trim() === '') {
        return new Response(JSON.stringify({
          error: 'Validation failed',
          message: `Missing required field: ${field}`
        }), {
          status: 400,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*'
          }
        })
      }
    }
    
    // Add metadata
    payload.worker_received_at = new Date().toISOString()
    payload.ip = request.headers.get('CF-Connecting-IP')
    payload.user_agent = request.headers.get('User-Agent')
    
    // Here you can:
    // 1. Store in Cloudflare KV
    // 2. Send to external API
    // 3. Send email notification
    // 4. Send WhatsApp message
    
    // Example: Store in Cloudflare KV
    // const tripsKV = TRIPS.get('trips')
    // const trips = tripsKV ? JSON.parse(tripsKV) : []
    // trips.push(payload)
    // await TRIPS.put('trips', JSON.stringify(trips))
    
    // Example: Send to external service (Twilio for WhatsApp, SendGrid for email, etc.)
    const externalResponse = await forwardToExternalService(payload)
    
    return new Response(JSON.stringify({
      ok: true,
      message: 'Booking received successfully',
      trip_id: generateTripId(),
      timestamp: new Date().toISOString(),
      external_response: externalResponse
    }), {
      status: 200,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    })
    
  } catch (error) {
    console.error('Error processing request:', error)
    
    return new Response(JSON.stringify({
      error: 'Internal server error',
      message: error.message
    }), {
      status: 500,
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*'
      }
    })
  }
}

async function forwardToExternalService(payload) {
  // Example: Forward to your main API
  try {
    const response = await fetch('https://api.travylway.com/api/trips', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload)
    })
    
    if (response.ok) {
      return { success: true, status: response.status }
    } else {
      return { 
        success: false, 
        status: response.status,
        error: await response.text()
      }
    }
  } catch (error) {
    return { success: false, error: error.message }
  }
}

function generateTripId() {
  return 'TRV-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9).toUpperCase()
}

// Example of sending WhatsApp notification
async function sendWhatsAppNotification(payload) {
  // Using Twilio API as example
  const accountSid = 'YOUR_TWILIO_SID'
  const authToken = 'YOUR_TWILIO_TOKEN'
  const client = require('twilio')(accountSid, authToken)
  
  try {
    const message = await client.messages.create({
      body: `New Crew Booking:\nName: ${payload.created_by}\nFlight: ${payload.airline} ${payload.flight_number}\nPickup: ${payload.pickup_text}\nTime: ${new Date(payload.pickup_time_utc).toLocaleString()}`,
      from: 'whatsapp:+14155238886', // Twilio WhatsApp number
      to: `whatsapp:${payload.rider_phone}`
    })
    return { success: true, message_sid: message.sid }
  } catch (error) {
    return { success: false, error: error.message }
  }
}

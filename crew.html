<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crew Booking - TravylWay</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

    body{
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:640px;
      background:#fff;
      border-radius:16px;
      padding:28px;
      box-shadow:0 10px 40px rgba(0,0,0,.22);
    }

    .badge{
      background: linear-gradient(135deg,#ffd700 0%,#ffed4e 100%);
      color:#222;
      padding:10px 18px;
      border-radius:999px;
      text-align:center;
      font-weight:800;
      margin-bottom:14px;
      letter-spacing:.2px;
    }

    h1{
      text-align:center;
      color:#222;
      margin-bottom:8px;
      font-size:28px;
    }

    .subhead{
      text-align:center;
      color:#555;
      margin-bottom:22px;
      font-size:14px;
      line-height:1.35;
    }

    .form-group{ margin-bottom:16px; position:relative; }

    label{
      display:block;
      font-weight:650;
      margin-bottom:6px;
      color:#222;
      font-size:14px;
    }

    input, textarea{
      width:100%;
      padding:12px 12px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:16px;
      transition: border-color .15s ease;
    }

    input:focus, textarea:focus{
      outline:none;
      border-color:#667eea;
    }

    textarea{ min-height:84px; resize:vertical; }

    .hint{
      margin-top:6px;
      font-size:12px;
      color:#666;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .btn{
      width:100%;
      padding:15px;
      background: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      margin-top:10px;
      transition: transform .2s ease, box-shadow .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    .btn:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }

    .btn:disabled{ background:#cfcfcf; cursor:not-allowed; }

    .btn.secondary{
      background:#111827;
      font-size:16px;
      padding:12px;
      margin-top:0;
    }

    .quote-box{
      margin-top:10px;
      padding:12px;
      border:2px solid #eee;
      border-radius:12px;
      background:#fafafa;
      display:none;
    }

    .quote-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color:#222;
      margin-top:6px;
    }

    .quote-row strong{ font-size:16px; }

    .message{
      padding:14px;
      border-radius:10px;
      margin-top:14px;
      text-align:center;
      display:none;
      font-size:14px;
      line-height:1.35;
    }

    .success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

    .loading{
      display:inline-block;
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,.35);
      border-radius:50%;
      border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .hp{
      position:absolute !important;
      left:-9999px !important;
      width:1px; height:1px;
      overflow:hidden;
    }

    .footer-note{
      margin-top:16px;
      text-align:center;
      color:#666;
      font-size:12px;
    }

    /* Autocomplete mount (hidden unless toggled on) */
    .places-host{
      width:100%;
      border:2px solid #ddd;
      border-radius:10px;
      padding:6px;
      background:#fff;
      transition: border-color .15s ease;
      margin-top:10px;
      display:none;
    }
    .places-host:focus-within{ border-color:#667eea; }

    .mini-actions{
      display:flex;
      gap:10px;
      margin-top:8px;
    }

    .mini-btn{
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#111827;
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      line-height:1;
    }
    .mini-btn:hover{ background:#f3f4f6; }
    .mini-btn.on{
      background:#111827;
      color:#fff;
      border-color:#111827;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="badge">‚úàÔ∏è AIRLINE CREW DISCOUNT</div>

    <h1>üöó Book Crew Ride</h1>
    <div class="subhead">
      Crew-only requests. Airport ‚Üî hotel runs. Reliable timing beats ‚Äúpretty apps.‚Äù
    </div>

    <form id="crewForm" autocomplete="on">
      <div class="hp">
        <label>Website</label>
        <input type="text" id="website" tabindex="-1" autocomplete="off" />
      </div>

      <div class="form-group">
        <label>Your Name *</label>
        <input type="text" id="name" required placeholder="Jane Doe" maxlength="80" />
      </div>

      <div class="form-group">
        <label>Phone Number *</label>
        <input type="tel" id="phone" required placeholder="+1 (720) 555-1234" maxlength="24" />
        <div class="hint">Used for confirmation + driver coordination.</div>
      </div>

      <!-- PICKUP -->
      <div class="form-group">
        <label>Pickup Address *</label>

        <input type="text" id="pickup_visible" required placeholder="Denver International Airport (DEN)" maxlength="140" />
        <input type="hidden" id="pickup" />

        <div class="mini-actions">
          <button type="button" class="mini-btn" id="pickupToggle">Use autocomplete</button>
        </div>

        <div id="pickupAutocompleteMount" class="places-host"></div>

        <div class="hint">Tip: include terminal/door if relevant.</div>
      </div>

      <!-- DROPOFF -->
      <div class="form-group">
        <label>Dropoff Address *</label>

        <input type="text" id="dropoff_visible" required placeholder="Hotel name + address" maxlength="140" />
        <input type="hidden" id="dropoff" />

        <div class="mini-actions">
          <button type="button" class="mini-btn" id="dropoffToggle">Use autocomplete</button>
        </div>

        <div id="dropoffAutocompleteMount" class="places-host"></div>
      </div>

      <div class="grid">
        <div class="form-group">
          <label>Pickup Date *</label>
          <input type="date" id="date" required />
        </div>

        <div class="form-group">
          <label>Pickup Time (local) *</label>
          <input type="time" id="time" required />
        </div>
      </div>

      <div class="grid">
        <div class="form-group">
          <label>Flight Number (optional)</label>
          <input type="text" id="flight" placeholder="UA1234" maxlength="10" />
        </div>

        <div class="form-group">
          <label>Airport Code (optional)</label>
          <input type="text" id="airport" placeholder="DEN" maxlength="4" />
          <div class="hint">3‚Äì4 letters (IATA/ICAO). Example: DEN / KDEN</div>
        </div>
      </div>

      <div class="form-group">
        <label>Airline (optional)</label>
        <input type="text" id="airline" placeholder="United Airlines" maxlength="60" />
      </div>

      <div class="form-group">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Crew count, bags, special pickup notes..."></textarea>
      </div>

      <!-- Quote controls -->
      <div class="form-group">
        <button type="button" class="btn secondary" id="quoteBtn">
          <span id="quoteText">Calculate Fare</span>
          <span class="loading" id="quoteSpinner" style="display:none;"></span>
        </button>

        <div id="quoteBox" class="quote-box">
          <div class="quote-row"><span>Distance</span><span id="quoteMiles">‚Äî</span></div>
          <div class="quote-row"><span>Duration</span><span id="quoteMinutes">‚Äî</span></div>
          <div class="quote-row"><span>Discount</span><span id="quoteDiscount">‚Äî</span></div>
          <div class="quote-row"><strong>Total</strong><strong id="quoteTotal">‚Äî</strong></div>
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn">
        <span id="submitText">Submit Crew Booking</span>
        <span class="loading" id="loadingSpinner" style="display:none;"></span>
      </button>
    </form>

    <div id="message" class="message"></div>

    <div class="footer-note">
      By submitting, you confirm you are airline crew and agree to crew-only verification if requested.
    </div>
  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https://api.travylway.com';

    /**
     * üîê DO NOT hardcode keys in HTML in production.
     * Option A: Inject at build time (replace __GMAPS_KEY__).
     * Option B: Leave blank to disable autocomplete safely.
     */
    const GOOGLE_BROWSER_KEY = "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo"; // set to your real key during deploy

    const form = document.getElementById('crewForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const messageDiv = document.getElementById('message');

    const phoneEl = document.getElementById('phone');
    const airportEl = document.getElementById('airport');
    const flightEl = document.getElementById('flight');
    const dateEl = document.getElementById('date');
    const timeEl = document.getElementById('time');

    const pickupVisibleEl = document.getElementById('pickup_visible');
    const dropoffVisibleEl = document.getElementById('dropoff_visible');
    const pickupEl = document.getElementById('pickup');
    const dropoffEl = document.getElementById('dropoff');

    const pickupMount = document.getElementById("pickupAutocompleteMount");
    const dropoffMount = document.getElementById("dropoffAutocompleteMount");
    const pickupToggle = document.getElementById("pickupToggle");
    const dropoffToggle = document.getElementById("dropoffToggle");

    const quoteBtn = document.getElementById('quoteBtn');
    const quoteText = document.getElementById('quoteText');
    const quoteSpinner = document.getElementById('quoteSpinner');
    const quoteBox = document.getElementById('quoteBox');
    const quoteMilesEl = document.getElementById('quoteMiles');
    const quoteMinutesEl = document.getElementById('quoteMinutes');
    const quoteDiscountEl = document.getElementById('quoteDiscount');
    const quoteTotalEl = document.getElementById('quoteTotal');

    let latestEstimatedFare = 0;

    function showMessage(type, text) {
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
    }

    function setQuoteUIVisible(visible) {
      quoteBox.style.display = visible ? 'block' : 'none';
    }

    function formatMoney(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "‚Äî";
      return `$${x.toFixed(2)}`;
    }

    function toUtcIsoFromLocalDateAndTime(dateStr, timeStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const [hh, min] = timeStr.split(':').map(Number);
      const localDate = new Date(y, (m - 1), d, hh, min, 0);
      return localDate.toISOString();
    }

    function isValidAirportCodeOrBlank(code) {
      if (!code) return true;
      return /^[A-Z]{3,4}$/.test(code);
    }

    function syncHiddenFromVisible() {
      pickupEl.value = pickupVisibleEl.value.trim();
      dropoffEl.value = dropoffVisibleEl.value.trim();
    }
    pickupVisibleEl.addEventListener("input", syncHiddenFromVisible);
    dropoffVisibleEl.addEventListener("input", syncHiddenFromVisible);

    function setMinDateToToday() {
      const now = new Date();
      const localYMD = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      dateEl.min = localYMD;
    }
    setMinDateToToday();
    document.addEventListener("visibilitychange", () => { if (!document.hidden) setMinDateToToday(); });
    dateEl.addEventListener("focus", setMinDateToToday);

    phoneEl.addEventListener('input', function() {
      this.value = this.value.replace(/[^\d+()\s-]/g, '');
    });
    airportEl.addEventListener('input', function() {
      this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '');
    });
    flightEl.addEventListener('input', function() {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    async function fetchQuote() {
      syncHiddenFromVisible();
      const pickup = pickupEl.value.trim();
      const dropoff = dropoffEl.value.trim();
      if (!pickup || !dropoff) throw new Error("Pickup and dropoff are required to calculate fare.");

      const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/quote`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ pickup_text: pickup, dropoff_text: dropoff, rider_type: "CREW" }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data?.ok) {
        const msg = data?.error || data?.message || `HTTP ${res.status}: ${res.statusText}`;
        throw new Error(msg);
      }
      return data;
    }

    quoteBtn.addEventListener("click", async () => {
      try {
        quoteBtn.disabled = true;
        quoteText.style.display = "none";
        quoteSpinner.style.display = "inline-block";
        messageDiv.style.display = "none";

        const q = await fetchQuote();

        const miles = Number(q?.miles ?? 0);
        const minutes = Number(q?.minutes ?? 0);
        const discount = Number(q?.estimate?.discount ?? 0);
        const total = Number(q?.estimate?.total ?? 0);

        latestEstimatedFare = Number.isFinite(total) ? total : 0;

        quoteMilesEl.textContent = `${miles.toFixed(2)} mi`;
        quoteMinutesEl.textContent = `${minutes.toFixed(0)} min`;
        quoteDiscountEl.textContent = formatMoney(discount);
        quoteTotalEl.textContent = formatMoney(total);

        setQuoteUIVisible(true);
      } catch (err) {
        setQuoteUIVisible(false);
        latestEstimatedFare = 0;
        showMessage('error', `‚ùå Fare quote error: ${err.message}`);
      } finally {
        quoteBtn.disabled = false;
        quoteText.style.display = "inline";
        quoteSpinner.style.display = "none";
      }
    });

    function loadGoogleMapsJs(key) {
      return new Promise((resolve, reject) => {
        if (window.google && window.google.maps && window.google.maps.places) {
          resolve();
          return;
        }
        const existing = document.querySelector('script[data-gmaps="1"]');
        if (existing) {
          existing.addEventListener("load", () => resolve());
          existing.addEventListener("error", () => reject(new Error("Google Maps script failed to load")));
          return;
        }
        const s = document.createElement("script");
        s.dataset.gmaps = "1";
        s.async = true;
        s.defer = true;
        s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(key)}&libraries=places&v=weekly`;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Google Maps script failed to load"));
        document.head.appendChild(s);
      });
    }

    let placesReady = false;
    let pickupAutoInput, dropoffAutoInput;

    function hasRealGoogleKey() {
      const k = (GOOGLE_BROWSER_KEY || "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo").trim();
      if (!k) return false;
      if (k === "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo") return false;
      // quick sanity check: Google API keys usually start with "AIza"
      if (!k.startsWith("AIza")) return false;
      return true;
    }

    async function ensurePlacesReady() {
      if (placesReady) return true;

      if (!hasRealGoogleKey()) {
        showMessage("error", "‚ùå Autocomplete is OFF (no Google browser key injected).");
        return false;
      }

      await loadGoogleMapsJs(GOOGLE_BROWSER_KEY);

      // Create plain inputs inside the mount containers
      pickupMount.innerHTML = `<input id="pickup_auto" type="text" placeholder="Search pickup‚Ä¶" />`;
      dropoffMount.innerHTML = `<input id="dropoff_auto" type="text" placeholder="Search dropoff‚Ä¶" />`;

      pickupAutoInput = document.getElementById("pickup_auto");
      dropoffAutoInput = document.getElementById("dropoff_auto");

      // Style match
      [pickupAutoInput, dropoffAutoInput].forEach(el => {
        el.style.width = "100%";
        el.style.border = "0";
        el.style.outline = "none";
        el.style.fontSize = "16px";
        el.style.padding = "8px 6px";
      });

      const pickupAC = new google.maps.places.Autocomplete(pickupAutoInput, {
        fields: ["formatted_address"],
        componentRestrictions: { country: "us" }
      });

      const dropoffAC = new google.maps.places.Autocomplete(dropoffAutoInput, {
        fields: ["formatted_address"],
        componentRestrictions: { country: "us" }
      });

      pickupAC.addListener("place_changed", () => {
        const place = pickupAC.getPlace();
        const addr = place?.formatted_address || pickupAutoInput.value || "";
        if (addr) {
          pickupVisibleEl.value = addr;
          pickupEl.value = addr;
          setQuoteUIVisible(false);
        }
      });

      dropoffAC.addListener("place_changed", () => {
        const place = dropoffAC.getPlace();
        const addr = place?.formatted_address || dropoffAutoInput.value || "";
        if (addr) {
          dropoffVisibleEl.value = addr;
          dropoffEl.value = addr;
          setQuoteUIVisible(false);
        }
      });

      placesReady = true;
      return true;
    }

    async function toggleAutocomplete(which) {
      const ok = await ensurePlacesReady();
      if (!ok) return;

      if (which === "pickup") {
        const on = pickupMount.style.display !== "block";
        pickupMount.style.display = on ? "block" : "none";
        pickupToggle.classList.toggle("on", on);
        pickupToggle.textContent = on ? "Hide autocomplete" : "Use autocomplete";
        if (on && pickupAutoInput) pickupAutoInput.focus();
      } else {
        const on = dropoffMount.style.display !== "block";
        dropoffMount.style.display = on ? "block" : "none";
        dropoffToggle.classList.toggle("on", on);
        dropoffToggle.textContent = on ? "Hide autocomplete" : "Use autocomplete";
        if (on && dropoffAutoInput) dropoffAutoInput.focus();
      }
    }

    pickupToggle.addEventListener("click", () => toggleAutocomplete("pickup"));
    dropoffToggle.addEventListener("click", () => toggleAutocomplete("dropoff"));

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const hp = document.getElementById('website').value.trim();
      if (hp) {
        showMessage('error', '‚ùå Submission blocked.');
        return;
      }

      syncHiddenFromVisible();

      const airportCode = airportEl.value.trim().toUpperCase();
      if (!isValidAirportCodeOrBlank(airportCode)) {
        showMessage('error', '‚ùå Airport code must be blank or 3‚Äì4 letters (DEN or KDEN).');
        return;
      }

      const dateVal = dateEl.value;
      const timeVal = timeEl.value;
      if (!dateVal || !timeVal) {
        showMessage('error', '‚ùå Pickup date and time are required.');
        return;
      }

      if (!pickupEl.value.trim() || !dropoffEl.value.trim()) {
        showMessage('error', '‚ùå Pickup and dropoff addresses are required.');
        return;
      }

      submitBtn.disabled = true;
      submitText.style.display = 'none';
      loadingSpinner.style.display = 'inline-block';
      messageDiv.style.display = 'none';

      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const pickupTimeUTC = toUtcIsoFromLocalDateAndTime(dateVal, timeVal);

      const payload = {
        created_by: document.getElementById('name').value.trim(),
        rider_phone: phoneEl.value.trim(),
        rider_type: 'CREW',
        pickup_text: pickupEl.value.trim(),
        dropoff_text: dropoffEl.value.trim(),
        pickup_time_utc: pickupTimeUTC,
        pickup_timezone: timezone,

        flight_number: (flightEl.value || "").trim(),
        airline: (document.getElementById('airline').value || "").trim(),
        airport_code: airportCode,

        notes: document.getElementById('notes').value.trim(),
        estimated_fare: Number(latestEstimatedFare || 0),

        timestamp: new Date().toISOString(),
        source: 'crew.html'
      };

      try {
        const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/trips`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if (res.ok && data?.ok) {
          const confirmationId = data?.id || 'N/A';
          showMessage('success', `‚úÖ Crew booking submitted! Confirmation ID: ${confirmationId}. Dispatch will confirm shortly.`);

          form.reset();
          setMinDateToToday();

          // Hard reset + sync so hidden fields are definitely empty
          pickupVisibleEl.value = "";
          dropoffVisibleEl.value = "";
          pickupEl.value = "";
          dropoffEl.value = "";

          latestEstimatedFare = 0;
          setQuoteUIVisible(false);
        } else {
          const msg = data?.error || data?.message || `HTTP ${res.status}: ${res.statusText}`;
          throw new Error(msg);
        }
      } catch (err) {
        showMessage('error', `‚ùå Error: ${err.message}`);
      } finally {
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
      }
    });
  </script>
</body>
</html>

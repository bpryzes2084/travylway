<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travylway — Driver Board</title>
  <meta name="description" content="Driver Board for viewing open pickup requests by airport." />

  <style>
    :root { --bg:#0b1c2d; --card:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --accent:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#f6f7fb;color:var(--ink)}
    header{background:var(--bg);color:#fff;position:sticky;top:0;z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{font-weight:900;letter-spacing:.2px}
    .subtitle{opacity:.8;font-size:13px}
    .panel{background:#fff;border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.06);margin-top:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{font-size:12px;color:var(--muted);font-weight:700}
    input,select,button{padding:10px 12px;border:1px solid #d7dbe7;border-radius:12px;background:#fff;font-size:14px}
    button{cursor:pointer;border:0;background:#111;color:#fff;font-weight:900}
    button.secondary{background:#fff;color:#111;border:1px solid #d7dbe7}
    .grow{flex:1 1 160px}
    .meta{font-size:12px;color:var(--muted);margin-top:8px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .msg{margin-top:14px}
    .ok{background:#ecfdf5;border:1px solid #bbf7d0;color:#166534;padding:10px 12px;border-radius:12px}
    .err{background:#fff1f2;border:1px solid #fecdd3;color:#9f1239;padding:10px 12px;border-radius:12px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.06)}
    .topline{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .badge{font-size:12px;padding:5px 10px;border-radius:999px;background:#eef2ff;color:#243bff;font-weight:900}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-top:10px;font-size:14px}
    .k{color:var(--muted)}
    .v{color:var(--ink)}
    a{color:inherit}
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div>
          <div class="title">Travylway — Driver Board</div>
          <div class="subtitle">Enter an airport code (DEN, LAX, etc.) to view open trips.</div>
        </div>
        <div style="font-weight:800;font-size:13px;opacity:.85">Live backend: travylway-api</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <div class="row">
        <div class="grow">
          <label for="airport">Airport</label><br/>
          <input id="airport" placeholder="DEN" autocomplete="off" />
        </div>

        <div>
          <label for="status">Status</label><br/>
          <select id="status">
            <option value="OPEN" selected>OPEN</option>
            <option value="CLAIMED">CLAIMED</option>
            <option value="COMPLETED">COMPLETED</option>
            <option value="CANCELLED">CANCELLED</option>
          </select>
        </div>

        <div>
          <label for="refresh">Refresh</label><br/>
          <select id="refresh">
            <option value="0">Off</option>
            <option value="5" selected>Every 5s</option>
            <option value="10">Every 10s</option>
            <option value="20">Every 20s</option>
          </select>
        </div>

        <div>
          <button id="loadBtn">Load Trips</button>
          <button class="secondary" id="clearBtn">Clear</button>
        </div>
      </div>

      <div class="meta">
        <div id="lastUpdate">—</div>
        <div style="opacity:.85">API: <a href="https://travylway-api.benterpryzes2084.workers.dev" target="_blank" rel="noopener">workers.dev</a></div>
      </div>
    </div>

    <div class="msg" id="msg"></div>
    <div class="grid" id="grid"></div>
  </main>

<script>
  const API_BASE = "https://travylway-api.benterpryzes2084.workers.dev";
  const el = (id) => document.getElementById(id);
  let timer = null;

  function setMsg(text, kind) {
    const box = el("msg");
    if (!text) { box.innerHTML = ""; return; }
    box.innerHTML = `<div class="${kind}">${escapeHtml(text)}</div>`;
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function fmtTime(iso) {
    if (!iso) return "—";
    try { return new Date(iso).toLocaleString(); } catch { return iso; }
  }

  async function loadTrips() {
    const airport = el("airport").value.trim().toUpperCase();
    if (!airport) {
      el("grid").innerHTML = "";
      setMsg("Enter an airport code to load trips.", "ok");
      return;
    }

    const status = el("status").value.trim().toUpperCase();
    const url = new URL(API_BASE + "/api/trips");
    url.searchParams.set("airport", airport);
    url.searchParams.set("status", status);

    try {
      const res = await fetch(url.toString(), { method: "GET" });
      const data = await res.json();

      if (!res.ok || !data.ok) {
        setMsg("API error: " + (data.error || res.statusText || "unknown"), "err");
        return;
      }

      renderTrips(data.trips || []);
      el("lastUpdate").textContent = "Last update: " + new Date().toLocaleTimeString();

      if ((data.trips || []).length === 0) setMsg("No trips found for this filter.", "ok");
      else setMsg("", "");
    } catch (e) {
      console.error(e);
      setMsg("Network/API error. Check connectivity and API availability.", "err");
    }
  }

  function renderTrips(trips) {
    const grid = el("grid");
    grid.innerHTML = "";

    for (const t of trips) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="topline">
          <div>
            <div style="font-weight:900;">
              ${escapeHtml(t.airport_code || "—")} — ${escapeHtml(t.direction || t.trip_type || "TRIP")}
            </div>
            <div style="font-size:12px;color:#64748b">Trip ID: ${escapeHtml(t.id)}</div>
          </div>
          <div class="badge">${escapeHtml(t.status || "—")}</div>
        </div>

        <div class="kv">
          <div class="k">Pickup time</div><div class="v">${escapeHtml(fmtTime(t.pickup_time_utc))}</div>
          <div class="k">Pickup</div><div class="v">${escapeHtml(t.pickup_text)}</div>
          <div class="k">Dropoff</div><div class="v">${escapeHtml(t.dropoff_text)}</div>
          <div class="k">Flight</div><div class="v">${escapeHtml(t.flight_number || "—")} ${t.airline ? "(" + escapeHtml(t.airline) + ")" : ""}</div>
          <div class="k">Notes</div><div class="v">${escapeHtml(t.notes || "—")}</div>
          <div class="k">Created by</div><div class="v">${escapeHtml(t.created_by || "—")}</div>
          <div class="k">Created at</div><div class="v">${escapeHtml(fmtTime(t.created_at))}</div>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  function setAutoRefresh() {
    const seconds = parseInt(el("refresh").value, 10);
    if (timer) clearInterval(timer);
    timer = null;
    if (seconds > 0) timer = setInterval(loadTrips, seconds * 1000);
  }

  el("loadBtn").addEventListener("click", () => { loadTrips(); setAutoRefresh(); });
  el("clearBtn").addEventListener("click", () => { el("grid").innerHTML=""; setMsg("", ""); });
  el("refresh").addEventListener("change", setAutoRefresh);

  // Don’t auto-load until airport is entered (prevents pointless calls)
  setMsg("Enter an airport code to load trips.", "ok");
</script>
</body>
</html>

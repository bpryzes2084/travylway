<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Driver Login - Travylway</title>

<style>
:root{
  --bg:#2B3A4A;
  --accent:#2563EB;
  --text:#0F172A;
  --light:#E5E7EB;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--light);
  display:flex;
  align-items:center;
  justify-content:center;
  min-height:100vh;
  padding:1rem;
}

.login-container{
  max-width:450px;
  width:100%;
}

.login-card{
  background:white;
  border-radius:20px;
  padding:2.5rem;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  color:var(--text);
}

.login-header{
  text-align:center;
  margin-bottom:2rem;
}

.login-header h1{
  font-size:2rem;
  margin-bottom:0.5rem;
  color:#333;
}

.login-header p{
  color:#666;
  font-size:0.95rem;
}

.form-group{
  margin-bottom:1.5rem;
}

.form-group label{
  display:block;
  font-weight:700;
  margin-bottom:0.5rem;
  color:#333;
  font-size:0.95rem;
}

.form-group input,
.form-group select{
  width:100%;
  padding:0.85rem;
  border:2px solid #e0e0e0;
  border-radius:10px;
  font-size:1rem;
  transition:border-color 0.3s ease;
  background:white;
}

.form-group input:focus,
.form-group select:focus{
  outline:none;
  border-color:#667eea;
}

.btn-primary{
  width:100%;
  padding:1rem;
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  border:none;
  border-radius:12px;
  font-size:1.1rem;
  font-weight:900;
  cursor:pointer;
  transition:all 0.3s ease;
  text-transform:uppercase;
}

.btn-primary:hover{
  transform:translateY(-2px);
  box-shadow:0 10px 30px rgba(102,126,234,0.4);
}

.btn-primary:disabled{
  background:#ccc;
  cursor:not-allowed;
  transform:none;
}

.btn-secondary{
  width:100%;
  padding:0.85rem;
  background:white;
  color:#667eea;
  border:2px solid #667eea;
  border-radius:12px;
  font-size:1rem;
  font-weight:900;
  cursor:pointer;
  transition:all 0.3s ease;
  margin-top:1rem;
}

.btn-secondary:hover{
  background:#667eea;
  color:white;
}

.tabs{
  display:flex;
  margin-bottom:2rem;
  border-bottom:2px solid #e0e0e0;
}

.tab{
  flex:1;
  padding:1rem;
  text-align:center;
  cursor:pointer;
  font-weight:700;
  color:#666;
  border-bottom:3px solid transparent;
  margin-bottom:-2px;
  transition:.3s;
}

.tab.active{
  color:#667eea;
  border-bottom-color:#667eea;
}

.tab:hover{
  color:#667eea;
}

.tab-content{
  display:none;
}

.tab-content.active{
  display:block;
}

.message{
  padding:1rem;
  border-radius:10px;
  margin-bottom:1.5rem;
  text-align:center;
  font-weight:600;
  display:none;
}

.success{
  background:#d4edda;
  color:#155724;
  border:1px solid #c3e6cb;
}

.error{
  background:#f8d7da;
  color:#721c24;
  border:1px solid #f5c6cb;
}

.info{
  background:#d1ecf1;
  color:#0c5460;
  border:1px solid #bee5eb;
}

.back-link{
  display:block;
  text-align:center;
  margin-top:1.5rem;
  color:#667eea;
  text-decoration:none;
  font-weight:600;
}

.back-link:hover{
  text-decoration:underline;
}

.required{
  color:#ff6b6b;
}

input[type="checkbox"]{
  width:18px;
  height:18px;
  cursor:pointer;
}

.code-input{
  font-size:1.5rem;
  text-align:center;
  letter-spacing:0.5rem;
  font-weight:700;
}

.resend-link{
  text-align:center;
  margin-top:1rem;
  font-size:0.9rem;
}

.resend-link a{
  color:#667eea;
  text-decoration:none;
  cursor:pointer;
}

.resend-link a:hover{
  text-decoration:underline;
}
</style>
</head>

<body>
<div class="login-container">
  <div class="login-card">
    <div class="login-header">
      <h1>üöó Driver Portal</h1>
      <p>Login or register to access the driver board</p>
    </div>

    <div class="tabs">
      <div class="tab active" onclick="switchTab('login')">Login</div>
      <div class="tab" onclick="switchTab('register')">Register</div>
    </div>

    <div id="successMessage" class="message success"></div>
    <div id="errorMessage" class="message error"></div>
    <div id="infoMessage" class="message info"></div>

    <!-- LOGIN TAB -->
    <div id="loginTab" class="tab-content active">
      <!-- Step 1: Enter Phone & Password -->
      <form id="loginForm" style="display:block;">
        <div class="form-group">
          <label for="loginPhone">Phone Number</label>
          <input type="tel" id="loginPhone" name="phone" placeholder="(555) 123-4567" required>
        </div>

        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" name="password" placeholder="Enter your password" required>
        </div>

        <button type="submit" class="btn-primary" id="loginBtn">Continue to 2FA</button>
      </form>

      <!-- Step 2: Enter 2FA Code -->
      <div id="twoFactorForm" style="display:none;">
        <div class="form-group">
          <label for="verificationCode">Enter 6-Digit Code</label>
          <input type="text" id="verificationCode" class="code-input" maxlength="6" placeholder="000000" required>
          <div class="info" style="display:block;margin-top:1rem;">
            üì± A verification code has been sent to your phone via WhatsApp
          </div>
        </div>

        <button type="button" class="btn-primary" id="verifyBtn" onclick="verifyCode()">Verify & Login</button>
        
        <div class="resend-link">
          <a onclick="resendCode()">Didn't receive code? Resend</a>
        </div>

        <button type="button" class="btn-secondary" onclick="backToLogin()">‚Üê Back to Login</button>
      </div>
    </div>

    <!-- REGISTER TAB -->
    <div id="registerTab" class="tab-content">
      <form id="registerForm">
        <!-- Personal Information -->
        <div class="form-group">
          <label for="registerName">Full Name <span class="required">*</span></label>
          <input type="text" id="registerName" name="name" placeholder="John Doe" required>
        </div>

        <div class="form-group">
          <label for="registerPhone">Phone Number <span class="required">*</span></label>
          <input type="tel" id="registerPhone" name="phone" placeholder="(555) 123-4567" required>
        </div>

        <div class="form-group">
          <label for="registerEmail">Email <span class="required">*</span></label>
          <input type="email" id="registerEmail" name="email" placeholder="driver@example.com" required>
        </div>

        <div class="form-group">
          <label for="registerPassword">Password <span class="required">*</span></label>
          <input type="password" id="registerPassword" name="password" placeholder="Create a password" required minlength="6">
        </div>

        <!-- Demographics -->
        <div class="form-group">
          <label for="registerEthnicity">Ethnicity <span class="required">*</span></label>
          <select id="registerEthnicity" name="ethnicity" required>
            <option value="">Select ethnicity</option>
            <option value="American Indian or Alaska Native">American Indian or Alaska Native</option>
            <option value="Asian">Asian</option>
            <option value="Black or African American">Black or African American</option>
            <option value="Hispanic or Latino">Hispanic or Latino</option>
            <option value="Native Hawaiian or Pacific Islander">Native Hawaiian or Pacific Islander</option>
            <option value="White">White</option>
            <option value="Two or More Races">Two or More Races</option>
            <option value="Prefer not to say">Prefer not to say</option>
          </select>
        </div>

        <div class="form-group">
          <label for="registerVeteran">Veteran Status <span class="required">*</span></label>
          <select id="registerVeteran" name="veteranStatus" required>
            <option value="">Select status</option>
            <option value="Veteran">Veteran</option>
            <option value="Active Duty">Active Duty Military</option>
            <option value="Not a Veteran">Not a Veteran</option>
            <option value="Prefer not to say">Prefer not to say</option>
          </select>
        </div>

        <!-- Payout Method -->
        <div class="form-group">
          <label for="registerPayout">Preferred Payout Method <span class="required">*</span></label>
          <select id="registerPayout" name="payoutMethod" required>
            <option value="">Select payout method</option>
            <option value="Venmo">Venmo</option>
            <option value="Cash App">Cash App</option>
            <option value="PayPal">PayPal</option>
          </select>
        </div>

        <div class="form-group">
          <label for="registerPayoutAccount">Payout Account (Username/Email) <span class="required">*</span></label>
          <input type="text" id="registerPayoutAccount" name="payoutAccount" placeholder="@username or email" required>
        </div>

        <!-- Driving Experience -->
        <div class="form-group">
          <label for="registerExperience">Years of Driving Experience <span class="required">*</span></label>
          <select id="registerExperience" name="yearsExperience" required>
            <option value="">Select years</option>
            <option value="Less than 1">Less than 1 year</option>
            <option value="1-2">1-2 years</option>
            <option value="3-5">3-5 years</option>
            <option value="6-10">6-10 years</option>
            <option value="11-15">11-15 years</option>
            <option value="16-20">16-20 years</option>
            <option value="20+">20+ years</option>
          </select>
        </div>

        <!-- Other Platforms -->
        <div class="form-group">
          <label>Do you drive for any of these platforms? (Check all that apply)</label>
          <div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.5rem;">
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="Uber"> Uber
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="Lyft"> Lyft
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="DoorDash"> DoorDash
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="Uber Eats"> Uber Eats
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="Grubhub"> Grubhub
            </label>
            <label style="display:flex;align-items:center;gap:0.5rem;font-weight:normal;">
              <input type="checkbox" name="platforms" value="None"> None of the above
            </label>
          </div>
        </div>

        <!-- Notice -->
        <div style="background:#fff3cd;padding:1rem;border-radius:8px;margin:1.5rem 0;border-left:3px solid #ffc107;">
          <p style="margin:0;color:#856404;font-size:0.9rem;">
            <strong>üìã Note:</strong> You have 90 days from registration to submit your vehicle information and insurance documentation. You can add these details later in your driver profile.
          </p>
        </div>

        <!-- Terms -->
        <div class="form-group">
          <label style="display:flex;align-items:start;gap:0.5rem;font-weight:normal;">
            <input type="checkbox" name="terms" required style="width:auto;margin-top:0.25rem;">
            <span>I agree to the Terms of Service and Privacy Policy <span class="required">*</span></span>
          </label>
        </div>

        <button type="submit" class="btn-primary" id="registerBtn">Register</button>
      </form>
    </div>

    <a href="/" class="back-link">‚Üê Back to Home</a>
  </div>
</div>

<script>
const WORKER_URL = 'https://travylway-api.benterpryzes2084.workers.dev';
let tempLoginData = {};

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  if (tab === 'login') {
    document.querySelector('.tab:first-child').classList.add('active');
    document.getElementById('loginTab').classList.add('active');
  } else {
    document.querySelector('.tab:last-child').classList.add('active');
    document.getElementById('registerTab').classList.add('active');
  }
  
  hideMessages();
}

function showSuccess(message) {
  const msg = document.getElementById('successMessage');
  msg.textContent = message;
  msg.style.display = 'block';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showError(message) {
  const msg = document.getElementById('errorMessage');
  msg.textContent = message;
  msg.style.display = 'block';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function showInfo(message) {
  const msg = document.getElementById('infoMessage');
  msg.textContent = message;
  msg.style.display = 'block';
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('errorMessage').style.display = 'none';
}

function hideMessages() {
  document.getElementById('successMessage').style.display = 'none';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('infoMessage').style.display = 'none';
}

function backToLogin() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('twoFactorForm').style.display = 'none';
  hideMessages();
}

// LOGIN - Step 1: Send 2FA Code
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.disabled = true;
  loginBtn.textContent = 'Sending code...';
  hideMessages();
  
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  tempLoginData = data;
  
  try {
    const response = await fetch(WORKER_URL + '/driver-login-2fa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // Show 2FA form
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('twoFactorForm').style.display = 'block';
      showInfo('Verification code sent via WhatsApp!');
    } else {
      showError(result.error || 'Login failed. Please check your credentials.');
    }
  } catch (error) {
    showError('Login error. Please try again.');
  } finally {
    loginBtn.disabled = false;
    loginBtn.textContent = 'Continue to 2FA';
  }
});

// LOGIN - Step 2: Verify Code
async function verifyCode() {
  const verifyBtn = document.getElementById('verifyBtn');
  const code = document.getElementById('verificationCode').value;
  
  if (code.length !== 6) {
    showError('Please enter the 6-digit code');
    return;
  }
  
  verifyBtn.disabled = true;
  verifyBtn.textContent = 'Verifying...';
  hideMessages();
  
  try {
    const response = await fetch(WORKER_URL + '/driver-verify-2fa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        phone: tempLoginData.phone,
        code: code
      })
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      // Save driver session
      localStorage.setItem('driverId', result.driverId);
      localStorage.setItem('driverName', result.name);
      localStorage.setItem('driverPhone', result.phone);
      
      showSuccess('Login successful! Redirecting...');
      setTimeout(() => {
        window.location.href = '/driver.html';
      }, 1000);
    } else {
      showError(result.error || 'Invalid code. Please try again.');
    }
  } catch (error) {
    showError('Verification error. Please try again.');
  } finally {
    verifyBtn.disabled = false;
    verifyBtn.textContent = 'Verify & Login';
  }
}

// Resend Code
async function resendCode() {
  hideMessages();
  showInfo('Resending code...');
  
  try {
    const response = await fetch(WORKER_URL + '/driver-login-2fa', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(tempLoginData)
    });
    
    if (response.ok) {
      showSuccess('Code resent via WhatsApp!');
    } else {
      showError('Failed to resend code. Please try again.');
    }
  } catch (error) {
    showError('Error resending code.');
  }
}

// REGISTER
document.getElementById('registerForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const registerBtn = document.getElementById('registerBtn');
  registerBtn.disabled = true;
  registerBtn.textContent = 'Registering...';
  hideMessages();
  
  const formData = new FormData(e.target);
  
  // Handle checkboxes for platforms
  const platformCheckboxes = document.querySelectorAll('input[name="platforms"]:checked');
  const platforms = Array.from(platformCheckboxes).map(cb => cb.value);
  
  // Convert form data to object
  const data = {};
  for (let [key, value] of formData.entries()) {
    if (key !== 'platforms' && key !== 'terms') {
      data[key] = value;
    }
  }
  data.platforms = platforms;
  
  try {
    const response = await fetch(WORKER_URL + '/driver-register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      showSuccess('Registration successful! Please login. You have 90 days to submit vehicle and insurance info.');
      e.target.reset();
      setTimeout(() => {
        switchTab('login');
      }, 3000);
    } else {
      showError(result.error || 'Registration failed. Please try again.');
    }
  } catch (error) {
    showError('Registration error. Please try again.');
  } finally {
    registerBtn.disabled = false;
    registerBtn.textContent = 'Register';
  }
});
</script>

</body>
</html>

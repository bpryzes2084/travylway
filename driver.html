<script>
const WORKER_URL = 'https://travylway-api.benterpryzes2084.workers.dev';

// Get driver info from localStorage (set during login)
const driverId = localStorage.getItem('driverId') || 'TEMP_' + Date.now();
const driverName = localStorage.getItem('driverName') || 'Guest Driver';

// Load trips on page load
window.addEventListener('load', () => {
  // Check for URL filter parameter
  const urlParams = new URLSearchParams(window.location.search);
  const filter = urlParams.get('filter');
  
  // Set the filter dropdown based on URL
  if (filter === 'available') {
    document.getElementById('statusFilter').value = 'available';
  } else if (filter === 'claimed') {
    document.getElementById('statusFilter').value = 'claimed';
  } else if (filter === 'completed') {
    document.getElementById('statusFilter').value = 'completed';
  }
  
  loadTrips();
  // Auto-refresh every 30 seconds
  setInterval(loadTrips, 30000);
});

async function loadTrips() {
  const loadingState = document.getElementById('loadingState');
  const tripsGrid = document.getElementById('tripsGrid');
  const noTrips = document.getElementById('noTrips');
  
  loadingState.style.display = 'block';
  tripsGrid.style.display = 'none';
  noTrips.style.display = 'none';
  
  try {
    const response = await fetch(WORKER_URL + '/trips');
    const data = await response.json();
    
    if (data.trips && data.trips.length > 0) {
      displayTrips(data.trips);
      updateStats(data.trips);
      tripsGrid.style.display = 'grid';
    } else {
      noTrips.style.display = 'block';
    }
  } catch (error) {
    console.error('Error loading trips:', error);
    noTrips.style.display = 'block';
  } finally {
    loadingState.style.display = 'none';
  }
}

function displayTrips(trips) {
  const tripsGrid = document.getElementById('tripsGrid');
  const statusFilter = document.getElementById('statusFilter').value;
  const airportFilter = document.getElementById('airportFilter').value;
  const dateFilter = document.getElementById('dateFilter').value;
  
  // Filter trips
  let filteredTrips = trips.filter(trip => {
    if (statusFilter !== 'all' && trip.status !== statusFilter) return false;
    if (airportFilter !== 'all' && trip.airport !== airportFilter) return false;
    if (dateFilter && trip.flightDate !== dateFilter) return false;
    return true;
  });
  
  // Sort by date/time
  filteredTrips.sort((a, b) => {
    const dateA = new Date(a.flightDate + ' ' + a.flightTime);
    const dateB = new Date(b.flightDate + ' ' + b.flightTime);
    return dateA - dateB;
  });
  
  if (filteredTrips.length === 0) {
    noTrips.style.display = 'block';
    tripsGrid.style.display = 'none';
    return;
  }
  
  tripsGrid.innerHTML = filteredTrips.map(trip => {
    const isMyClaim = trip.claimedBy === driverId;
    const canClaim = trip.status === 'available';
    const canUnclaim = trip.status === 'claimed' && isMyClaim;
    const canComplete = trip.status === 'claimed' && isMyClaim;
    
    return `
      <div class="trip-card ${trip.status}">
        <div class="trip-header">
          <span class="trip-id">Trip #${trip.id}</span>
          <span class="trip-status status-${trip.status}">${trip.status.toUpperCase()}</span>
        </div>
        
        <div class="trip-details">
          <div class="detail-item">
            <span class="detail-icon">üë§</span>
            <div class="detail-content">
              <h4>Passenger</h4>
              <p>${trip.name}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üì±</span>
            <div class="detail-content">
              <h4>Phone</h4>
              <p>${trip.phone}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üìß</span>
            <div class="detail-content">
              <h4>Email</h4>
              <p>${trip.email || 'Not provided'}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">${trip.serviceType === 'pickup' ? 'üõ¨' : 'üõ´'}</span>
            <div class="detail-content">
              <h4>Service</h4>
              <p>${trip.serviceType === 'pickup' ? 'Airport Pickup' : 'Airport Drop-off'}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">‚úàÔ∏è</span>
            <div class="detail-content">
              <h4>Flight</h4>
              <p>${trip.airline} ${trip.flightNumber || ''}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üè¢</span>
            <div class="detail-content">
              <h4>Airport</h4>
              <p>${trip.airport}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üìÖ</span>
            <div class="detail-content">
              <h4>Date</h4>
              <p>${trip.flightDate}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üïê</span>
            <div class="detail-content">
              <h4>Time</h4>
              <p>${trip.flightTime}</p>
            </div>
          </div>
          
          <div class="detail-item">
            <span class="detail-icon">üë•</span>
            <div class="detail-content">
              <h4>Passengers</h4>
              <p>${trip.passengers || '1'}</p>
            </div>
          </div>
        </div>
        
        <div class="trip-address">
          <h4>üìç Address</h4>
          <p>${trip.address}</p>
        </div>
        
        ${trip.notes ? `
          <div class="trip-notes">
            <h4>üìù Notes</h4>
            <p>${trip.notes}</p>
          </div>
        ` : ''}
        
        <div class="trip-actions">
          ${canClaim ? `
            <button class="btn btn-claim" onclick="claimTrip('${trip.id}')">
              ‚úì Claim Trip
            </button>
          ` : ''}
          
          ${canUnclaim ? `
            <button class="btn btn-unclaim" onclick="unclaimTrip('${trip.id}')">
              ‚úó Unclaim
            </button>
          ` : ''}
          
          ${canComplete ? `
            <button class="btn btn-complete" onclick="completeTrip('${trip.id}')">
              ‚úì Mark Complete
            </button>
          ` : ''}
          
          <button class="btn btn-contact" onclick="contactPassenger('${trip.phone}')">
            üì± WhatsApp
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function updateStats(trips) {
  const available = trips.filter(t => t.status === 'available').length;
  const claimed = trips.filter(t => t.status === 'claimed').length;
  const completed = trips.filter(t => t.status === 'completed').length;
  
  document.getElementById('availableCount').textContent = available;
  document.getElementById('claimedCount').textContent = claimed;
  document.getElementById('completedCount').textContent = completed;
}

async function claimTrip(tripId) {
  try {
    const response = await fetch(WORKER_URL + '/claim', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tripId, driverId })
    });
    
    if (response.ok) {
      loadTrips();
    } else {
      alert('Failed to claim trip');
    }
  } catch (error) {
    console.error('Error claiming trip:', error);
    alert('Error claiming trip');
  }
}

async function unclaimTrip(tripId) {
  try {
    const response = await fetch(WORKER_URL + '/unclaim', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tripId })
    });
    
    if (response.ok) {
      loadTrips();
    } else {
      alert('Failed to unclaim trip');
    }
  } catch (error) {
    console.error('Error unclaiming trip:', error);
    alert('Error unclaiming trip');
  }
}

async function completeTrip(tripId) {
  try {
    const response = await fetch(WORKER_URL + '/complete', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tripId })
    });
    
    if (response.ok) {
      loadTrips();
    } else {
      alert('Failed to complete trip');
    }
  } catch (error) {
    console.error('Error completing trip:', error);
    alert('Error completing trip');
  }
}

function contactPassenger(phone) {
  const digits = phone.replace(/\D/g, '');
  window.open(`https://wa.me/${digits}`, '_blank');
}

// Apply filters
document.getElementById('statusFilter').addEventListener('change', loadTrips);
document.getElementById('airportFilter').addEventListener('change', loadTrips);
document.getElementById('dateFilter').addEventListener('change', loadTrips);
</script>

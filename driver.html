<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Driver Board - Travylway</title>
<style>
:root{
  --bg:#2B3A4A;
  --accent:#2563EB;
  --text:#0F172A;
  --light:#E5E7EB;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--light);
  padding:1rem;
}
.container{max-width:1200px;margin:0 auto}
h1{text-align:center;margin-bottom:2rem;color:white}
.trips-grid{
  display:grid;
  gap:1.5rem;
}
.trip-card{
  background:white;
  border-radius:16px;
  padding:1.5rem;
  color:var(--text);
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}
.trip-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
  padding-bottom:1rem;
  border-bottom:2px solid #e0e0e0;
}
.trip-id{
  font-weight:900;
  font-size:0.9rem;
  color:#667eea;
}
.status-badge{
  padding:0.5rem 1rem;
  border-radius:20px;
  font-weight:700;
  font-size:0.85rem;
  text-transform:uppercase;
}
.status-open{background:#e3f2fd;color:#1976d2}
.status-claimed{background:#fff3cd;color:#856404}
.status-en-route{background:#d1ecf1;color:#0c5460}
.status-complete{background:#d4edda;color:#155724}
.trip-details{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:1rem;
  margin-bottom:1.5rem;
}
.detail-item{
  display:flex;
  flex-direction:column;
  gap:0.25rem;
}
.detail-label{
  font-size:0.75rem;
  font-weight:700;
  color:#666;
  text-transform:uppercase;
}
.detail-value{
  font-size:1rem;
  font-weight:600;
  color:#333;
}
.trip-actions{
  display:flex;
  gap:0.75rem;
  flex-wrap:wrap;
}
.btn{
  padding:0.75rem 1.5rem;
  border:none;
  border-radius:10px;
  font-weight:900;
  font-size:0.9rem;
  cursor:pointer;
  transition:all 0.3s ease;
  text-decoration:none;
  display:inline-block;
  text-align:center;
}
.btn-primary{background:#667eea;color:white}
.btn-success{background:#25D366;color:white}
.btn-warning{background:#ffc107;color:#333}
.btn-complete{background:#28a745;color:white}
.btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.2)}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.loading{text-align:center;padding:3rem;color:white;font-size:1.2rem}
.error{background:#f8d7da;color:#721c24;padding:1rem;border-radius:10px;margin:1rem 0}
@media(max-width:768px){
  .trip-details{grid-template-columns:1fr}
  .trip-actions{flex-direction:column}
  .btn{width:100%}
}
</style>
</head>
<body>

<div class="container">
  <h1>ðŸš— Driver Board</h1>
  
  <div id="loading" class="loading">Loading trips...</div>
  <div id="error" class="error" style="display:none"></div>
  <div id="trips" class="trips-grid"></div>
</div>

<script>
const API_BASE = 'https://travylway-api.benterpryzes2084.workers.dev';

async function loadTrips() {
  try {
    const response = await fetch(`${API_BASE}/api/trips?status=OPEN`);
    const data = await response.json();
    
    document.getElementById('loading').style.display = 'none';
    
    if (data.ok && data.trips) {
      displayTrips(data.trips);
    } else {
      showError('Failed to load trips');
    }
  } catch (error) {
    document.getElementById('loading').style.display = 'none';
    showError('Error loading trips: ' + error.message);
  }
}

function displayTrips(trips) {
  const container = document.getElementById('trips');
  
  if (trips.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:white;padding:2rem">No open trips available</p>';
    return;
  }
  
  container.innerHTML = trips.map(trip => createTripCard(trip)).join('');
}

function createTripCard(trip) {
  const statusClass = `status-${(trip.status || 'open').toLowerCase().replace('_', '-')}`;
  const statusText = (trip.status || 'OPEN').replace('_', ' ');
  
  // Extract phone number from notes or use placeholder
  const phoneMatch = trip.rider_phone || '';
  const cleanPhone = phoneMatch.replace(/\D/g, '');
  const displayPhone = phoneMatch || 'No phone';
  
  return `
    <div class="trip-card">
      <div class="trip-header">
        <span class="trip-id">ID: ${trip.id.substring(0, 8)}</span>
        <span class="status-badge ${statusClass}">${statusText}</span>
      </div>
      
      <div class="trip-details">
        <div class="detail-item">
          <span class="detail-label">Passenger</span>
          <span class="detail-value">${trip.created_by || 'Unknown'}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Phone</span>
          <span class="detail-value">${displayPhone}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Rider Type</span>
          <span class="detail-value">${trip.rider_type || 'GENERAL'}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Pickup</span>
          <span class="detail-value">${trip.pickup_text || 'N/A'}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Dropoff</span>
          <span class="detail-value">${trip.dropoff_text || 'N/A'}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Time</span>
          <span class="detail-value">${formatDate(trip.pickup_time_utc)}</span>
        </div>
        
        <div class="detail-item">
          <span class="detail-label">Trip Type</span>
          <span class="detail-value">${trip.trip_type || 'N/A'}</span>
        </div>
      </div>
      
      ${trip.notes ? `<div style="background:#f8f9fa;padding:1rem;border-radius:8px;margin-bottom:1rem;font-size:0.9rem;white-space:pre-wrap">${trip.notes}</div>` : ''}
      
      <div class="trip-actions">
        <button class="btn btn-primary" onclick="claimTrip('${trip.id}')">
          Claim Trip
        </button>
        
        <a href="https://wa.me/1${cleanPhone}?text=${encodeURIComponent(`Hi ${trip.created_by}, I'm your Travylway driver. I've claimed your trip and will contact you shortly!`)}" 
           class="btn btn-success" 
           target="_blank">
          ðŸ“± Contact via WhatsApp
        </a>
        
        <button class="btn btn-warning" onclick="markEnRoute('${trip.id}', '${escapeQuotes(trip.created_by)}', '${escapeQuotes(trip.pickup_text)}', '${cleanPhone}')">
          ðŸš— En Route
        </button>
        
        <button class="btn btn-complete" onclick="markComplete('${trip.id}', '${escapeQuotes(trip.created_by)}', '${cleanPhone}')">
          âœ“ Complete Trip
        </button>
      </div>
    </div>
  `;
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit'
  });
}

function escapeQuotes(str) {
  return (str || '').replace(/'/g, "\\'").replace(/"/g, '\\"');
}

async function claimTrip(tripId) {
  const driverName = prompt('Enter your name:');
  if (!driverName) return;
  
  try {
    const response = await fetch(`${API_BASE}/api/trips/${tripId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        status: 'CLAIMED',
        driver_name: driverName
      })
    });
    
    const data = await response.json();
    
    if (data.ok) {
      alert('Trip claimed successfully!');
      loadTrips();
    } else {
      alert('Failed to claim trip: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error claiming trip: ' + error.message);
  }
}

function markEnRoute(tripId, passengerName, pickupAddress, phone) {
  // Update status in database
  fetch(`${API_BASE}/api/trips/${tripId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: 'EN_ROUTE' })
  }).then(response => response.json())
    .then(data => {
      if (data.ok) {
        // Open WhatsApp with en route message
        const message = `Hi ${passengerName}, I'm on my way to pick you up at ${pickupAddress}. I'll be there shortly!`;
        window.open(`https://wa.me/1${phone}?text=${encodeURIComponent(message)}`, '_blank');
        
        // Reload trips
        loadTrips();
      }
    })
    .catch(error => {
      alert('Error updating trip: ' + error.message);
    });
}

function markComplete(tripId, passengerName, phone) {
  if (!confirm('Mark this trip as complete?')) return;
  
  // Update status in database
  fetch(`${API_BASE}/api/trips/${tripId}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: 'COMPLETE' })
  }).then(response => response.json())
    .then(data => {
      if (data.ok) {
        // Open WhatsApp with completion message
        const message = `Thank you for riding with Travylway, ${passengerName}! Have a great day! ðŸš—âœ¨`;
        window.open(`https://wa.me/1${phone}?text=${encodeURIComponent(message)}`, '_blank');
        
        // Reload trips
        loadTrips();
      }
    })
    .catch(error => {
      alert('Error completing trip: ' + error.message);
    });
}

function showError(message) {
  const errorDiv = document.getElementById('error');
  errorDiv.textContent = message;
  errorDiv.style.display = 'block';
}

// Load trips on page load
loadTrips();

// Refresh every 30 seconds
setInterval(loadTrips, 30000);
</script>

</body>
</html>

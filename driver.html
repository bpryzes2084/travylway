<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Driver Board - Travylway</title>
<meta name="description" content="View available trips and claim pickups.">

<style>
:root{
  --bg:#2B3A4A;
  --accent:#2563EB;
  --text:#0F172A;
  --light:#E5E7EB;
  --muted:rgba(229,231,235,.82);
  --line:rgba(255,255,255,.10);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--light);
}

.container{
  max-width:1400px;
  margin:0 auto;
  padding:2rem 1rem;
}

.header{
  text-align:center;
  margin-bottom:2rem;
}

.header h1{
  font-size:2.5rem;
  margin-bottom:0.5rem;
}

.header p{
  font-size:1.1rem;
  opacity:0.9;
}

.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:1rem;
  margin-bottom:2rem;
}

.stat-card{
  background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
  border:1px solid var(--line);
  border-radius:16px;
  padding:1.5rem;
  text-align:center;
}

.stat-number{
  font-size:2.5rem;
  font-weight:900;
  margin-bottom:0.5rem;
}

.stat-label{
  font-size:0.9rem;
  opacity:0.8;
}

.available{color:#00D632}
.claimed{color:#667eea}
.completed{color:#FFD700}

.filter-bar{
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:16px;
  padding:1.5rem;
  margin-bottom:2rem;
  display:flex;
  gap:1rem;
  flex-wrap:wrap;
  align-items:center;
}

.filter-bar select,
.filter-bar input{
  padding:0.75rem;
  border:1px solid var(--line);
  border-radius:8px;
  background:rgba(255,255,255,.1);
  color:var(--light);
  font-size:0.95rem;
}

.filter-bar select:focus,
.filter-bar input:focus{
  outline:none;
  border-color:#667eea;
}

.filter-bar button{
  padding:0.75rem 1.5rem;
  background:#667eea;
  color:white;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  transition:.3s;
}

.filter-bar button:hover{
  background:#5568d3;
}

.trips-grid{
  display:grid;
  gap:1.5rem;
}

.trip-card{
  background:white;
  border-radius:16px;
  padding:1.5rem;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  color:var(--text);
  transition:.3s;
  border-left:4px solid transparent;
}

.trip-card.available{border-left-color:#00D632}
.trip-card.claimed{border-left-color:#667eea}
.trip-card.completed{border-left-color:#FFD700}

.trip-card:hover{
  transform:translateY(-3px);
  box-shadow:0 15px 40px rgba(0,0,0,.3);
}

.trip-header{
  display:flex;
  justify-content:space-between;
  align-items:start;
  margin-bottom:1rem;
  flex-wrap:wrap;
  gap:1rem;
}

.trip-id{
  font-size:0.85rem;
  color:#666;
  font-weight:700;
  word-break:break-all;
}

.trip-status{
  padding:0.4rem 1rem;
  border-radius:20px;
  font-size:0.85rem;
  font-weight:900;
  text-transform:uppercase;
}

.status-available{background:#d4edda;color:#155724}
.status-claimed{background:#cfe2ff;color:#084298}
.status-completed{background:#fff3cd;color:#856404}

.trip-details{
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
  gap:1rem;
  margin-bottom:1rem;
}

.detail-item{
  display:flex;
  align-items:start;
  gap:0.5rem;
}

.detail-icon{
  font-size:1.2rem;
  margin-top:0.2rem;
}

.detail-content h4{
  font-size:0.85rem;
  color:#666;
  margin-bottom:0.25rem;
  font-weight:600;
}

.detail-content p{
  font-size:1rem;
  color:#333;
  font-weight:700;
  margin:0;
  word-break:break-word;
}

.trip-address{
  background:#f8f9fa;
  padding:1rem;
  border-radius:8px;
  margin-bottom:1rem;
}

.trip-address h4{
  font-size:0.85rem;
  color:#666;
  margin-bottom:0.5rem;
}

.trip-address p{
  color:#333;
  margin:0.35rem 0 0;
  word-break:break-word;
}

.trip-notes{
  background:#fff3cd;
  padding:1rem;
  border-radius:8px;
  margin-bottom:1rem;
  border-left:3px solid #ffc107;
}

.trip-notes h4{
  font-size:0.85rem;
  color:#856404;
  margin-bottom:0.5rem;
}

.trip-notes p{
  color:#333;
  margin:0;
  font-style:italic;
  word-break:break-word;
}

.trip-actions{
  display:flex;
  gap:0.75rem;
  flex-wrap:wrap;
}

.btn{
  padding:0.75rem 1.5rem;
  border:none;
  border-radius:8px;
  font-weight:700;
  cursor:pointer;
  transition:.3s;
  font-size:0.95rem;
}

.btn-claim{
  background:#00D632;
  color:white;
}

.btn-claim:hover{
  background:#00C853;
  transform:translateY(-2px);
}

.btn-unclaim{
  background:#ff6b6b;
  color:white;
}

.btn-unclaim:hover{
  background:#ee5a24;
  transform:translateY(-2px);
}

.btn-complete{
  background:#667eea;
  color:white;
}

.btn-complete:hover{
  background:#5568d3;
  transform:translateY(-2px);
}

.btn-contact{
  background:#25D366;
  color:white;
}

.btn-contact:hover{
  background:#20ba5a;
  transform:translateY(-2px);
}

.btn:disabled{
  background:#ccc;
  cursor:not-allowed;
  transform:none;
}

.loading{
  text-align:center;
  padding:3rem;
  font-size:1.2rem;
}

.no-trips{
  background:rgba(255,255,255,.05);
  border:1px solid var(--line);
  border-radius:16px;
  padding:3rem;
  text-align:center;
}

.no-trips h3{
  margin-bottom:0.5rem;
}

.back-link{
  display:inline-block;
  margin-top:2rem;
  color:#667eea;
  text-decoration:none;
  font-weight:600;
}

.back-link:hover{
  text-decoration:underline;
}

@media(max-width:768px){
  .header h1{
    font-size:2rem;
  }
  
  .trip-details{
    grid-template-columns:1fr;
  }
  
  .filter-bar{
    flex-direction:column;
    align-items:stretch;
  }
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>üöó Driver Board</h1>
    <p>View and claim available trips</p>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number available" id="availableCount">0</div>
      <div class="stat-label">Available Trips</div>
    </div>
    <div class="stat-card">
      <div class="stat-number claimed" id="claimedCount">0</div>
      <div class="stat-label">Claimed Trips</div>
    </div>
    <div class="stat-card">
      <div class="stat-number completed" id="completedCount">0</div>
      <div class="stat-label">Completed</div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar">
    <select id="statusFilter">
      <option value="all">All Trips</option>
      <option value="available">Available Only</option>
      <option value="claimed">Claimed</option>
      <option value="completed">Completed</option>
    </select>

    <select id="airportFilter">
      <option value="all">All Airports</option>
      <option value="DEN">DEN - Denver</option>
      <option value="LAX">LAX - Los Angeles</option>
      <option value="ORD">ORD - Chicago</option>
      <option value="ATL">ATL - Atlanta</option>
      <option value="JFK">JFK - New York</option>
    </select>

    <input type="date" id="dateFilter">

    <button onclick="loadTrips()">üîÑ Refresh</button>
  </div>

  <!-- Loading State -->
  <div id="loadingState" class="loading">
    Loading trips...
  </div>

  <!-- Trips Grid -->
  <div id="tripsGrid" class="trips-grid" style="display:none;">
    <!-- Trips will be inserted here -->
  </div>

  <!-- No Trips -->
  <div id="noTrips" class="no-trips" style="display:none;">
    <h3>üì≠ No Trips Available</h3>
    <p>Check back soon for new pickup requests</p>
  </div>

  <a href="/" class="back-link">‚Üê Back to Home</a>
</div>

<script>
  // IMPORTANT: your API is now on the domain (routes set), so use the domain API.
  const API_BASE = 'https://travylway.com/api/trips';

  // Temporary per-session driver id (replace later with real auth)
  let currentDriverId = 'DRIVER_' + Math.random().toString(36).substr(2, 9);

  // Load trips on page load
window.addEventListener('load', () => {
  // Check for URL filter parameter
  const urlParams = new URLSearchParams(window.location.search);
  const filter = urlParams.get('filter');
  
  // Set the filter dropdown based on URL
  if (filter === 'available') {
    document.getElementById('statusFilter').value = 'available';
  } else if (filter === 'claimed') {
    document.getElementById('statusFilter').value = 'claimed';
  } else if (filter === 'completed') {
    document.getElementById('statusFilter').value = 'completed';
  }
  
  loadTrips();
  // Auto-refresh every 30 seconds
  setInterval(loadTrips, 30000);
});

  async function loadTrips() {
    const loadingState = document.getElementById('loadingState');
    const tripsGrid = document.getElementById('tripsGrid');
    const noTrips = document.getElementById('noTrips');

    loadingState.style.display = 'block';
    tripsGrid.style.display = 'none';
    noTrips.style.display = 'none';

    const statusFilter = document.getElementById('statusFilter').value;
    const airportFilter = document.getElementById('airportFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;

    // Map UI statuses -> API statuses
    const statusMap = { available: 'OPEN', claimed: 'ASSIGNED', completed: 'COMPLETED' };

    // Build API URL with optional server-side filters
    const url = new URL(API_BASE);
    if (airportFilter !== 'all') url.searchParams.set('airport', airportFilter);

    // If user chose a specific UI status, pass the matching API status
    if (statusFilter !== 'all' && statusMap[statusFilter]) {
      url.searchParams.set('status', statusMap[statusFilter]);
    } else {
      // Default to OPEN if you want only open trips; otherwise omit.
      // url.searchParams.set('status', 'OPEN');
    }

    try {
      const response = await fetch(url.toString(), { cache: 'no-store' });
      const data = await response.json();

      const trips = Array.isArray(data.trips) ? data.trips : [];

      // Client-side date filter (YYYY-MM-DD based on pickup_time_utc)
      const filteredTrips = trips.filter(trip => {
        if (!dateFilter) return true;
        const d = String(trip.pickup_time_utc || '').slice(0, 10);
        return d === dateFilter;
      });

      if (filteredTrips.length > 0) {
        displayTrips(filteredTrips);
        updateStats(trips); // stats based on unfiltered list
        tripsGrid.style.display = 'grid';
      } else {
        noTrips.style.display = 'block';
      }
    } catch (error) {
      console.error('Error loading trips:', error);
      noTrips.style.display = 'block';
    } finally {
      loadingState.style.display = 'none';
    }
  }

  function displayTrips(trips) {
    const tripsGrid = document.getElementById('tripsGrid');

    // Sort by pickup_time_utc ascending (soonest first)
    trips.sort((a, b) => String(a.pickup_time_utc).localeCompare(String(b.pickup_time_utc)));

    tripsGrid.innerHTML = trips.map(trip => {
      const apiStatus = String(trip.status || '').toUpperCase();
      const uiStatusClass =
        apiStatus === 'OPEN' ? 'available' :
        apiStatus === 'ASSIGNED' ? 'claimed' :
        apiStatus === 'COMPLETED' ? 'completed' : 'available';

      const uiStatusLabel =
        apiStatus === 'OPEN' ? 'AVAILABLE' :
        apiStatus === 'ASSIGNED' ? 'CLAIMED' :
        apiStatus === 'COMPLETED' ? 'COMPLETED' : apiStatus;

      const directionIcon = (trip.direction === 'FROM_AIRPORT') ? 'üõ¨' : 'üõ´';

      return `
        <div class="trip-card ${uiStatusClass}">
          <div class="trip-header">
            <span class="trip-id">${trip.id}</span>
            <span class="trip-status status-${uiStatusClass}">${uiStatusLabel}</span>
          </div>

          <div class="trip-details">
            <div class="detail-item">
              <span class="detail-icon">üë§</span>
              <div class="detail-content">
                <h4>Contact</h4>
                <p>${escapeHtml(trip.created_by || 'N/A')}</p>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">üè¢</span>
              <div class="detail-content">
                <h4>Airport</h4>
                <p>${escapeHtml(trip.airport_code || 'N/A')}</p>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">üìÖ</span>
              <div class="detail-content">
                <h4>Pickup Time (UTC)</h4>
                <p>${escapeHtml(formatUtc(trip.pickup_time_utc))}</p>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">${directionIcon}</span>
              <div class="detail-content">
                <h4>Direction</h4>
                <p>${escapeHtml(trip.direction || 'N/A')}</p>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">üß≠</span>
              <div class="detail-content">
                <h4>Type</h4>
                <p>${escapeHtml(trip.rider_type || 'N/A')} ‚Ä¢ ${escapeHtml(trip.trip_type || 'N/A')}</p>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-icon">üè∑Ô∏è</span>
              <div class="detail-content">
                <h4>Category</h4>
                <p>${escapeHtml(trip.trip_category || 'N/A')}</p>
              </div>
            </div>
          </div>

          <div class="trip-address">
            <h4>üìç Pickup ‚Üí Dropoff</h4>
            <p><b>Pickup:</b> ${escapeHtml(trip.pickup_text || '')}</p>
            <p><b>Dropoff:</b> ${escapeHtml(trip.dropoff_text || '')}</p>
          </div>

          ${trip.notes ? `
            <div class="trip-notes">
              <h4>üìù Notes</h4>
              <p>${escapeHtml(trip.notes)}</p>
            </div>
          ` : ''}

          <div class="trip-actions">
            <!-- Claim/Complete endpoints not wired yet in your Worker. Keep disabled for now. -->
            <button class="btn btn-claim" disabled title="Claim endpoints coming next">
              ‚úì Claim Trip
            </button>

            <button class="btn btn-contact" onclick="contactPassenger('${escapeAttr(trip.created_by || '')}')">
              üì± Contact
            </button>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateStats(trips) {
    const available = trips.filter(t => String(t.status).toUpperCase() === 'OPEN').length;
    const claimed = trips.filter(t => String(t.status).toUpperCase() === 'ASSIGNED').length;
    const completed = trips.filter(t => String(t.status).toUpperCase() === 'COMPLETED').length;

    document.getElementById('availableCount').textContent = available;
    document.getElementById('claimedCount').textContent = claimed;
    document.getElementById('completedCount').textContent = completed;
  }

  function contactPassenger(contact) {
    const c = String(contact || '');
    const digits = c.replace(/\D/g, '');
    // If it looks like a phone number, open WhatsApp; otherwise show the contact
    if (digits.length >= 10) {
      const last10 = digits.slice(-10);
      window.open(`https://wa.me/1${last10}`, '_blank');
    } else {
      alert('Contact: ' + c);
    }
  }

  function formatUtc(iso) {
    if (!iso) return '';
    // Keep it simple: YYYY-MM-DD HH:MMZ
    return String(iso).replace('T', ' ').replace('.000Z', 'Z');
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function escapeAttr(s){
    return String(s).replace(/'/g, "%27");
  }

  // Apply filters
  document.getElementById('statusFilter').addEventListener('change', loadTrips);
  document.getElementById('airportFilter').addEventListener('change', loadTrips);
  document.getElementById('dateFilter').addEventListener('change', loadTrips);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Driver Board - Travylway</title>
<style>
:root{
  --bg:#f8fafc;
  --accent:#2563EB;
  --text:#0F172A;
  --muted:#64748b;
  --line:rgba(0,0,0,.08);
  --success:#10b981;
  --warning:#f59e0b;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--text);
}

.header{
  background:linear-gradient(135deg,#667eea,#764ba2);
  color:white;
  padding:2rem 1rem;
  text-align:center;
  box-shadow:0 4px 20px rgba(0,0,0,.1);
}
.header h1{margin:0 0 0.5rem;font-size:2rem}
.header p{margin:0;opacity:0.9}

.container{
  max-width:1400px;
  margin:2rem auto;
  padding:0 1rem;
}

/* FILTER SECTION */
.filter-section{
  background:white;
  border-radius:16px;
  padding:2rem;
  margin-bottom:2rem;
  box-shadow:0 4px 20px rgba(0,0,0,.06);
  border:1px solid var(--line);
}
.filter-section h2{
  margin:0 0 1.5rem;
  color:var(--text);
  font-size:1.5rem;
}

.filter-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1rem;
  margin-bottom:1.5rem;
}

.filter-group{
  display:flex;
  flex-direction:column;
  gap:0.5rem;
}
.filter-group label{
  font-size:0.85rem;
  font-weight:700;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.filter-group select,
.filter-group input{
  padding:0.75rem;
  border:2px solid #e5e7eb;
  border-radius:8px;
  font-size:1rem;
  background:white;
  transition:all 0.2s;
}
.filter-group select:focus,
.filter-group input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(37,99,235,0.1);
}

.filter-actions{
  display:flex;
  gap:1rem;
  margin-top:1rem;
}
.btn{
  padding:0.75rem 1.5rem;
  border-radius:8px;
  border:none;
  font-weight:700;
  font-size:0.95rem;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-primary{
  background:var(--accent);
  color:white;
}
.btn-primary:hover{
  background:#1d4ed8;
  transform:translateY(-2px);
}
.btn-secondary{
  background:#e5e7eb;
  color:var(--text);
}
.btn-secondary:hover{
  background:#d1d5db;
}

/* STATS */
.stats-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:1rem;
  margin-bottom:2rem;
}
.stat-card{
  background:white;
  border-radius:12px;
  padding:1.5rem;
  box-shadow:0 2px 10px rgba(0,0,0,.06);
  border:1px solid var(--line);
  text-align:center;
}
.stat-number{
  font-size:2.5rem;
  font-weight:900;
  margin:0;
  background:linear-gradient(135deg,#667eea,#764ba2);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.stat-label{
  font-size:0.9rem;
  color:var(--muted);
  margin:0.5rem 0 0;
  font-weight:600;
}

/* TRIPS */
.trips-section{
  background:white;
  border-radius:16px;
  padding:2rem;
  box-shadow:0 4px 20px rgba(0,0,0,.06);
  border:1px solid var(--line);
}
.trips-section h2{
  margin:0 0 1.5rem;
  color:var(--text);
  font-size:1.5rem;
}

.trip-card{
  background:#f8fafc;
  border:2px solid #e5e7eb;
  border-radius:12px;
  padding:1.5rem;
  margin-bottom:1rem;
  transition:all 0.2s;
}
.trip-card:hover{
  border-color:var(--accent);
  box-shadow:0 4px 20px rgba(37,99,235,0.1);
}

.trip-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:1rem;
  flex-wrap:wrap;
  gap:1rem;
}
.trip-id{
  font-size:0.85rem;
  color:var(--muted);
  font-family:monospace;
  word-break:break-all;
}
.trip-status{
  padding:0.4rem 1rem;
  border-radius:999px;
  font-size:0.8rem;
  font-weight:900;
  text-transform:uppercase;
  letter-spacing:0.5px;
  white-space:nowrap;
}
.status-pending{background:#fef3c7;color:#92400e}
.status-approved{background:#d1fae5;color:#065f46}
.status-claimed{background:#dbeafe;color:#1e40af}
.status-completed{background:#e5e7eb;color:#334155}

.trip-info{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
  gap:1rem;
  margin-bottom:1rem;
}
.info-item{
  display:flex;
  flex-direction:column;
  gap:0.25rem;
}
.info-label{
  font-size:0.75rem;
  color:var(--muted);
  font-weight:700;
  text-transform:uppercase;
}
.info-value{
  font-size:1rem;
  color:var(--text);
  font-weight:600;
}

.trip-route{
  background:white;
  border-radius:8px;
  padding:1rem;
  margin-bottom:1rem;
  border-left:4px solid var(--accent);
}
.route-label{
  font-size:0.75rem;
  color:var(--muted);
  font-weight:700;
  text-transform:uppercase;
  margin-bottom:0.5rem;
}
.route-text{
  font-size:1rem;
  color:var(--text);
  margin:0;
  word-break:break-word;
}

.trip-actions{
  display:flex;
  gap:0.75rem;
  flex-wrap:wrap;
}
.btn-claim{
  background:var(--success);
  color:white;
  flex:1;
  min-width:160px;
}
.btn-claim:hover{
  background:#059669;
  transform:translateY(-2px);
}
.btn-details{
  background:#e5e7eb;
  color:var(--text);
  flex:1;
  min-width:160px;
}
.btn-details:hover{
  background:#d1d5db;
}

.fare-display{
  background:linear-gradient(135deg,#10b981,#059669);
  color:white;
  border-radius:12px;
  padding:1.5rem;
  margin-bottom:1.5rem;
  text-align:center;
  box-shadow:0 4px 15px rgba(16,185,129,0.3);
}

.fare-grid{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:1rem;
  align-items:center;
  max-width:600px;
  margin:0 auto;
}

.fare-divider{
  font-size:2rem;
  opacity:0.7;
}

.fare-payout{
  text-align:center;
  border-left:2px solid rgba(255,255,255,0.3);
  padding-left:1rem;
}

.empty-state{
  text-align:center;
  padding:3rem 1rem;
  color:var(--muted);
}
.empty-state-icon{
  font-size:4rem;
  margin-bottom:1rem;
}

/* LOADING */
.loading{
  text-align:center;
  padding:3rem;
  font-size:1.2rem;
  color:var(--muted);
}

/* RESPONSIVE */
@media(max-width:768px){
  .header h1{font-size:1.5rem}
  .header p{font-size:0.9rem}
  
  .filter-grid{grid-template-columns:1fr}
  .filter-actions{flex-direction:column}
  .btn{width:100%}
  
  .stats-grid{grid-template-columns:repeat(2, 1fr)}
  .stat-number{font-size:2rem}
  .stat-label{font-size:0.8rem}
  
  .trip-header{flex-direction:column;align-items:flex-start}
  .trip-info{grid-template-columns:1fr}
  .trip-actions{flex-direction:column}
  .trip-actions .btn{width:100%;min-width:auto}
  
  .trip-card{padding:1rem}
  .filter-section{padding:1rem}
  .trips-section{padding:1rem}
  
  /* Stack fare display on mobile */
  .fare-grid{
    grid-template-columns:1fr !important;
    gap:0;
  }
  
  .fare-divider{
    display:none;
  }
  
  .fare-payout{
    border-left:none;
    border-top:2px solid rgba(255,255,255,0.3);
    padding-left:0;
    padding-top:1rem;
    margin-top:1rem;
  }
  
  /* Reduce fare display font sizes on mobile */
  .fare-display div[style*="font-size:2rem"]{
    font-size:1.5rem !important;
  }
  
  .fare-display div[style*="font-size:2.5rem"]{
    font-size:1.75rem !important;
  }
  
  .fare-display div[style*="font-size:0.8rem"]{
    font-size:0.75rem !important;
  }
}

@media(max-width:480px){
  .container{padding:0 0.5rem;margin:1rem auto}
  .header{padding:1.5rem 1rem}
  .stats-grid{grid-template-columns:1fr}
  .trip-id{font-size:0.75rem}
  .trip-status{font-size:0.7rem;padding:0.3rem 0.75rem}
  .info-value{font-size:0.95rem}
  .route-text{font-size:0.95rem}
  
  /* Further reduce on very small screens */
  .fare-display{
    padding:1rem;
  }
  
  .fare-display div[style*="font-size:2rem"],
  .fare-display div[style*="font-size:1.5rem"]{
    font-size:1.25rem !important;
  }
  
  .fare-display div[style*="font-size:2.5rem"],
  .fare-display div[style*="font-size:1.75rem"]{
    font-size:1.5rem !important;
  }
}
</style>
</head>
<body>

<div class="header">
  <h1>üöó Driver Board</h1>
  <p>Available airport transportation requests worldwide</p>
</div>

<div class="container">

  <!-- FILTER SECTION -->
  <div class="filter-section">
    <h2>üåç Filter Trips by Location</h2>

    <div class="filter-grid">
      <div class="filter-group">
        <label>Country</label>
        <select id="filterCountry">
          <option value="">All Countries</option>
          <option value="USA">United States</option>
          <option value="CAN">Canada</option>
          <option value="MEX">Mexico</option>
          <option value="UK">United Kingdom</option>
          <option value="FRA">France</option>
          <option value="GER">Germany</option>
          <option value="ITA">Italy</option>
          <option value="ESP">Spain</option>
          <option value="AUS">Australia</option>
          <option value="CHN">China</option>
          <option value="JPN">Japan</option>
          <option value="KOR">South Korea</option>
          <option value="IND">India</option>
          <option value="UAE">United Arab Emirates</option>
          <option value="SAU">Saudi Arabia</option>
          <option value="THA">Thailand</option>
          <option value="SGP">Singapore</option>
        </select>
      </div>

      <div class="filter-group">
        <label>State/Region</label>
        <input type="text" id="filterState" placeholder="e.g., Colorado, California">
      </div>

      <div class="filter-group">
        <label>City</label>
        <input type="text" id="filterCity" placeholder="e.g., Denver, Los Angeles">
      </div>

      <div class="filter-group">
        <label>Airport Code</label>
        <input type="text" id="filterAirport" placeholder="e.g., DEN, LAX, JFK" maxlength="3" style="text-transform:uppercase">
      </div>

      <div class="filter-group">
        <label>Trip Status</label>
        <select id="filterStatus">
          <option value="APPROVED" selected>Available (Approved)</option>
          <option value="PENDING">Pending Approval</option>
          <option value="NEW">New</option>
          <option value="CLAIMED">Claimed</option>
          <option value="COMPLETED">Completed</option>
          <option value="">All Statuses</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Rider Type</label>
        <select id="filterRiderType">
          <option value="">All Riders</option>
          <option value="CREW">Airline Crew</option>
          <option value="GENERAL">General Travelers</option>
        </select>
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn btn-primary" id="applyBtn">üîç Apply Filters</button>
      <button class="btn btn-secondary" id="clearBtn">üîÑ Clear All</button>
    </div>

    <div style="margin-top:1rem;padding:1rem;background:#f0f9ff;border-radius:8px;border-left:4px solid #0284c7;">
      <p style="margin:0;font-size:0.9rem;color:#075985;">
        <strong>üí° Quick Tip:</strong> Set your home airport in the filters to see only trips in your area. Combine filters to narrow results further.
      </p>
    </div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="statTotal">--</div>
      <div class="stat-label">Total Trips</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="statAvailable">--</div>
      <div class="stat-label">Available Now</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="statCrew">--</div>
      <div class="stat-label">Crew Trips</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="statGeneral">--</div>
      <div class="stat-label">General Trips</div>
    </div>
  </div>

  <!-- TRIPS -->
  <div class="trips-section">
    <h2>üìã Trip Requests</h2>
    <div id="tripsContainer" class="loading">Loading trips...</div>
  </div>

</div>

<script>
const API_BASE = "https://api.travylway.com";

let allTrips = [];
let filteredTrips = [];

function normStatus(s) {
  const v = String(s || "").toUpperCase();
  if (v === "OPEN") return "APPROVED";
  return v || "APPROVED";
}

function pickupLocalString(isoUtc) {
  const d = new Date(isoUtc);
  if (isNaN(d.getTime())) return "Invalid time";
  return d.toLocaleString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit"
  });
}

async function loadTrips() {
  try {
    const selectedStatus = (document.getElementById("filterStatus")?.value || "APPROVED").toUpperCase();

    const qs = new URLSearchParams();
    if (selectedStatus) qs.set("status", selectedStatus);

    const url = `${API_BASE}/api/trips?${qs.toString()}`;
    const response = await fetch(url, { cache: "no-store" });
    const data = await response.json();

    if (data.ok) {
      allTrips = (data.trips || []).map(t => ({
        ...t,
        status: normStatus(t.status),
        rider_type: String(t.rider_type || "").toUpperCase(),
        airport_code: String(t.airport_code || "").toUpperCase()
      }));
      applyFilters(false);
    } else {
      showError(data.error || "Failed to load trips");
    }
  } catch (error) {
    console.error("Error loading trips:", error);
    showError("Network/DNS error loading trips");
  }
}

function applyFilters(refetch = false) {
  if (refetch) {
    loadTrips();
    return;
  }

  const country = document.getElementById("filterCountry").value.toUpperCase();
  const state = document.getElementById("filterState").value.toLowerCase();
  const city = document.getElementById("filterCity").value.toLowerCase();
  const airport = document.getElementById("filterAirport").value.toUpperCase();
  const status = document.getElementById("filterStatus").value.toUpperCase();
  const riderType = document.getElementById("filterRiderType").value.toUpperCase();

  filteredTrips = allTrips.filter(trip => {
    if (country && !addressMatchesCountry(trip, country)) return false;
    if (state && !addressContains(trip, state)) return false;
    if (city && !addressContains(trip, city)) return false;

    if (airport) {
      const code = (trip.airport_code || "").toUpperCase();
      if (code) {
        if (code !== airport) return false;
      } else {
        if (!addressContains(trip, airport.toLowerCase())) return false;
      }
    }

    if (status && trip.status !== status) return false;
    if (riderType && trip.rider_type !== riderType) return false;

    return true;
  });

  updateStats();
  renderTrips();
}

function addressContains(trip, term) {
  const pickup = (trip.pickup_text || "").toLowerCase();
  const dropoff = (trip.dropoff_text || "").toLowerCase();
  const airportCode = (trip.airport_code || "").toLowerCase();
  return pickup.includes(term) || dropoff.includes(term) || airportCode.includes(term);
}

function addressMatchesCountry(trip, countryCode) {
  const pickup = (trip.pickup_text || "").toUpperCase();
  const dropoff = (trip.dropoff_text || "").toUpperCase();

  const countryMap = {
    "USA": ["USA","US","UNITED STATES",", CO",", CA",", NY",", TX",", FL"],
    "CAN": ["CANADA","TORONTO","VANCOUVER","MONTREAL","CALGARY"],
    "MEX": ["MEXICO","CANCUN","CABO"],
    "UK": ["UNITED KINGDOM","LONDON","MANCHESTER","EDINBURGH","UK"],
    "FRA": ["FRANCE","PARIS","LYON"],
    "GER": ["GERMANY","FRANKFURT","MUNICH","BERLIN"],
    "ITA": ["ITALY","ROME","MILAN","VENICE"],
    "ESP": ["SPAIN","MADRID","BARCELONA"],
    "AUS": ["AUSTRALIA","SYDNEY","MELBOURNE","BRISBANE"],
    "CHN": ["CHINA","BEIJING","SHANGHAI"],
    "JPN": ["JAPAN","TOKYO","OSAKA"],
    "KOR": ["KOREA","SEOUL","INCHEON"],
    "IND": ["INDIA","DELHI","MUMBAI","BANGALORE"],
    "UAE": ["DUBAI","ABU DHABI","UAE"],
    "SAU": ["SAUDI","RIYADH","JEDDAH"],
    "THA": ["THAILAND","BANGKOK"],
    "SGP": ["SINGAPORE"]
  };

  const keywords = countryMap[countryCode] || [countryCode];
  return keywords.some(k => pickup.includes(k) || dropoff.includes(k));
}

function clearFilters() {
  document.getElementById("filterCountry").value = "";
  document.getElementById("filterState").value = "";
  document.getElementById("filterCity").value = "";
  document.getElementById("filterAirport").value = "";
  document.getElementById("filterStatus").value = "APPROVED";
  document.getElementById("filterRiderType").value = "";
  loadTrips();
}

function updateStats() {
  document.getElementById("statTotal").textContent = filteredTrips.length;
  document.getElementById("statAvailable").textContent = filteredTrips.filter(t => t.status === "APPROVED").length;
  document.getElementById("statCrew").textContent = filteredTrips.filter(t => t.rider_type === "CREW").length;
  document.getElementById("statGeneral").textContent = filteredTrips.filter(t => t.rider_type === "GENERAL").length;
}

function renderTrips() {
  const container = document.getElementById("tripsContainer");

  if (filteredTrips.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No trips match your filters</h3>
        <p>Try adjusting your filters or check back later</p>
      </div>
    `;
    return;
  }

  container.innerHTML = filteredTrips.map(trip => {
    const pickupTime = pickupLocalString(trip.pickup_time_utc);
    const statusClass = `status-${String(trip.status || "APPROVED").toLowerCase()}`;

    const fare = Number(trip.estimated_fare || 0);
    const driverPayout = Number(trip.driver_payout || (fare ? fare * 0.75 : 0));
    const platformFee = fare ? (fare - driverPayout) : 0;

    const pickupTimeDate = new Date(trip.pickup_time_utc);
    const now = new Date();
    const hoursUntilPickup = (pickupTimeDate - now) / (1000 * 60 * 60);
    const canUnclaim = hoursUntilPickup > 48;

    return `
      <div class="trip-card">
        ${fare > 0 ? `
          <div class="fare-display">
            <div class="fare-grid">
              <div style="text-align:center;">
                <div style="font-size:0.8rem;opacity:0.9;margin-bottom:0.25rem;font-weight:600;">TRIP TOTAL</div>
                <div style="font-size:2rem;font-weight:900;line-height:1;">$${fare.toFixed(2)}</div>
                <div style="font-size:0.75rem;opacity:0.8;margin-top:0.25rem;">${trip.distance_miles ? Number(trip.distance_miles).toFixed(1) + " miles" : ""}</div>
              </div>
              <div class="fare-divider">‚Üí</div>
              <div class="fare-payout">
                <div style="font-size:0.8rem;opacity:0.9;margin-bottom:0.25rem;font-weight:600;">YOU EARN</div>
                <div style="font-size:2.5rem;font-weight:900;line-height:1;">$${driverPayout.toFixed(2)}</div>
                <div style="font-size:0.75rem;opacity:0.8;margin-top:0.25rem;">75% of fare</div>
              </div>
            </div>
            ${trip.duration_minutes ? `
              <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.3);font-size:0.85rem;opacity:0.9;">
                ‚è±Ô∏è Estimated Duration: ${Math.round(Number(trip.duration_minutes))} minutes
              </div>
            ` : ""}
          </div>
        ` : `
          <div style="background:#fef3c7;border-radius:12px;padding:1.5rem;margin-bottom:1.5rem;text-align:center;border:2px dashed #f59e0b;">
            <div style="font-size:1.1rem;color:#92400e;font-weight:700;">üí∞ Fare Calculation Pending</div>
            <div style="font-size:0.85rem;color:#78350f;margin-top:0.5rem;">Distance and fare will be calculated shortly</div>
          </div>
        `}

        <div class="trip-header">
          <span class="trip-id">ID: ${String(trip.id || "").substring(0, 8)}</span>
          <span class="trip-status ${statusClass}">${trip.status || "APPROVED"}</span>
        </div>

        <div class="trip-info">
          <div class="info-item">
            <div class="info-label">Customer</div>
            <div class="info-value">${trip.created_by || "N/A"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Type</div>
            <div class="info-value">${trip.rider_type === "CREW" ? "‚úàÔ∏è Airline Crew" : "üöó General Traveler"}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Pickup Time (Your Local)</div>
            <div class="info-value">${pickupTime}</div>
          </div>
          <div class="info-item">
            <div class="info-label">Phone</div>
            <div class="info-value">${trip.rider_phone || "N/A"}</div>
          </div>
        </div>

        <div class="trip-route">
          <div class="route-label">üìç Pickup</div>
          <div class="route-text">${trip.pickup_text || "N/A"}</div>
        </div>

        <div class="trip-route">
          <div class="route-label">üéØ Dropoff</div>
          <div class="route-text">${trip.dropoff_text || "N/A"}</div>
        </div>

        ${trip.notes ? `
          <div style="background:#fef3c7;padding:1rem;border-radius:8px;margin-bottom:1rem;border-left:4px solid #f59e0b;">
            <div style="font-size:0.75rem;color:#92400e;font-weight:700;margin-bottom:0.25rem;">üìù CUSTOMER NOTES</div>
            <div style="color:#78350f;">${trip.notes}</div>
          </div>
        ` : ""}

        ${fare > 0 ? `
          <details style="margin-bottom:1rem;">
            <summary style="cursor:pointer;padding:1rem;background:#f8fafc;border-radius:8px;font-weight:700;color:#475569;">
              üíµ View Earnings Breakdown
            </summary>
            <div style="padding:1rem;background:white;border:1px solid #e5e7eb;border-radius:8px;margin-top:0.5rem;">
              <div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                <span style="color:#64748b;">Fare</span>
                <span style="font-weight:700;">$${fare.toFixed(2)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid #e5e7eb;">
                <span style="color:#64748b;">Platform Fee (25%)</span>
                <span style="font-weight:700;color:#dc2626;">-$${platformFee.toFixed(2)}</span>
              </div>
              <div style="display:flex;justify-content:space-between;padding:0.5rem 0;margin-top:0.5rem;padding-top:1rem;border-top:2px solid #10b981;">
                <span style="font-weight:900;color:#059669;font-size:1.1rem;">Your Payout (75%)</span>
                <span style="font-weight:900;color:#059669;font-size:1.2rem;">$${driverPayout.toFixed(2)}</span>
              </div>
            </div>
          </details>
        ` : ""}

        <div class="trip-actions">
          ${trip.status === "APPROVED" ? `
            <button class="btn btn-claim" onclick="claimTrip('${trip.id}')">
              ‚úì Claim This Trip${fare ? ` ‚Äî Earn $${driverPayout.toFixed(2)}` : ""}
            </button>
          ` : trip.status === "CLAIMED" ? `
            <div style="background:#dbeafe;border-radius:8px;padding:1rem;margin-bottom:1rem;border-left:4px solid #2563eb;flex:1;">
              <div style="font-weight:700;color:#1e40af;margin-bottom:0.5rem;">‚úì CLAIMED by ${trip.driver_name || "Driver"}</div>
              <div style="font-size:0.85rem;color:#475569;">
                Claimed: ${trip.claimed_at ? new Date(trip.claimed_at).toLocaleString() : "Recently"}
              </div>
              ${hoursUntilPickup > 0 ? `
                <div style="font-size:0.85rem;color:#475569;margin-top:0.25rem;">
                  Pickup in: ${Math.round(hoursUntilPickup)} hours
                </div>
              ` : ""}
            </div>

            ${canUnclaim ? `
              <button class="btn" style="background:#f59e0b;color:white;" onclick="unclaimTrip('${trip.id}')">
                ‚Ü©Ô∏è Unclaim Trip
              </button>
            ` : `
              <button class="btn" style="background:#94a3b8;color:white;cursor:not-allowed;" disabled title="Cannot unclaim within 48 hours of pickup">
                üîí Cannot Unclaim
              </button>
            `}
          ` : trip.status === "NEW" ? `
            <button class="btn" style="background:#fbbf24;color:#78350f;cursor:not-allowed;flex:1;" disabled>
              ‚è≥ Pending Approval
            </button>
          ` : `
            <button class="btn" style="background:#94a3b8;color:white;cursor:not-allowed;flex:1;" disabled>
              ${trip.status}
            </button>
          `}
          <button class="btn btn-details" onclick="viewDetails('${trip.id}')">
            üìÑ View Full Details
          </button>
        </div>
      </div>
    `;
  }).join("");
}

async function claimTrip(tripId) {
  const driverName = prompt("Enter your name:");
  if (!driverName || driverName.trim() === "") {
    alert("Driver name is required");
    return;
  }

  const driverPhone = prompt("Enter your phone number (optional, for customer contact):");

  try {
    const response = await fetch(`${API_BASE}/api/trips/${tripId}/claim`, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        driver_name: driverName.trim(),
        driver_phone: driverPhone ? driverPhone.trim() : null
      })
    });

    const data = await response.json();

    if (data.ok) {
      alert("‚úÖ Trip claimed successfully!");
      if (data.whatsapp_link && confirm("Open WhatsApp to message customer?")) {
        window.open(data.whatsapp_link, "_blank");
      }
      loadTrips();
    } else {
      alert(`‚ùå Failed to claim trip:\n${data.error}`);
    }
  } catch (error) {
    console.error("Error claiming trip:", error);
    alert("‚ùå Network error. Please try again.");
  }
}

async function unclaimTrip(tripId) {
  if (!confirm("Are you sure you want to unclaim this trip?\n\nNote: You cannot unclaim trips within 48 hours of pickup time.")) {
    return;
  }

  try {
    const response = await fetch(`${API_BASE}/api/trips/${tripId}/unclaim`, {
      method: "POST",
      headers: {"Content-Type":"application/json"}
    });

    const data = await response.json();

    if (data.ok) {
      alert("‚úÖ Trip unclaimed successfully!");
      loadTrips();
    } else {
      alert(`‚ùå Failed to unclaim trip:\n${data.error}`);
    }
  } catch (error) {
    console.error("Error unclaiming trip:", error);
    alert("‚ùå Network error. Please try again.");
  }
}

function viewDetails(tripId) {
  const trip = allTrips.find(t => t.id === tripId);
  if (!trip) return;

  alert(`
Trip Details:
ID: ${trip.id}
Customer: ${trip.created_by || "N/A"}
Phone: ${trip.rider_phone || "N/A"}
Type: ${trip.rider_type || "N/A"}
Status: ${trip.status || "N/A"}
Pickup: ${trip.pickup_text || "N/A"}
Dropoff: ${trip.dropoff_text || "N/A"}
Time (Local): ${pickupLocalString(trip.pickup_time_utc)}
Fare: $${Number(trip.estimated_fare || 0).toFixed(2)}
Notes: ${trip.notes || "None"}
  `);
}

function showError(message) {
  document.getElementById("tripsContainer").innerHTML = `
    <div class="empty-state">
      <div class="empty-state-icon">‚ö†Ô∏è</div>
      <h3>Error Loading Trips</h3>
      <p>${message}</p>
      <button class="btn btn-primary" onclick="loadTrips()">Retry</button>
    </div>
  `;
}

document.getElementById("filterAirport").addEventListener("input", (e) => {
  e.target.value = e.target.value.toUpperCase();
});

document.getElementById("applyBtn").addEventListener("click", () => applyFilters(false));
document.getElementById("clearBtn").addEventListener("click", clearFilters);
document.getElementById("filterStatus").addEventListener("change", () => applyFilters(true));
document.getElementById("filterCountry").addEventListener("change", () => applyFilters(false));
document.getElementById("filterRiderType").addEventListener("change", () => applyFilters(false));
document.getElementById("filterState").addEventListener("input", () => applyFilters(false));
document.getElementById("filterCity").addEventListener("input", () => applyFilters(false));
document.getElementById("filterAirport").addEventListener("input", () => applyFilters(false));

loadTrips();
setInterval(loadTrips, 30000);
</script>

</body>
</html>

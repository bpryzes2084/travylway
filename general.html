<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>General Traveler Pickup Request ‚Äî Travylway</title>
  <meta name="description" content="Request airport pickup or drop-off transportation for general travelers worldwide." />

  <style>
    :root{
      --bg:#2B3A4A;
      --card:#fff;
      --text:#0F172A;
      --muted:#64748B;
      --line:#E2E8F0;
      --accent:#2563EB;

      --okbg:#ECFDF5; --okbd:#BBF7D0; --oktx:#166534;
      --warnbg:#FFFBEB; --warnbd:#FDE68A; --warntx:#92400E;
      --badbg:#FEF2F2; --badbd:#FECACA; --badtx:#991B1B;

      --shadow:0 18px 55px rgba(2,6,23,.22);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 700px at 20% 10%, rgba(37,99,235,.25), transparent 55%),
                  radial-gradient(900px 600px at 85% 25%, rgba(34,197,94,.18), transparent 50%),
                  var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 14px 56px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing:.2px;
      color:#fff;
      line-height:1.2;
    }
    .brand p{
      margin:0;
      color: rgba(226,232,240,.9);
      font-size: 14px;
      line-height:1.35;
      max-width: 60ch;
    }

    .status-pill{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,.35);
      border: 1px solid rgba(226,232,240,.20);
      color: rgba(226,232,240,.95);
      font-size: 13px;
      white-space:nowrap;
      margin-top: 2px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background:#94A3B8;
      box-shadow: 0 0 0 3px rgba(148,163,184,.18);
      flex:0 0 auto;
    }
    .dot.ok{background:#22C55E; box-shadow: 0 0 0 3px rgba(34,197,94,.18);}
    .dot.bad{background:#EF4444; box-shadow: 0 0 0 3px rgba(239,68,68,.18);}
    .dot.warn{background:#F59E0B; box-shadow: 0 0 0 3px rgba(245,158,11,.18);}

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .card-head{
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .head-grid{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .headline{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .headline .title{
      font-size: 18px;
      font-weight: 750;
      letter-spacing:.2px;
      margin:0;
      color: var(--text);
    }
    .headline .sub{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height:1.3;
    }

    .rules{
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(37,99,235,.06);
      border: 1px solid rgba(37,99,235,.18);
      color: #1E3A8A;
      font-size: 13px;
      line-height:1.35;
    }

    .card-body{
      padding: 18px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 740px){
      .grid{grid-template-columns: 1fr}
      .topbar{flex-direction:column}
      .status-pill{align-self:flex-start}
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size: 13px;
      color: rgba(15,23,42,.92);
      font-weight: 650;
    }
    input, textarea, select{
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
      background:#fff;
      color: var(--text);
      transition: border-color .15s, box-shadow .15s;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }
    textarea{min-height: 92px; resize: vertical}

    .help{
      font-size: 12.5px;
      color: var(--muted);
      line-height:1.35;
    }

    .section{
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--line);
    }
    .section-title{
      margin:0 0 10px 0;
      font-size: 14px;
      font-weight: 800;
      color: rgba(15,23,42,.9);
      display:flex;
      align-items:center;
      gap:8px;
    }

    .fare{
      display:flex;
      flex-direction:column;
      gap:10px;
      padding: 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(226,232,240,.35), rgba(226,232,240,.08));
    }
    .fare-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      font-size: 14px;
      color: rgba(15,23,42,.85);
    }
    .fare-row strong{font-size: 16px}
    .fare-row.total{
      border-top: 1px solid rgba(148,163,184,.35);
      padding-top: 10px;
      margin-top: 2px;
      font-size: 15px;
    }

    .actions{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 14px;
    }

    .btn{
      appearance:none;
      border:0;
      border-radius: 14px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 800;
      cursor:pointer;
      transition: transform .12s ease, opacity .12s ease, box-shadow .12s ease;
      background: linear-gradient(135deg, rgba(37,99,235,1), rgba(29,78,216,1));
      color:#fff;
      box-shadow: 0 12px 28px rgba(37,99,235,.26);
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .msg{
      display:none;
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 14px;
      line-height:1.35;
      border: 1px solid transparent;
    }
    .msg.show{display:block}
    .msg.ok{background: var(--okbg); border-color: var(--okbd); color: var(--oktx);}
    .msg.bad{background: var(--badbg); border-color: var(--badbd); color: var(--badtx);}
    .msg.warn{background: var(--warnbg); border-color: var(--warnbd); color: var(--warntx);}

    .turnstile{
      display:flex;
      justify-content:center;
      padding-top: 8px;
    }

    .footer-note{
      margin-top: 10px;
      font-size: 12.5px;
      color: rgba(226,232,240,.85);
      text-align:center;
    }
  </style>

  <!-- Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <!-- Google Places -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo&libraries=places" async defer></script>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Travylway</h1>
        <p>Airport rides only. One address must be an airport (pickup <em>or</em> drop-off).</p>
      </div>

      <div class="status-pill" id="mapsStatusPill" aria-live="polite">
        <span class="dot warn" id="mapsDot"></span>
        <span id="mapsStatusText">Maps status: loading‚Ä¶</span>
      </div>
    </div>

    <div class="card">
      <div class="card-head">
        <div class="head-grid">
          <div class="headline">
            <p class="title">General Traveler Pickup Request</p>
            <p class="sub" id="timezoneInfo">Enter pickup time in your local timezone</p>
          </div>
        </div>

        <div class="rules">
          ‚úàÔ∏è Airport rides only. No multi-stop runs, no detours. If neither address is an airport, the request will be rejected.
        </div>
      </div>

      <div class="card-body">
        <form id="bookingForm">
          <div class="grid">
            <div class="field">
              <label for="pickupAddress">Pickup address *</label>
              <input id="pickupAddress" name="pickupAddress" type="text" placeholder="Start typing an address‚Ä¶" autocomplete="off" required>
              <div class="help">Choose a suggestion from the dropdown (required for fare calc).</div>
            </div>

            <div class="field">
              <label for="dropoffAddress">Drop-off address *</label>
              <input id="dropoffAddress" name="dropoffAddress" type="text" placeholder="Start typing an address‚Ä¶" autocomplete="off" required>
              <div class="help">At least one address must be an airport.</div>
            </div>

            <div class="field">
              <label for="passengerName">Your name *</label>
              <input id="passengerName" name="passengerName" type="text" placeholder="Full name" required>
            </div>

            <div class="field">
              <label for="phoneNumber">Phone number *</label>
              <input id="phoneNumber" name="phoneNumber" type="tel" placeholder="+1 (720) 555-1234" required>
              <div class="help">We‚Äôll use WhatsApp to coordinate your ride.</div>
            </div>

            <div class="field">
              <label for="pickupDate">Pickup date *</label>
              <input id="pickupDate" name="pickupDate" type="date" required>
            </div>

            <div class="field">
              <label for="pickupTime">Pickup time *</label>
              <input id="pickupTime" name="pickupTime" type="time" required>
            </div>
          </div>

          <div class="section">
            <p class="section-title">‚úàÔ∏è Flight info (optional)</p>
            <div class="grid">
              <div class="field">
                <label for="flightNumber">Flight number</label>
                <input id="flightNumber" name="flightNumber" type="text" placeholder="e.g., UA1234, AA567">
              </div>
              <div class="field">
                <label for="airline">Airline</label>
                <input id="airline" name="airline" type="text" placeholder="e.g., United, American">
              </div>
            </div>
          </div>

          <div class="section">
            <p class="section-title">üìù Notes (optional)</p>
            <div class="field">
              <label for="notes" class="help" style="font-weight:700;color:rgba(15,23,42,.88)">
                Anything we should know? (extra luggage, accessibility needs, etc.)
              </label>
              <textarea id="notes" name="notes" placeholder="Type details here‚Ä¶"></textarea>
            </div>
          </div>

          <div class="section">
            <p class="section-title">üíµ Estimated fare</p>
            <div class="fare" aria-live="polite">
              <div class="fare-row">
                <span>Base fare</span>
                <span id="baseFare">$5.89</span>
              </div>
              <div class="fare-row">
                <span id="distanceFare">Select pickup + drop-off from dropdown to calculate</span>
                <span></span>
              </div>
              <div class="fare-row total">
                <span><strong>Total</strong></span>
                <span><strong id="totalFare">$5.89</strong></span>
              </div>
              <div class="help">Driver receives 75% of fare. Final fare may adjust after route confirmation.</div>
            </div>
          </div>

          <div class="turnstile">
            <div class="cf-turnstile"
                 data-sitekey="0x4AAAAAACMebvxe_6kPGUnO"
                 data-callback="onTurnstileSuccess"></div>
          </div>

          <div class="actions">
            <button type="submit" class="btn" id="submitBtn" disabled>Request ride</button>
            <div id="statusMessage" class="msg"></div>
          </div>
        </form>
      </div>
    </div>

    <div class="footer-note">
      Built for travelers who move different. Airport rides only. Reliability > chaos.
    </div>
  </div>

  <script>
    // ===============================
    // CONFIG
    // ===============================
    const WORKER_BASE = "https://api.travylway.com";
    const RIDER_TYPE = "GENERAL";

    // Must match worker calculateFare() for GENERAL
    const BASE_FARE = 5.89;
    const PER_MILE  = 1.50;

    // ===============================
    // STATE (dropdown-confirmed)
    // ===============================
    let pickupAutocomplete, dropoffAutocomplete;
    let turnstileToken = null;

    let pickupPlace = { ok:false, place_id:null, addr:"", lat:null, lng:null };
    let dropoffPlace = { ok:false, place_id:null, addr:"", lat:null, lng:null };

    let fareAmount = BASE_FARE;
    let distanceMiles = 0;
    let durationMinutes = 0;
    let fareCalculated = false;

    // ===============================
    // UI HELPERS
    // ===============================
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
    document.getElementById("timezoneInfo").textContent = `Enter pickup time in your local timezone (${tz})`;
    document.getElementById("pickupDate").setAttribute("min", new Date().toISOString().split("T")[0]);

    function setMapsStatus(state, text){
      const dot = document.getElementById("mapsDot");
      const label = document.getElementById("mapsStatusText");
      dot.classList.remove("ok","bad","warn");
      dot.classList.add(state);
      label.textContent = text;
    }

    function showMessage(message, type){
      const el = document.getElementById("statusMessage");
      el.textContent = message;
      el.className = "msg show " + (type === "success" ? "ok" : type === "warning" ? "warn" : "bad");
      el.style.display = "block";
      if (type === "success"){
        setTimeout(() => { el.className = "msg"; el.style.display="none"; }, 5000);
      }
    }

    function onTurnstileSuccess(token){
      turnstileToken = token;
      document.getElementById("submitBtn").disabled = false;
    }

    function preventExclamationMarks(input){
      const scrub = () => { if (input.value.includes("!")) input.value = input.value.replace(/!/g,""); };
      input.addEventListener("input", scrub);
      input.addEventListener("keydown", scrub);
      input.addEventListener("focus", scrub);
      setInterval(scrub, 150);
    }

    function resetFareUI(msg){
      fareAmount = BASE_FARE;
      distanceMiles = 0;
      durationMinutes = 0;
      fareCalculated = false;

      document.getElementById("baseFare").textContent = `$${BASE_FARE.toFixed(2)}`;
      document.getElementById("distanceFare").textContent = msg || "Select pickup + drop-off from dropdown to calculate";
      document.getElementById("totalFare").textContent = `$${BASE_FARE.toFixed(2)}`;
    }

    function clearPickupSelection(){
      pickupPlace = { ok:false, place_id:null, addr:"", lat:null, lng:null };
      resetFareUI("Select pickup + drop-off from dropdown to calculate");
    }
    function clearDropoffSelection(){
      dropoffPlace = { ok:false, place_id:null, addr:"", lat:null, lng:null };
      resetFareUI("Select pickup + drop-off from dropdown to calculate");
    }

    // ===============================
    // AUTOCOMPLETE (captures coords)
    // ===============================
    function initAutocomplete(){
      const pickupInput = document.getElementById("pickupAddress");
      const dropoffInput = document.getElementById("dropoffAddress");

      preventExclamationMarks(pickupInput);
      preventExclamationMarks(dropoffInput);

      // If user edits after selecting, clear selection (forces dropdown again)
      pickupInput.addEventListener("input", () => {
        if (pickupPlace.ok && pickupInput.value.trim() !== pickupPlace.addr) {
          clearPickupSelection();
        }
      });
      dropoffInput.addEventListener("input", () => {
        if (dropoffPlace.ok && dropoffInput.value.trim() !== dropoffPlace.addr) {
          clearDropoffSelection();
        }
      });

      try{
        pickupAutocomplete = new google.maps.places.Autocomplete(pickupInput, {
          fields: ["place_id","formatted_address","geometry","name"]
        });
        dropoffAutocomplete = new google.maps.places.Autocomplete(dropoffInput, {
          fields: ["place_id","formatted_address","geometry","name"]
        });

        pickupAutocomplete.addListener("place_changed", () => {
          const place = pickupAutocomplete.getPlace();
          if (!place || !place.place_id || !place.geometry || !place.geometry.location) {
            clearPickupSelection();
            return;
          }
          const addr = place.formatted_address || place.name || pickupInput.value.trim();
          pickupInput.value = addr;

          pickupPlace = {
            ok: true,
            place_id: place.place_id,
            addr,
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
          calculateFare();
        });

        dropoffAutocomplete.addListener("place_changed", () => {
          const place = dropoffAutocomplete.getPlace();
          if (!place || !place.place_id || !place.geometry || !place.geometry.location) {
            clearDropoffSelection();
            return;
          }
          const addr = place.formatted_address || place.name || dropoffInput.value.trim();
          dropoffInput.value = addr;

          dropoffPlace = {
            ok: true,
            place_id: place.place_id,
            addr,
            lat: place.geometry.location.lat(),
            lng: place.geometry.location.lng()
          };
          calculateFare();
        });

        setMapsStatus("ok","Maps status: ready");
      } catch (e){
        console.error(e);
        setMapsStatus("bad","Maps status: failed");
      }
    }

    function waitForGoogleMaps(){
      if (typeof google !== "undefined" && google.maps && google.maps.places){
        initAutocomplete();
      } else {
        setMapsStatus("warn","Maps status: loading‚Ä¶");
        setTimeout(waitForGoogleMaps, 120);
      }
    }

    if (document.readyState === "loading"){
      document.addEventListener("DOMContentLoaded", waitForGoogleMaps);
    } else {
      waitForGoogleMaps();
    }

    // ===============================
    // FARE CALC (uses lat,lng)
    // ===============================
    async function calculateFare(){
      if (!pickupPlace.ok || !dropoffPlace.ok){
        resetFareUI("Select pickup + drop-off from dropdown to calculate");
        return;
      }

      try{
        // Most reliable input to Distance Matrix: coordinates
        const origins = `${pickupPlace.lat},${pickupPlace.lng}`;
        const destinations = `${dropoffPlace.lat},${dropoffPlace.lng}`;

        const proxyUrl =
          `${WORKER_BASE}/api/maps-distance` +
          `?origins=${encodeURIComponent(origins)}` +
          `&destinations=${encodeURIComponent(destinations)}` +
          `&mode=driving&units=imperial` +
          `&rider_type=${encodeURIComponent(RIDER_TYPE)}`;

        const res = await fetch(proxyUrl);
        const data = await res.json();

        if (data.status === "OK" && data.fare){
          fareAmount = Number(data.fare.total || BASE_FARE);
          distanceMiles = Number(data.distance?.miles || 0);
          durationMinutes = Number(data.duration?.minutes || 0);
          fareCalculated = true;

          const base = Number(data.fare.baseFare ?? BASE_FARE);
          const per = Number(data.fare.perMile ?? PER_MILE);
          const distCost = Number(data.fare.distanceCost ?? (distanceMiles * per));

          document.getElementById("baseFare").textContent = `$${base.toFixed(2)}`;
          document.getElementById("distanceFare").textContent =
            `${distanceMiles.toFixed(1)} miles √ó $${per.toFixed(2)}/mile = $${distCost.toFixed(2)}`;
          document.getElementById("totalFare").textContent = `$${fareAmount.toFixed(2)}`;
        } else {
          console.warn("Distance calc failed:", data);
          fareCalculated = false;
          resetFareUI("Unable to calculate distance. Re-select both addresses from dropdown.");
        }
      } catch (err){
        console.error(err);
        fareCalculated = false;
        resetFareUI("Error calculating distance. Re-select both addresses from dropdown.");
      }
    }

    async function validateAndCalculateFare(){
      const pickupText = (document.getElementById("pickupAddress").value || "").trim();
      const dropoffText = (document.getElementById("dropoffAddress").value || "").trim();

      if (!pickupText || !dropoffText){
        showMessage("Please enter both pickup and drop-off addresses.", "error");
        return false;
      }

      // Hard requirement: dropdown confirmed selections
      if (!pickupPlace.ok || !dropoffPlace.ok){
        showMessage("Could not calculate fare. Pick BOTH addresses from the dropdown suggestions.", "error");
        return false;
      }

      if (!fareCalculated){
        await calculateFare();
      }

      if (!fareCalculated){
        showMessage("Could not calculate fare. Re-select both addresses from dropdown and try again.", "error");
        return false;
      }

      return true;
    }

    // ===============================
    // SUBMIT
    // ===============================
    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!turnstileToken){
        showMessage("Please complete the security verification.", "error");
        return;
      }

      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "Submitting‚Ä¶";

      const ok = await validateAndCalculateFare();
      if (!ok){
        btn.disabled = false;
        btn.textContent = "Request ride";
        return;
      }

      const name = (document.getElementById("passengerName").value || "").trim();
      const phone = (document.getElementById("phoneNumber").value || "").trim();
      const pickupAddr = (document.getElementById("pickupAddress").value || "").replace(/!/g,"").trim();
      const dropoffAddr = (document.getElementById("dropoffAddress").value || "").replace(/!/g,"").trim();
      const pickupDate = document.getElementById("pickupDate").value;
      const pickupTime = document.getElementById("pickupTime").value;

      if (!name || !phone || !pickupAddr || !dropoffAddr || !pickupDate || !pickupTime){
        showMessage("Missing required fields. Please fill everything marked with *.", "error");
        btn.disabled = false;
        btn.textContent = "Request ride";
        return;
      }

      // Convert local date+time to UTC ISO
      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const pickupDateTime = new Date(`${pickupDate}T${pickupTime}`);
      const pickupTimeUTC = pickupDateTime.toISOString();

      // IMPORTANT: include BOTH address text + confirmed coords (best of both worlds)
      const tripData = {
        created_by: name,
        rider_phone: phone,
        rider_type: RIDER_TYPE,
        trip_type: "AIRPORT",
        pickup_text: pickupAddr,
        dropoff_text: dropoffAddr,
        pickup_time_utc: pickupTimeUTC,
        pickup_timezone: timezone,

        // Optional
        airport_code: "",
        flight_number: (document.getElementById("flightNumber").value || "").trim(),
        airline: (document.getElementById("airline").value || "").trim(),
        notes: (document.getElementById("notes").value || "").trim(),

        // Fare inputs worker expects
        estimated_fare: Number(fareAmount),
        distance_miles: Number(distanceMiles),
        duration_minutes: Number(durationMinutes),

        // Extra reliability data (doesn't break worker)
        pickup_place_id: pickupPlace.place_id,
        dropoff_place_id: dropoffPlace.place_id,
        pickup_lat: pickupPlace.lat,
        pickup_lng: pickupPlace.lng,
        dropoff_lat: dropoffPlace.lat,
        dropoff_lng: dropoffPlace.lng
      };

      try{
        const res = await fetch(`${WORKER_BASE}/api/trips`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(tripData)
        });

        const result = await res.json();

        if (result.ok){
          showMessage("Ride request submitted. You‚Äôll get a WhatsApp confirmation shortly.", "success");

          // Reset form fields
          document.getElementById("bookingForm").reset();
          document.getElementById("pickupAddress").value = "";
          document.getElementById("dropoffAddress").value = "";

          // Clear dropdown selections so next ride must re-select (prevents stale coords)
          clearPickupSelection();
          clearDropoffSelection();

          // Reset Turnstile
          turnstileToken = null;
          if (typeof turnstile !== "undefined") turnstile.reset();
          btn.disabled = true; // requires new Turnstile
        } else {
          const extra = result.message ? `\n${result.message}` : "";
          showMessage(`Request failed: ${result.error || "Unknown error"}${extra}`, "error");
        }
      } catch (err){
        console.error(err);
        showMessage("Network error. Check your connection and try again.", "error");
      } finally {
        btn.disabled = false;
        btn.textContent = "Request ride";
      }
    });

    // Start with base fare UI
    document.addEventListener("DOMContentLoaded", () => resetFareUI());
  </script>
</body>
</html>

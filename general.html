<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>General Transportation ‚Äî Travylway</title>
<meta name="description" content="Point-to-point transportation service with Travylway.">

<style>
:root{
  --bg:#2B3A4A; --card:#fff; --text:#0F172A; --muted:#64748B; --line:#E2E8F0;
  --okbg:#ECFDF5; --okbd:#BBF7D0; --oktx:#166534;
  --erbg:#FFF1F2; --erbd:#FECDD3; --ertx:#9F1239;
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#E5E7EB;padding:28px 14px}
.container{max-width:760px;margin:0 auto}
.card{background:var(--card);color:var(--text);border-radius:22px;padding:26px;box-shadow:0 22px 70px rgba(0,0,0,.28)}
.header{text-align:center;margin-bottom:18px}
.header h1{margin:0 0 6px;font-size:1.85rem}
.header p{margin:0;color:var(--muted)}
.note{background:#E8F5E9;border-left:4px solid #25D366;padding:12px 14px;border-radius:12px;margin:16px 0 18px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:720px){.grid{grid-template-columns:1fr}}
.group{margin:0 0 14px}
label{display:block;font-weight:800;margin:0 0 6px}
input,select,textarea{width:100%;padding:12px;border:2px solid var(--line);border-radius:12px;font-size:1rem}
input:focus,select:focus,textarea:focus{outline:none;border-color:#667eea}
textarea{min-height:90px}
.req{color:#ef4444;font-weight:900}
.btn{display:block;text-align:center;text-decoration:none;width:100%;padding:14px;border-radius:14px;border:0;font-weight:900;cursor:pointer}
.btn.primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
.btn.secondary{background:#fff;border:1px solid var(--line);color:#111}
.msg{display:none;padding:12px;border-radius:12px;margin-bottom:12px;font-weight:800;text-align:center}
.msg.ok{display:block;background:var(--okbg);border:1px solid var(--okbd);color:var(--oktx)}
.msg.err{display:block;background:var(--erbg);border:1px solid var(--erbd);color:var(--ertx);white-space:pre-wrap}
.price-estimate{display:none;background:#E3F2FD;border-left:4px solid #2196F3;padding:14px;border-radius:12px}
.price-details{display:flex;justify-content:space-between;font-weight:900}
.pac-container{z-index:99999!important}
.small{color:var(--muted);font-size:.9rem;margin-top:6px}
.timezone{color:#2196f3;font-weight:700;font-size:.85rem;margin-top:6px;display:block}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h1>üöó General Transportation</h1>
      <p>Point-to-point rides ¬∑ Simple request</p>
    </div>

    <div id="ok" class="msg ok"></div>
    <div id="err" class="msg err"></div>

    <div class="note">
      Driver will contact you via <strong>WhatsApp</strong> once your trip is claimed.
      <div class="small">If Google Maps is down, use WhatsApp Backup below.</div>
    </div>

    <form id="generalForm">
      <div class="group">
        <label>Name <span class="req">*</span></label>
        <input id="name" required>
      </div>

      <div class="grid">
        <div class="group">
          <label>Phone <span class="req">*</span></label>
          <input id="phone" required>
        </div>
        <div class="group">
          <label>Email (optional)</label>
          <input id="email">
        </div>
      </div>

      <div class="group">
        <label>Pickup Address <span class="req">*</span></label>
        <input id="pickupAddress" placeholder="Start typing address‚Ä¶" required>
        <div class="small" id="mapsStatus">Maps: loading‚Ä¶</div>
      </div>

      <div class="group">
        <label>Destination Address <span class="req">*</span></label>
        <input id="dropoffAddress" placeholder="Start typing address‚Ä¶" required>
      </div>

      <div class="grid">
        <div class="group">
          <label>Date <span class="req">*</span></label>
          <input id="date" type="date" required>
        </div>
        <div class="group">
          <label>Time <span class="req">*</span></label>
          <input id="time" type="time" required>
          <span class="timezone">üïê Mountain Time (Denver/Aurora)</span>
        </div>
      </div>

      <div class="group">
        <label>Notes (optional)</label>
        <textarea id="notes"></textarea>
      </div>

      <div id="priceEstimate" class="price-estimate">
        <div class="price-details">
          <span id="distanceDisplay"></span>
          <span id="priceDisplay"></span>
        </div>
        <div class="small">Estimate shown before approval.</div>
      </div>

      <!-- Turnstile -->
      <div class="group">
        <div class="cf-turnstile" data-sitekey="0x4AAAAAACMebvxe_6kPGUnO"></div>
        <div class="small">Spam protection enabled.</div>
      </div>

      <button class="btn primary" id="submitBtn" type="submit">Submit Request</button>

      <div style="margin-top:12px">
        <a id="waBackupBtn" class="btn secondary" target="_blank" rel="noopener">
          Send via WhatsApp (Backup)
        </a>
      </div>
    </form>

    <a class="small" href="/" style="display:inline-block;margin-top:14px;text-decoration:none;color:#667eea;font-weight:800;">‚Üê Back to Home</a>
  </div>
</div>

<!-- Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<script>
/* CONFIG */
const API_BASE = "https://travylway-api.benterpryzes2084.workers.dev";
const WHATSAPP_NUMBER = "17204748851";
const GOOGLE_KEY = "AIzaSyBQPVMR-qUW_uDz8TGazVXFP5J8ZEEkEyo";

/* GENERAL pricing (adjust if needed) */
const BASE=5.49, PER=1.75, FREE=0, MIN=10, MAX=100;

const el=id=>document.getElementById(id);
let pickupLoc=null, dropLoc=null;

function showOk(msg){ el("ok").textContent=msg; el("ok").style.display="block"; el("err").style.display="none"; }
function showErr(msg){ el("err").textContent=msg; el("err").style.display="block"; el("ok").style.display="none"; }

function formatMountainTime(dateStr, timeStr) {
  const dt = new Date(`${dateStr}T${timeStr}:00`);
  return dt.toLocaleString('en-US', {
    timeZone: 'America/Denver',
    month: 'short', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit', hour12: true
  }) + ' MT';
}

/* WhatsApp backup builder */
function buildWhatsApp(){
  const dateVal = el("date").value || "";
  const timeVal = el("time").value || "";
  const displayTime = (dateVal && timeVal) ? formatMountainTime(dateVal, timeVal) : `${dateVal} ${timeVal}`;

  const msg=[
    "üöñ Travylway General Ride Request",
    `Name: ${el("name").value || ""}`,
    `Phone: ${el("phone").value || ""}`,
    `Pickup: ${el("pickupAddress").value || ""}`,
    `Destination: ${el("dropoffAddress").value || ""}`,
    `Date/Time: ${displayTime}`,
    `Notes: ${el("notes").value || ""}`
  ].join("\n");

  el("waBackupBtn").href = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
}
document.addEventListener("input", buildWhatsApp, true);
document.addEventListener("change", buildWhatsApp, true);

/* Load Google */
function loadGoogle(){
  return new Promise((resolve, reject) => {
    if (window.google && google.maps && google.maps.places) return resolve();
    const s = document.createElement("script");
    s.src = `https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(GOOGLE_KEY)}&libraries=places`;
    s.async = true; s.defer = true;
    s.onload = () => resolve();
    s.onerror = () => reject(new Error("Google Maps script failed to load"));
    document.head.appendChild(s);
  });
}

function calculatePrice(){
  if(!pickupLoc || !dropLoc) return;
  const svc = new google.maps.DistanceMatrixService();
  svc.getDistanceMatrix({
    origins:[pickupLoc],
    destinations:[dropLoc],
    travelMode:"DRIVING",
    unitSystem:google.maps.UnitSystem.IMPERIAL
  }, (r,s)=>{
    if(s!=="OK") return;
    const elem = r?.rows?.[0]?.elements?.[0];
    if (!elem || elem.status !== "OK") return;

    const miles = elem.distance.value/1609.34;
    let price = BASE + Math.max(0, miles-FREE)*PER;
    price = Math.max(MIN, Math.min(MAX, price));
    el("distanceDisplay").textContent = `${miles.toFixed(1)} mi`;
    el("priceDisplay").textContent = `$${price.toFixed(0)}`;
    el("priceEstimate").style.display = "block";
  });
}

function initAutocomplete(){
  const ac1 = new google.maps.places.Autocomplete(el("pickupAddress"), { types:["address"] });
  ac1.addListener("place_changed", ()=>{
    const p = ac1.getPlace();
    pickupLoc = p.geometry?.location || null;
    calculatePrice();
  });

  const ac2 = new google.maps.places.Autocomplete(el("dropoffAddress"), { types:["address"] });
  ac2.addListener("place_changed", ()=>{
    const p = ac2.getPlace();
    dropLoc = p.geometry?.location || null;
    calculatePrice();
  });

  el("mapsStatus").textContent = "Maps: ready ‚úÖ";
}

/* Submit */
el("generalForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  el("ok").style.display="none";
  el("err").style.display="none";

  const btn = el("submitBtn");
  btn.disabled=true;
  btn.textContent="Submitting‚Ä¶";

  try{
    const ts = document.querySelector('input[name="cf-turnstile-response"]')?.value || "";
    if (!ts) throw new Error("Turnstile not ready. Wait 10 seconds and submit again.");

    const dateVal = el("date").value;
    const timeVal = el("time").value;
    const localDateTime = `${dateVal}T${timeVal}:00`;
    const pickup_time_utc = new Date(localDateTime).toISOString();
    const pickup_time_display = formatMountainTime(dateVal, timeVal);

    const payload = {
      created_by: (el("email").value || el("phone").value || "").trim(),
      rider_phone: el("phone").value.trim(),
      rider_type: "GENERAL",
      trip_type: "POINT_TO_POINT",

      direction: null,
      airport_code: null,

      pickup_text: el("pickupAddress").value.trim(),
      dropoff_text: el("dropoffAddress").value.trim(),
      pickup_time_utc,
      pickup_time_local: localDateTime,
      pickup_time_display,

      flight_number: null,
      airline: null,

      notes: [
        `Name: ${el("name").value.trim()}`,
        `Phone: ${el("phone").value.trim()}`,
        el("notes").value.trim() ? `Notes: ${el("notes").value.trim()}` : null
      ].filter(Boolean).join(" ‚Ä¢ "),

      "cf-turnstile-response": ts
    };

    const res = await fetch(`${API_BASE}/api/trips`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=> ({}));
    if (!res.ok || data.ok === false) throw new Error(data.error || `API error (HTTP ${res.status})`);

    showOk(`Submitted ‚úÖ Request ID: ${data.id || "OK"}`);

    el("generalForm").reset();
    pickupLoc=null; dropLoc=null;
    el("priceEstimate").style.display="none";
    buildWhatsApp();
    if (window.turnstile) { try { window.turnstile.reset(); } catch {} }

  }catch(err){
    showErr(`Not submitted:\n${err.message}\n\nUse the WhatsApp Backup button below if needed.`);
    if (window.turnstile) { try { window.turnstile.reset(); } catch {} }
  }finally{
    btn.disabled=false;
    btn.textContent="Submit Request";
  }
});

/* Boot */
buildWhatsApp();
loadGoogle()
  .then(()=>initAutocomplete())
  .catch((e)=>{
    el("mapsStatus").textContent = "Maps: failed ‚ùå (use WhatsApp Backup)";
    console.error(e);
  });
</script>

</body>
</html>

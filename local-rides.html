<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local Rides - TravylWay</title>

  <!-- Mapbox GL JS -->
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
  
  <!-- Mapbox Geocoding -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

    body{
      background: linear-gradient(135deg,#10b981 0%,#059669 100%);
      min-height:100vh;
      padding:20px;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .container{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:16px;
      padding:28px;
      box-shadow:0 10px 40px rgba(0,0,0,.22);
    }

    .badge{
      background: linear-gradient(135deg,#10b981 0%,#059669 100%);
      color:#fff;
      padding:10px 18px;
      border-radius:999px;
      text-align:center;
      font-weight:800;
      margin-bottom:14px;
      letter-spacing:.2px;
    }

    h1{
      text-align:center;
      color:#222;
      margin-bottom:8px;
      font-size:28px;
    }

    .subhead{
      text-align:center;
      color:#555;
      margin-bottom:22px;
      font-size:14px;
      line-height:1.35;
    }

    .alert-box{
      background:#fef2f2;
      border-left:4px solid #dc2626;
      padding:12px 14px;
      border-radius:8px;
      margin:16px 0;
      color:#991b1b;
      font-size:14px;
      line-height:1.5;
    }

    .form-group{ margin-bottom:16px; position:relative; }

    label{
      display:block;
      font-weight:650;
      margin-bottom:6px;
      color:#222;
      font-size:14px;
    }

    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:16px;
      transition: border-color .15s ease;
    }

    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:#10b981;
    }

    textarea{ min-height:84px; resize:vertical; }

    .hint{
      margin-top:6px;
      font-size:12px;
      color:#666;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }

    .btn{
      width:100%;
      padding:15px;
      background: linear-gradient(135deg,#10b981 0%,#059669 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:18px;
      font-weight:700;
      cursor:pointer;
      margin-top:10px;
      transition: transform .2s ease, box-shadow .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    .btn:hover:not(:disabled){
      transform: translateY(-2px);
      box-shadow:0 8px 18px rgba(0,0,0,.18);
    }

    .btn:disabled{ background:#cfcfcf; cursor:not-allowed; }

    .btn.secondary{
      background:#111827;
      font-size:16px;
      padding:12px;
      margin-top:0;
    }

    .quote-box{
      margin-top:10px;
      padding:14px;
      border:2px solid #e5e7eb;
      border-radius:12px;
      background:#f9fafb;
      display:none;
    }

    .quote-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:14px;
      color:#222;
      margin-top:6px;
    }

    .quote-row:first-child{ margin-top:0; }
    .quote-row strong{ font-size:16px; color:#10b981; }

    .message{
      padding:14px;
      border-radius:10px;
      margin-top:14px;
      text-align:center;
      display:none;
      font-size:14px;
      line-height:1.35;
    }

    .success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb; display:block; }
    .error{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; display:block; }

    .loading{
      display:inline-block;
      width:18px;
      height:18px;
      border:3px solid rgba(255,255,255,.35);
      border-radius:50%;
      border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .hp{
      position:absolute !important;
      left:-9999px !important;
      width:1px; height:1px;
      overflow:hidden;
    }

    .footer-note{
      margin-top:16px;
      text-align:center;
      color:#666;
      font-size:12px;
    }

    .turnstile-wrapper{
      margin: 16px 0;
      display: flex;
      justify-content: center;
    }

    /* Map Container */
    #map{
      width:100%;
      height:350px;
      border-radius:12px;
      margin:16px 0;
      border:2px solid #e5e7eb;
    }

    .map-info{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:8px;
      padding:12px;
      margin-bottom:16px;
      font-size:13px;
      text-align:center;
      color:#666;
    }

    /* Mapbox Geocoder styling */
    .mapboxgl-ctrl-geocoder{
      width:100%;
      max-width:100%;
      box-shadow:none;
      border:2px solid #ddd;
      border-radius:10px;
      font-size:16px;
    }

    .mapboxgl-ctrl-geocoder input{
      padding:14px 16px;
      font-size:16px;
      height:auto;
      min-height:48px;
    }

    .mapboxgl-ctrl-geocoder--input:focus{
      outline:none;
      border-color:#10b981;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="badge">üèôÔ∏è LOCAL RIDES - CITY TRANSPORTATION</div>

    <h1>üèôÔ∏è Local Rides</h1>
    <div class="subhead">
      City-to-city transportation. Perfect for events, concerts, errands, and local travel.
    </div>

    <div class="alert-box">
      <strong>‚ö†Ô∏è NO AIRPORT RIDES</strong><br>
      This service is for city transportation only. Neither pickup nor dropoff can be an airport. For airport rides, use our Airport Service.
    </div>

    <form id="localForm" autocomplete="on">
      <div class="hp">
        <label>Website</label>
        <input type="text" id="website" tabindex="-1" autocomplete="off" />
      </div>

      <div class="form-group">
        <label>Your Name *</label>
        <input type="text" id="name" required placeholder="John Doe" maxlength="80" />
      </div>

      <div class="form-group">
        <label>Phone Number *</label>
        <input type="tel" id="phone" required placeholder="+1 (720) 555-1234" maxlength="24" />
        <div class="hint">Used for confirmation + driver coordination.</div>
      </div>

      <div class="form-group">
        <label>Pickup Address *</label>
        <div id="pickupGeocoder"></div>
        <div class="hint">Start typing to see suggestions (no airports)</div>
      </div>

      <div class="form-group">
        <label>Dropoff Address *</label>
        <div id="dropoffGeocoder"></div>
        <div class="hint">Start typing to see suggestions (no airports)</div>
      </div>

      <!-- Map -->
      <div class="map-info" id="mapInfo">
        üìç Select pickup and dropoff addresses above to see route on map
      </div>
      <div id="map"></div>

      <div class="grid">
        <div class="form-group">
          <label>Pickup Date *</label>
          <input type="date" id="date" required />
        </div>

        <div class="form-group">
          <label>Pickup Time (local) *</label>
          <input type="time" id="time" required />
        </div>
      </div>

      <div class="form-group">
        <label>Notes (optional)</label>
        <textarea id="notes" placeholder="Special requests, event details, luggage count, etc..."></textarea>
      </div>

      <div class="form-group">
        <button type="button" class="btn secondary" id="quoteBtn">
          <span id="quoteText">Calculate Fare</span>
          <span class="loading" id="quoteSpinner" style="display:none;"></span>
        </button>

        <div id="quoteBox" class="quote-box">
          <div class="quote-row"><span>Distance</span><span id="quoteMiles">‚Äî</span></div>
          <div class="quote-row"><span>Duration</span><span id="quoteMinutes">‚Äî</span></div>
          <div class="quote-row"><strong>Estimated Total</strong><strong id="quoteTotal">‚Äî</strong></div>
          <div class="hint" style="margin-top:8px;">Premium local rates. Estimate only - final fare confirmed after route/traffic.</div>
        </div>
      </div>

      <!-- Turnstile Widget -->
      <div class="turnstile-wrapper">
        <div class="cf-turnstile" 
             data-sitekey="0x4AAAAAACMebvxe_6kPGUnO"
             data-callback="onTurnstileSuccess"
             data-expired-callback="onTurnstileExpired"
             data-error-callback="onTurnstileError">
        </div>
      </div>

      <button type="submit" class="btn" id="submitBtn">
        <span id="submitText">Submit Local Ride Booking</span>
        <span class="loading" id="loadingSpinner" style="display:none;"></span>
      </button>
    </form>

    <div id="message" class="message"></div>

    <div class="footer-note">
      Local rides only. No airport pickups or dropoffs. Premium rates apply.
    </div>
  </div>

  <script>
    const CLOUDFLARE_WORKER_URL = 'https://api.travylway.com';
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiYnByeXplczIwODQiLCJhIjoiY21sbmtkOXRwMGZwdTNlcTNlbDZjcXNsOCJ9.MA-V_fUeihAhAm28Brnojg';

    mapboxgl.accessToken = MAPBOX_TOKEN;

    const form = document.getElementById('localForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const messageDiv = document.getElementById('message');

    const phoneEl = document.getElementById('phone');
    const dateEl = document.getElementById('date');
    const timeEl = document.getElementById('time');

    const quoteBtn = document.getElementById('quoteBtn');
    const quoteText = document.getElementById('quoteText');
    const quoteSpinner = document.getElementById('quoteSpinner');
    const quoteBox = document.getElementById('quoteBox');
    const quoteMilesEl = document.getElementById('quoteMiles');
    const quoteMinutesEl = document.getElementById('quoteMinutes');
    const quoteTotalEl = document.getElementById('quoteTotal');

    let latestEstimatedFare = 0;
    let turnstileToken = null;
    let pickupAddress = '';
    let dropoffAddress = '';
    let pickupCoords = null;
    let dropoffCoords = null;

    // Initialize Map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-98.5795, 39.8283],
      zoom: 3
    });

    let pickupMarker = null;
    let dropoffMarker = null;

    // Turnstile callbacks
    window.onTurnstileSuccess = function(token) {
      turnstileToken = token;
      console.log('‚úÖ Turnstile verification successful');
    };

    window.onTurnstileExpired = function() {
      turnstileToken = null;
      console.warn('‚ö†Ô∏è Turnstile token expired');
    };

    window.onTurnstileError = function() {
      turnstileToken = null;
      console.error('‚ùå Turnstile verification error');
      showMessage('error', '‚ùå Security verification failed. Please refresh the page.');
    };

    // Initialize Mapbox Geocoders
    const pickupGeocoder = new MapboxGeocoder({
      accessToken: MAPBOX_TOKEN,
      placeholder: 'Start typing address...',
      mapboxgl: mapboxgl
    });

    const dropoffGeocoder = new MapboxGeocoder({
      accessToken: MAPBOX_TOKEN,
      placeholder: 'Start typing address...',
      mapboxgl: mapboxgl
    });

    pickupGeocoder.addTo('#pickupGeocoder');
    dropoffGeocoder.addTo('#dropoffGeocoder');

    // Pickup address selected
    pickupGeocoder.on('result', function(e) {
      pickupAddress = e.result.place_name;
      pickupCoords = e.result.geometry.coordinates;
      
      if (pickupMarker) pickupMarker.remove();
      pickupMarker = new mapboxgl.Marker({color: '#10b981'})
        .setLngLat(pickupCoords)
        .addTo(map);
      
      updateMap();
      updateMapInfo();
      quoteBox.style.display = 'none';
      latestEstimatedFare = 0;
    });

    // Dropoff address selected
    dropoffGeocoder.on('result', function(e) {
      dropoffAddress = e.result.place_name;
      dropoffCoords = e.result.geometry.coordinates;
      
      if (dropoffMarker) dropoffMarker.remove();
      dropoffMarker = new mapboxgl.Marker({color: '#ef4444'})
        .setLngLat(dropoffCoords)
        .addTo(map);
      
      updateMap();
      updateMapInfo();
      quoteBox.style.display = 'none';
      latestEstimatedFare = 0;
    });

    async function updateMap() {
      if (!pickupCoords || !dropoffCoords) return;

      const bounds = new mapboxgl.LngLatBounds();
      bounds.extend(pickupCoords);
      bounds.extend(dropoffCoords);
      map.fitBounds(bounds, {padding: 50});

      try {
        const directionsUrl = `https://api.mapbox.com/directions/v5/mapbox/driving/${pickupCoords[0]},${pickupCoords[1]};${dropoffCoords[0]},${dropoffCoords[1]}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;
        
        const response = await fetch(directionsUrl);
        const data = await response.json();
        
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0].geometry;
          
          if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          
          map.addSource('route', {
            type: 'geojson',
            data: {
              type: 'Feature',
              geometry: route
            }
          });
          
          map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: {
              'line-join': 'round',
              'line-cap': 'round'
            },
            paint: {
              'line-color': '#10b981',
              'line-width': 4
            }
          });
        }
      } catch (e) {
        console.error('Failed to load route:', e);
      }
    }

    function updateMapInfo() {
      if (pickupCoords && dropoffCoords) {
        document.getElementById('mapInfo').innerHTML = 'üó∫Ô∏è Route displayed: <span style="color:#10b981;">‚óè</span> Pickup ‚Üí <span style="color:#ef4444;">‚óè</span> Dropoff';
      } else if (pickupCoords) {
        document.getElementById('mapInfo').textContent = 'üìç Pickup location set. Add dropoff to see route.';
      } else if (dropoffCoords) {
        document.getElementById('mapInfo').textContent = 'üìç Dropoff location set. Add pickup to see route.';
      }
    }

    function showMessage(type, text) {
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      messageDiv.style.display = 'block';
    }

    function toUtcIsoFromLocalDateAndTime(dateStr, timeStr) {
      const [y, m, d] = dateStr.split('-').map(Number);
      const [hh, min] = timeStr.split(':').map(Number);
      const localDate = new Date(y, (m - 1), d, hh, min, 0);
      return localDate.toISOString();
    }

    function getLocalYMD() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function setMinDateToToday() {
      const today = getLocalYMD();
      dateEl.min = today;
      if (!dateEl.value || dateEl.value < today) {
        dateEl.value = today;
      }
    }

    setMinDateToToday();
    dateEl.addEventListener("change", setMinDateToToday);

    phoneEl.addEventListener('input', function() {
      this.value = this.value.replace(/[^\d+()\s-]/g, '');
    });

    // Calculate Fare
    quoteBtn.addEventListener('click', async () => {
      if (!pickupAddress || !dropoffAddress) {
        showMessage('error', '‚ùå Please select both pickup and dropoff addresses to calculate fare.');
        return;
      }

      quoteBtn.disabled = true;
      quoteText.style.display = 'none';
      quoteSpinner.style.display = 'inline-block';
      messageDiv.style.display = 'none';

      try {
        const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/quote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pickup_text: pickupAddress,
            dropoff_text: dropoffAddress,
            pickup_coords: pickupCoords,
            dropoff_coords: dropoffCoords,
            rider_type: 'LOCAL'
          })
        });

        const data = await res.json();
        console.log('Quote response:', data);

        if (res.ok && data.ok) {
          const miles = data.miles || 0;
          const minutes = data.minutes || 0;
          const total = data.estimate?.total || 0;

          latestEstimatedFare = total;

          quoteMilesEl.textContent = `${miles.toFixed(1)} mi`;
          quoteMinutesEl.textContent = `${Math.round(minutes)} min`;
          quoteTotalEl.textContent = `$${total.toFixed(2)}`;

          quoteBox.style.display = 'block';
        } else {
          throw new Error(data.error || 'Failed to calculate fare');
        }
      } catch (err) {
        showMessage('error', `‚ùå Fare calculation error: ${err.message}`);
        quoteBox.style.display = 'none';
      } finally {
        quoteBtn.disabled = false;
        quoteText.style.display = 'inline';
        quoteSpinner.style.display = 'none';
      }
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const hp = document.getElementById('website').value.trim();
      if (hp) {
        showMessage('error', '‚ùå Submission blocked.');
        return;
      }

      if (!turnstileToken) {
        showMessage('error', '‚ùå Please complete the security verification (checkbox above).');
        return;
      }

      if (!pickupAddress || !dropoffAddress) {
        showMessage('error', '‚ùå Both pickup and dropoff addresses are required.');
        return;
      }

      const dateVal = dateEl.value;
      const timeVal = timeEl.value;
      if (!dateVal || !timeVal) {
        showMessage('error', '‚ùå Pickup date and time are required.');
        return;
      }

      submitBtn.disabled = true;
      submitText.style.display = 'none';
      loadingSpinner.style.display = 'inline-block';
      messageDiv.style.display = 'none';

      const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const pickupTimeUTC = toUtcIsoFromLocalDateAndTime(dateVal, timeVal);

      const payload = {
        created_by: document.getElementById('name').value.trim(),
        rider_phone: phoneEl.value.trim(),
        rider_type: 'LOCAL',
        service_type: 'LOCAL',
        pickup_text: pickupAddress,
        dropoff_text: dropoffAddress,
        pickup_time_utc: pickupTimeUTC,
        pickup_timezone: timezone,
        flight_number: '',
        airline: '',
        airport_code: '',
        notes: document.getElementById('notes').value.trim(),
        estimated_fare: latestEstimatedFare,
        'cf-turnstile-response': turnstileToken
      };

      console.log('Submitting:', JSON.stringify(payload, null, 2));

      try {
        const res = await fetch(`${CLOUDFLARE_WORKER_URL}/api/trips`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));
        console.log('Response:', data);

        if (res.ok && data?.ok) {
          const confirmationId = data?.trip_id || 'N/A';
          showMessage('success', `‚úÖ Local ride booking submitted! Confirmation ID: ${confirmationId}. You'll receive confirmation via Telegram.`);
          
          form.reset();
          const today = getLocalYMD();
          dateEl.min = today;
          dateEl.value = today;

          // Clear map
          if (pickupMarker) pickupMarker.remove();
          if (dropoffMarker) dropoffMarker.remove();
          if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          pickupAddress = '';
          dropoffAddress = '';
          pickupCoords = null;
          dropoffCoords = null;
          document.getElementById('mapInfo').textContent = 'üìç Select pickup and dropoff addresses above to see route on map';

          latestEstimatedFare = 0;
          quoteBox.style.display = 'none';
          turnstileToken = null;
          
          if (window.turnstile) {
            window.turnstile.reset();
          }
          
          pickupGeocoder.clear();
          dropoffGeocoder.clear();
          
        } else {
          const msg = data?.error || data?.message || `HTTP ${res.status}: ${res.statusText}`;
          
          // Check for airport rejection
          if (msg.includes('airport') || msg.includes('AIRPORT')) {
            throw new Error('Airport addresses are not allowed for local rides. Please use our Airport Service instead.');
          }
          
          throw new Error(msg);
        }
      } catch (err) {
        showMessage('error', `‚ùå Error: ${err.message}`);
      } finally {
        submitBtn.disabled = false;
        submitText.style.display = 'inline';
        loadingSpinner.style.display = 'none';
      }
    });
  </script>
</body>
</html>

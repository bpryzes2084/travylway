<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TravylWay – Book a Ride</title>

  <!-- Cloudflare Turnstile -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f6f7fb;
      color: #111827;
    }

    header {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 20px;
      text-align: center;
    }

    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
    }

    label {
      display: block;
      font-weight: 600;
      margin: 14px 0 6px;
    }

    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 15px;
    }

    textarea {
      min-height: 90px;
      resize: vertical;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    @media (max-width: 700px) {
      .row { grid-template-columns: 1fr; }
    }

    .turnstile-wrap {
      margin: 20px 0;
      display: flex;
      justify-content: center;
    }

    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      margin-top: 16px;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .msg {
      display: none;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .msg.success {
      display: block;
      background: #dcfce7;
      color: #14532d;
      border: 1px solid #86efac;
    }

    .msg.error {
      display: block;
      background: #fee2e2;
      color: #7f1d1d;
      border: 1px solid #fecaca;
    }
  </style>
</head>

<body>

<header>
  <h1>TravylWay – Book a Ride</h1>
  <p>Submit your request. Approval is handled by dispatch.</p>
</header>

<main>
  <div class="card">
    <div id="message" class="msg"></div>

    <form id="bookingForm">
      <div class="row">
        <div>
          <label>Your Name *</label>
          <input id="name" required />
        </div>

        <div>
          <label>Phone (WhatsApp) *</label>
          <input id="phone" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Rider Type *</label>
          <select id="riderType">
            <option value="GENERAL">General</option>
            <option value="CREW">Crew</option>
          </select>
        </div>

        <div>
          <label>Trip Type *</label>
          <select id="tripType">
            <option value="AIRPORT">Airport</option>
            <option value="POINT_TO_POINT">Point-to-Point</option>
          </select>
        </div>
      </div>

      <label>Pickup Location *</label>
      <input id="pickupText" required />

      <label>Dropoff Location *</label>
      <input id="dropoffText" required />

      <label>Pickup Date & Time *</label>
      <input id="pickupTime" type="datetime-local" required />

      <label>Notes (optional)</label>
      <textarea id="notes"></textarea>

      <!-- Turnstile -->
      <div class="turnstile-wrap">
        <div
          class="cf-turnstile"
          data-sitekey="0x4AAAAAACMebvxe_6kPGUnO"
          data-callback="onTurnstileVerified"
          data-expired-callback="onTurnstileExpired"
          data-error-callback="onTurnstileError">
        </div>
      </div>

      <button id="submitBtn" type="submit">Submit Ride Request</button>
    </form>
  </div>
</main>

<script>
/* =============================
   TURNSTILE HANDLING (CORRECT)
   ============================= */
let turnstileToken = "";

function onTurnstileVerified(token) {
  turnstileToken = token;
}

function onTurnstileExpired() {
  turnstileToken = "";
}

function onTurnstileError() {
  turnstileToken = "";
}

/* =============================
   FORM LOGIC
   ============================= */
const form = document.getElementById("bookingForm");
const msg = document.getElementById("message");
const btn = document.getElementById("submitBtn");

function showMsg(text, type) {
  msg.textContent = text;
  msg.className = "msg " + type;
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!turnstileToken) {
    showMsg("Please complete the security verification (Turnstile).", "error");
    return;
  }

  btn.disabled = true;
  btn.textContent = "Submitting…";

  const payload = {
    created_by: document.getElementById("name").value.trim(),
    rider_phone: document.getElementById("phone").value.trim(),
    rider_type: document.getElementById("riderType").value,
    trip_type: document.getElementById("tripType").value,
    pickup_text: document.getElementById("pickupText").value.trim(),
    dropoff_text: document.getElementById("dropoffText").value.trim(),
    pickup_time_utc: new Date(document.getElementById("pickupTime").value).toISOString(),
    notes: document.getElementById("notes").value.trim(),
    "cf-turnstile-response": turnstileToken
  };

  try {
    const res = await fetch("/api/trips", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (res.ok && data.ok) {
      showMsg("✅ Request submitted. Status: PENDING approval.", "success");
      form.reset();
    } else {
      showMsg(data.error || "Request failed.", "error");
    }
  } catch (err) {
    showMsg("Network error. Please try again.", "error");
  } finally {
    turnstileToken = "";
    if (typeof turnstile !== "undefined") turnstile.reset();
    btn.disabled = false;
    btn.textContent = "Submit Ride Request";
  }
});
</script>

</body>
</html>
